<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRUEBA (Global)</title>
    <link rel="icon" href="https://raw.githubusercontent.com/IALUMX/img_cepredix/main/00-WEBLogo-circular-cepredix.png" type="image/png">
    
    <meta property="og:image" content="https://raw.githubusercontent.com/IALUMX/img_cepredix/main/Thumbnail-CEP-HTML.png">
    <meta property="og:image:secure_url" content="https://raw.githubusercontent.com/IALUMX/img_cepredix/main/Thumbnail-CEP-HTML.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <meta property="og:title" content="PRUEBA (Global) - CEPREDIX">
    <meta property="og:description" content="Plataforma de evaluaci√≥n educativa.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: ['base', 'ams', 'physics']
            },
            svg: {
                fontCache: 'global'
            },
            loader: {load: ['[tex]/physics']}
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-image: url('https://i.imgur.com/7ndIyWP.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            padding: 15px;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); z-index: -1;
        }
        .container {
            width: 100%; max-width: 1200px; margin: 0 auto;
            display: flex; flex-direction: column;            
        }
        .header {
            text-align: center; padding: 15px; border-radius: 15px; margin-bottom: 20px;
            background: linear-gradient(45deg, #0d47a1, #00695c, #ff6f00, #b71c1c, #4a148c);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .logo {
            width: 100px; height: 100px; margin: 0 auto 10px;
            background: url('https://i.imgur.com/I1unSiu.png') center/contain no-repeat;
        }
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
            font-size: 1rem;
        }
        .logout-btn:hover {
            background: rgba(244, 67, 54, 0.8);
            border-color: #f44336;
            transform: scale(1.1);
        }
        .card {
            background: rgba(25, 25, 35, 0.85); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            width: 100%; margin-bottom: 20px; position: relative;
        }
        .btn {
            padding: 10px 20px; font-size: 1.1rem; border: none; border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); margin: 8px;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(45deg, #2196F3, #21CBF3); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #f44336, #ff9800); color: white; }
        .btn-hint { background: linear-gradient(45deg, #FFC107, #FF9800); color: white; }
        .btn-correct { background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; }
        .btn-incorrect { background: linear-gradient(45deg, #f44336, #ff5722); color: white; }
        .btn-disabled, .btn:disabled {
            background: #9e9e9e; cursor: not-allowed; transform: none !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
        }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .question-container {
            margin: 15px 0 20px; padding: 20px; background: rgba(30, 30, 40, 0.8);
            border-radius: 15px; border-left: 5px solid #4fc3f7; position: relative;
        }
        .question-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; justify-content: center; }
        .tag {
            background: rgba(79, 195, 247, 0.2); padding: 4px 10px; border-radius: 15px;
            font-size: 0.8rem; border: 1px solid #4fc3f7; cursor: pointer; transition: all 0.2s ease;
        }
        .tag.selected { background: rgba(79, 195, 247, 0.8); color: white; font-weight: bold; transform: scale(1.05); }
        .option-btn {
            padding: 15px 15px 15px 50px; background: rgba(50, 50, 70, 0.8);
            border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
            font-size: 1.1rem; border: 2px solid transparent; text-align: left;
            position: relative; width: 100%; margin-bottom: 12px; display: flex; align-items: center;
        }
        .option-btn:hover:not([disabled]) { background: rgba(70, 70, 90, 0.9); transform: translateY(-2px); }
        .option-btn.selected { filter: brightness(0.7); border-color: #ff9800; box-shadow: 0 0 0 2px #ff9800; }
        .option-btn.correct {
            background: linear-gradient(45deg, #4CAF50, #8BC34A) !important; color: white !important;
            transform: scale(1.01); box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);
        }
        .option-btn.incorrect {
            background: linear-gradient(45deg, #f44336, #ff5722) !important; color: white !important;
            animation: shake 0.5s;
        }
        .option-letter {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            width: 25px; height: 25px; background: rgba(79, 195, 247, 0.3);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 10px;
        }
        .justification {
            background: rgba(40, 40, 50, 0.9); border-radius: 10px; padding: 15px;
            margin-top: 20px; text-align: left; border-left: 4px solid #4fc3f7;
            overflow-x: auto; /* Agrega scroll horizontal si es necesario */
            word-wrap: break-word; /* Rompe palabras largas */
        }
        .justification h4 { color: #4fc3f7; margin-bottom: 8px; font-size: 1.2rem; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .timer-green { color: #4CAF50; }
        .timer-orange { color: #FF9800; }
        .timer-red { color: #f44336; }
        .results-container { background: rgba(30, 30, 40, 0.8); border-radius: 15px; padding: 20px; margin: 15px 0; }
        .result-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0; }
        .stat-box { background: rgba(50, 50, 70, 0.8); border-radius: 10px; padding: 15px; min-width: 160px; flex: 1; }
        .stat-box h3 { font-size: 1.1rem; margin-bottom: 8px; color: #4fc3f7; }
        .stat-box p { font-size: 1.5rem; font-weight: 700; }
        #result-image-container {
            width: 100%; max-width: 600px; margin: 1.5rem auto; display: flex;
            justify-content: center; align-items: center;
        }
        #result-image {
            max-width: 100%; height: auto; border-radius: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); object-fit: contain;
        }
        #image-container {
            position: relative; width: 100%; max-width: 100%; 
            height: 45vh; /* Usa el 45% de la altura de la pantalla del dispositivo */
            max-height: 500px; /* L√≠mite para que no sea gigante en PC */
            min-height: 250px; /* L√≠mite para que no sea muy chica en m√≥viles */
            background-size: contain; background-position: center; background-repeat: no-repeat;
            overflow: hidden; margin: 15px auto; border-radius: 10px;
            background-color: rgba(0,0,0,0.2); /* Fondo sutil para distinguir el √°rea */
        }
        #watermark-overlay {
            position: absolute; inset: -50%; width: 200%; height: 200%;
            color: rgba(255, 220, 220, 0.01); font-size: 1rem; font-weight: 600;
            pointer-events: none; display: flex; flex-wrap: wrap; align-items: center;
            justify-content: center; word-spacing: 1rem; animation: watermark-scroll 40s linear infinite;
        }
        @keyframes watermark-scroll {
            from { transform: rotate(-30deg) translate(0, 0); }
            to { transform: rotate(-30deg) translate(-25%, -25%); }
        }
        .question-id-tags {
            position: relative;
            margin: 10px auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: fit-content;
        }
        .question-id { color: #4fc3f7; }
        .mini-nav-btn {
            width: 32px; height: 32px; border-radius: 50%; 
            background: rgba(30, 30, 40, 0.8); border: 1px solid #4fc3f7; 
            color: #4fc3f7; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem;
        }
        .mini-nav-btn:hover:not(:disabled) {
            background: rgba(79, 195, 247, 0.3); transform: scale(1.1);
        }
        .mini-nav-btn:disabled {
            opacity: 0.3; cursor: not-allowed; border-color: #555; color: #777;
        }
        .uni-tag-display { color: #81c784; }
        .options-grid-mode {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        /* NUEVO ESTILO H√çBRIDO */
        .hybrid-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .hybrid-group {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        .hybrid-group-title {
            text-align: center;
            color: #4fc3f7;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: bold;
            text-transform: uppercase;
        }
        @media (min-width: 768px) {
            .hybrid-container {
                flex-direction: row;
            }
            .hybrid-group {
                flex: 1;
            }
        }
        .option-btn.is-image {
            padding: 5px !important;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .option-btn.is-image .option-letter {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .option-image-content {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }
        .option-btn.full-width {
            grid-column: span 2;
            height: auto !important;
            padding: 15px 15px 15px 50px !important;
        }
        .option-watermark {
            position: absolute;
            inset: -50%;
            width: 200%;
            height: 200%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            opacity: 0.15;
            pointer-events: none;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            white-space: pre-wrap;
            text-align: center;
            line-height: 2;
            z-index: 5;
            animation: watermark-scroll 40s linear infinite;
        }
        @media (max-width: 480px) {
            .option-btn.is-image { height: 150px; }
        }
        .level-tag-display { color: #ffd54f; }
        .video-link {
            color: #4fc3f7; font-style: italic; margin-left: 5px; text-decoration: underline;
        }
        .video-container { width: 100%; margin: 15px 0; }
        .video-toggle {
            background: rgba(79, 195, 247, 0.2); border: 1px solid #4fc3f7; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        .video-toggle:hover { background: rgba(79, 195, 247, 0.4); }
        .video-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
            padding: 15px; overflow: hidden;
        }
        .video-wrapper {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
        }
        .video-wrapper iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none; border-radius: 5px;
        }
        .volume-btn-new {
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid #6b7280;
            background: rgba(50, 50, 70, 0.8); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; font-weight: bold; transition: background 0.2s;
        }
        .volume-btn-new:hover { background: rgba(70, 70, 90, 0.9); }
        .volume-btn-new:active { transform: scale(0.95); }
        #chalkboard-section { width: 100%; margin: 20px 0; }
        #chalkboard-toggle {
            background: rgba(100, 181, 246, 0.2); border: 1px solid #64b5f6; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        #chalkboard-toggle:hover { background: rgba(100, 181, 246, 0.4); }
        #chalkboard-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
            padding: 15px; overflow: hidden;
        }
        #canvas-container {
            width: 100%; aspect-ratio: 4 / 3; background-size: cover; background-position: center;
            border-radius: 0.5rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3); overflow: hidden;
        }
        #chalkboard { display: block; width: 100%; height: 100%; }
        #chalkboard-controls {
            background: rgba(30, 30, 40, 0.9); padding: 10px; border-radius: 0.5rem;
            margin-top: 10px; width: 100%; display: flex; flex-wrap: wrap;
            align-items: center; justify-content: center; gap: 12px;
        }
        .control-btn.active { box-shadow: 0 0 0 3px #4a90e2; border-color: #4a90e2; }
        .color-picker-wrapper { position: relative; width: 36px; height: 36px; }
        .color-picker-wrapper input[type="color"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }
        .color-picker-wrapper .color-preview {
            width: 100%; height: 100%; border-radius: 0.375rem;
            border: 2px solid white; pointer-events: none;
        }
        .lookup-question-container {
            background: rgba(30, 30, 40, 0.9); border-radius: 15px; padding: 20px;
            margin: 15px 0; border-left: 5px solid #4fc3f7;
        }
        .lookup-option {
            padding: 12px 12px 12px 40px; background: rgba(50, 50, 70, 0.8);
            border-radius: 10px; margin-bottom: 10px; position: relative;
            border-left: 4px solid #4CAF50; 
        }
        .lookup-option.incorrect {
            border-left-color: #f44336; 
        }
        .lookup-option-label {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            width: 24px; height: 24px; background: rgba(79, 195, 247, 0.3);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }
        .lookup-correct-badge {
            background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white;
            padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;
            font-weight: bold; margin-left: 10px;
        }
        .lookup-section {
            background: rgba(40, 40, 50, 0.9); border-radius: 10px; padding: 15px;
            margin-top: 15px; border-left: 4px solid #4fc3f7;
        }
        .lookup-section-title {
            color: #4fc3f7; margin-bottom: 8px; font-size: 1.1rem;
        }
        .evaluate-emoji {
            display: inline-block;
            animation: emoji-animation 2s infinite;
        }
        @keyframes emoji-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        #advertisement-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 9999;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #advertisement-image {
            max-width: 90%; max-height: 70%;
            border-radius: 15px; box-shadow: 0 0 50px rgba(255, 152, 0, 0.5);
            animation: pulse-ad 1s infinite alternate;
        }
        @keyframes pulse-ad {
            from { transform: scale(0.95); box-shadow: 0 0 50px rgba(255, 152, 0, 0.5); }
            to { transform: scale(1); box-shadow: 0 0 100px rgba(255, 152, 0, 0.8); }
        }
        #advertisement-countdown {
            margin-top: 20px; color: #ff9800; font-size: 1.5rem; font-weight: bold;
        }
        #advertisement-skip {
            margin-top: 20px; background: rgba(255, 152, 0, 0.3); 
            border: 1px solid #ff9800; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: not-allowed; opacity: 0.5;
        }
        #simulacro-end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 9998;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #simulacro-end-image {
            max-width: 90%; max-height: 60%; border-radius: 15px;
            margin-bottom: 30px;
        }
        #simulacro-end-timer {
            color: #ff9800; font-size: 1.2rem; margin-bottom: 20px;
        }
        #banner-container {
            width: 100%;
            max-width: 720px;
            height: auto;
            min-height: 50px;
            margin: 10px auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        #banner-img {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
        }
        #adOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #adBox {
            background: #1a1a2e;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4fc3f7;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.3);
            position: relative;
        }
        #adBox img {
            max-width: 100%;
            height: auto;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 6px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #adButtons {
            margin-top: 15px;
        }
        #adButtons button,
        #adButtons a {
            margin: 5px;
            padding: 10px 15px;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }
        #adButtons button:disabled {
            background: #999;
            cursor: not-allowed;
        }
        #footer {
            position: relative;
            width: 100%;
            margin-top: 50px;
            background: rgba(25, 25, 35, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 12px;
            z-index: 100;
            border-top: 1px solid rgba(79, 195, 247, 0.3);
        }
        #footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        #footer-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 3px;
        }
        .footer-link {
            color: #4fc3f7;
            text-decoration: none;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        .footer-link:hover {
            color: #21CBF3;
            text-decoration: underline;
        }
        .social-link {
            color: #4fc3f7;
            text-decoration: none;
            transition: color 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .social-link:hover {
            color: #21CBF3;
        }
        #copyright {
            color: #aaaaaa;
            font-size: 11px;
        }
        #privacy-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .privacy-modal-content {
            background: rgba(25, 25, 35, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            border: 2px solid #4fc3f7;
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
            position: relative;
        }
        .privacy-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        .privacy-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .privacy-title {
            color: #4fc3f7;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .privacy-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
        }
        .privacy-section {
            margin-bottom: 20px;
        }
        .privacy-section h3 {
            color: #4fc3f7;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .privacy-section p {
            margin-bottom: 10px;
        }
        @media (max-width: 768px) {
            .btn { font-size: 1rem; padding: 8px 16px; width: 100%; max-width: 300px; }
            .option-btn { font-size: 0.9rem !important; padding: 12px 12px 12px 40px !important; }
            .question-controls, .global-controls { flex-direction: column; align-items: center; }
            .header { padding: 12px; }
            .header h1 { font-size: 1.5rem; }
            .header h2 { font-size: 1.2rem; }
            .card { padding: 15px; }
            .question-container { padding: 15px; margin: 10px 0; }
            #question-text { font-size: 1.2rem !important; }
            .justification { padding: 12px; }
            .option-letter { width: 22px; height: 22px; font-size: 0.9rem; }
            #action-buttons { gap: 10px; }
            #action-buttons .btn { margin: 4px; }
            .results-container { padding: 15px; }
            .stat-box { min-width: 120px; padding: 10px; }
            .stat-box h3 { font-size: 1rem; }
            .stat-box p { font-size: 1.3rem; }
            #results-table { font-size: 0.8rem; }
            #results-table th, #results-table td { padding: 8px 4px; }
            .lookup-option { padding: 10px 10px 10px 35px; }
            .calculator-container { width: 280px; height: 350px; }
            #footer {
                padding: 5px 0;
            }
            #footer-links {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
                row-gap: 5px;
            }
            #footer-links span.text-gray-500 {
                display: none;
            }
            .footer-link, .social-link {
                font-size: 0.75rem; 
                padding: 4px 6px;
                background: rgba(0,0,0,0.2);
                border-radius: 4px;
            }
            .privacy-modal-content {
                padding: 20px;
                margin: 10px;
            }
        }
        @media (max-width: 480px) {
            body { padding: 8px !important; }
            .option-btn { font-size: 0.85rem !important; padding: 10px 10px 10px 35px !important; }
            .option-letter { width: 20px !important; height: 20px !important; font-size: 0.8rem !important; left: 10px !important; }
            .btn { font-size: 0.9rem; padding: 7px 14px; }
            .question-id-tags { font-size: 0.6rem; padding: 2px 5px; }
            .header h1 { font-size: 1.5rem !important; }
            .header h2 { font-size: 1.2rem !important; }
            #question-text { font-size: 1.1rem !important; }
            #image-container { max-width: 100%; }
            .justification h4 { font-size: 1rem !important; }
            .calculator-container { width: 95%; max-width: 300px; height: auto; padding-bottom: 20px; }
        }
		/* --- INICIO CORRECCI√ìN CALCULADORA --- */
    .calculator-container {
        width: 100%;
        max-width: 320px;
        background: rgba(30, 30, 40, 0.95);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        margin: 0 auto;
        border: 1px solid rgba(79, 195, 247, 0.3);
    }

    .calculator-display {
        background: rgba(0, 0, 0, 0.6);
        color: #4fc3f7;
        font-size: 2.5rem;
        padding: 15px;
        text-align: right;
        border-radius: 10px;
        margin-bottom: 15px;
        font-family: 'Courier New', monospace;
        letter-spacing: 2px;
        overflow: hidden;
        white-space: nowrap;
        border: 1px solid #4fc3f7;
        height: 70px;
        display: flex;
        align-items: center;
        justify-content: flex-end;
    }

    .calculator-buttons {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
    }

    .calculator-btn {
        background: rgba(60, 60, 80, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1.2rem;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }

    .calculator-btn:hover {
        background: rgba(100, 100, 120, 0.9);
        transform: translateY(-2px);
        box-shadow: 0 5px 10px rgba(0,0,0,0.3);
    }

    .calculator-btn:active {
        transform: translateY(1px);
    }

    .calculator-btn.operator {
        background: rgba(33, 150, 243, 0.2);
        color: #2196F3;
        border-color: #2196F3;
    }

    .calculator-btn.operator:hover {
        background: rgba(33, 150, 243, 0.4);
    }

    .calculator-btn.clear {
        background: rgba(244, 67, 54, 0.2);
        color: #f44336;
        border-color: #f44336;
    }

    .calculator-btn.clear:hover {
        background: rgba(244, 67, 54, 0.4);
    }

    .calculator-btn.special {
        background: rgba(255, 152, 0, 0.2);
        color: #ff9800;
        border-color: #ff9800;
    }

    .calculator-btn.equals {
        background: linear-gradient(45deg, #4CAF50, #8BC34A);
        color: white;
        grid-column: span 2; /* Hace que el bot√≥n igual ocupe 2 espacios */
        border: none;
    }
    /* --- FIN CORRECCI√ìN CALCULADORA --- */
    </style>
</head>
<body class="p-2 sm:p-4">
    <audio id="correct-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/Correct_sound.mp3" preload="auto"></audio>
    <audio id="incorrect-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/Incorrect_sound.mp3" preload="auto"></audio>
    <audio id="button-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/Clic_sound.mp3" preload="auto"></audio>
    <audio id="sad-violin-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/sad_violin.mp3" preload="auto"></audio>
    <audio id="simulacro-fail-1" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/simulacro_fail_1.mp3" preload="auto"></audio>
    <audio id="simulacro-fail-2" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/sad_violin.mp3" preload="auto"></audio>
    <audio id="simulacro-success-1" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/simulacro_logrado_1.mp3" preload="auto"></audio>
    <audio id="simulacro-success-2" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/simulacro_logrado_2.mp3" preload="auto"></audio>
    <div id="adOverlay" style="display: none;">
        <div id="adBox">
            <img id="adImage" src="" alt="Publicidad">
            <audio id="adAudio"></audio>
            <div id="adButtons">
                <button id="skipBtn" disabled>Saltar info</button>
                <a id="infoBtn" href="#" target="_blank" style="pointer-events:none;">
                    Me interesa
                </a>
            </div>
        </div>
    </div>
    <div id="privacy-modal" style="display: none;">
        <div class="privacy-modal-content">
            <button class="privacy-modal-close">&times;</button>
            <h2 class="privacy-title">AVISO DE PRIVACIDAD</h2>
            <div class="privacy-content">
                <div class="privacy-section">
                    <h3>CEPREDIX</h3>
                    <p>En cumplimiento con lo dispuesto por la Ley Federal de Protecci√≥n de Datos Personales en Posesi√≥n de los Particulares y su Reglamento, CEPREDIX, como responsable del tratamiento de datos personales, pone a disposici√≥n de estudiantes, tutores, usuarios y clientes el presente Aviso de Privacidad.</p>
                </div>
                <div class="privacy-section">
                    <h3>1. Identidad del responsable</h3>
                    <p>CEPREDIX es un servicio educativo que brinda cursos, plataformas educativas, simulacros, bancos de preguntas y otros servicios relacionados con la formaci√≥n acad√©mica.</p>
                    <p>CEPREDIX es responsable del uso, protecci√≥n y tratamiento de los datos personales que recaba de sus usuarios y estudiantes.</p>
                </div>
                <div class="privacy-section">
                    <h3>2. Datos personales que se recaban</h3>
                    <p>Para la prestaci√≥n de nuestros servicios educativos, CEPREDIX podr√° recabar los siguientes datos personales:</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Nombre del estudiante</li>
                        <li>Nombre del tutor (en caso de menores de edad)</li>
                        <li>Correo electr√≥nico de contacto</li>
                        <li>N√∫mero telef√≥nico con acceso a WhatsApp</li>
                    </ul>
                    <p>CEPREDIX no recaba datos personales sensibles.</p>
                </div>
                <div class="privacy-section">
                    <h3>3. Finalidades del tratamiento de los datos personales</h3>
                    <p>Los datos personales recabados ser√°n utilizados exclusivamente para fines internos, relacionados con:</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Registro y administraci√≥n de estudiantes y usuarios</li>
                        <li>Acceso y uso de plataformas educativas</li>
                        <li>Comunicaci√≥n acad√©mica, administrativa y operativa</li>
                        <li>Env√≠o de informaci√≥n relacionada con cursos, servicios o soporte</li>
                        <li>Seguimiento del servicio contratado</li>
                    </ul>
                    <p>En ning√∫n caso los datos ser√°n utilizados para fines distintos a los aqu√≠ se√±alados.</p>
                </div>
                <div class="privacy-section">
                    <h3>4. Conservaci√≥n de los datos</h3>
                    <p>Los datos personales se conservar√°n √∫nicamente durante el tiempo en que el usuario o estudiante mantenga una relaci√≥n activa con CEPREDIX.</p>
                    <p>Una vez concluida la contrataci√≥n de los servicios, los datos personales ser√°n eliminados de nuestra base de datos en un plazo m√°ximo de 30 d√≠as naturales, salvo aquellos que deban conservarse por disposici√≥n legal aplicable.</p>
                </div>
                <div class="privacy-section">
                    <h3>5. Transferencia de datos personales</h3>
                    <p>CEPREDIX no comparte, vende, cede ni transfiere datos personales a terceros, ya sea nacionales o extranjeros.</p>
                    <p>Toda la informaci√≥n recabada es utilizada exclusivamente para fines internos del servicio educativo.</p>
                </div>
                <div class="privacy-section">
                    <h3>6. Medidas de seguridad</h3>
                    <p>CEPREDIX implementa medidas administrativas, t√©cnicas y organizativas razonables para proteger los datos personales contra da√±o, p√©rdida, alteraci√≥n, destrucci√≥n o uso, acceso o tratamiento no autorizado.</p>
                </div>
                <div class="privacy-section">
                    <h3>7. Derechos ARCO (Acceso, Rectificaci√≥n, Cancelaci√≥n y Oposici√≥n)</h3>
                    <p>Los titulares de los datos personales tienen derecho a:</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Acceder a sus datos personales</li>
                        <li>Rectificar datos incorrectos o incompletos</li>
                        <li>Cancelar sus datos cuando consideren que no se requieren para los fines se√±alados</li>
                        <li>Oponerse al tratamiento de sus datos</li>
                    </ul>
                    <p>Para ejercer estos derechos, el titular podr√° enviar una solicitud a trav√©s de los medios de contacto oficiales de CEPREDIX, indicando claramente el derecho que desea ejercer.</p>
                </div>
                <div class="privacy-section">
                    <h3>8. Cambios al aviso de privacidad</h3>
                    <p>CEPREDIX se reserva el derecho de realizar modificaciones o actualizaciones al presente Aviso de Privacidad en cualquier momento.
                    Las modificaciones estar√°n disponibles a trav√©s de los medios oficiales del servicio.</p>
                </div>
                <div class="privacy-section">
                    <h3>9. Consentimiento</h3>
                    <p>Al utilizar los servicios educativos de CEPREDIX, el usuario y/o tutor manifiesta su consentimiento para el tratamiento de sus datos personales conforme a lo establecido en el presente Aviso de Privacidad.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="app-container" class="w-full max-w-2xl mx-auto">
        <header class="header">
            <button id="logout-btn" class="logout-btn" title="Cerrar sesi√≥n">
                <i class="fas fa-power-off"></i>
            </button>
            <a href="https://simuladores.cepredix.com.mx/cepredix.html" target="_blank" title="Ir a Web CEPREDIX">
                <div class="logo"></div>
            </a>
            <h1 class="text-2xl sm:text-3xl font-bold">PRUEBA (Global)</h1>
            <h2 class="text-xl sm:text-2xl">Dise√±ado con pasi√≥n üíú por el CEPREDIX</h2>
            <p class="text-sm sm:text-base">Prueba tus conocimientos con este cuestionario interactivo de opci√≥n m√∫ltiple üß†</p>
        </header>
        <div id="banner-container" style="display: none;">
            <a id="banner-link" href="#" target="_blank">
                <img id="banner-img" src="" alt="Aviso">
            </a>
            <audio id="banner-audio-player"></audio>
        </div>
        <div id="login-screen" class="card p-6 sm:p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-2xl sm:text-3xl font-bold">HOLA üñê TE DAMOS LA BIENVENIDA üòâ</h2>
                <p class="text-gray-300 mt-2">Por favor, valida tus datos para comenzar</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="name-input" class="font-medium">Nombre y apellido</label>
                    <input type="text" id="name-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="Tu nombre o nombre completo" required>
                </div>
                <div>
                    <label for="email-input" class="font-medium">Correo Electr√≥nico</label>
                    <input type="email" id="email-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="tu.correo@ejemplo.com" required>
                </div>
                <div>
                    <label for="whatsapp-input" class="font-medium">WhatsApp (10 d√≠gitos sin espacios)</label>
                    <input type="password" id="whatsapp-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="10" inputmode="numeric" required>
                </div>
                <button id="login-btn" type="submit" class="btn btn-correct w-full text-lg">
                    <span id="login-btn-text">Verificar y Entrar</span>
                    <span id="login-btn-spinner" class="hidden animate-spin">&#9696;</span>
                </button>
            </form>
            <p id="login-error-message" class="text-red-400 text-center text-sm h-4"></p>
			<div class="w-full mt-4 border-t border-gray-600 pt-4">
                <button type="button" id="toggle-access-btn" class="btn w-full" style="background: linear-gradient(45deg, #d32f2f, #ff5252); color: white; border: none; box-shadow: 0 4px 10px rgba(244, 67, 54, 0.3);">
                    SOLICITAR ACCESO A LA EVALUACI√ìN <i class="fas fa-chevron-down ml-2"></i>
                </button>
                
                <div id="access-info-box" class="hidden mt-3 p-4 bg-gray-800 rounded-lg border border-gray-600 text-center transition-all duration-300">
                    <p class="text-gray-300 text-sm mb-4 leading-relaxed">
                        Este es un simulador de examen del CEPREDIX dise√±ado para estudiantes de nuestros servicios de asesor√≠as y cursos. Si perdiste el acceso o requieres solicitar el acceso, env√≠a mensaje v√≠a WhatsApp aqu√≠ üëâ
                    </p>
                    <a href="https://wa.link/6kv1g5" target="_blank" class="btn btn-correct w-full text-sm no-underline flex items-center justify-center py-3">
                        <i class="fab fa-whatsapp mr-2 text-lg"></i> SOLICITAR ACCESO V√çA WHATSAPP
                    </a>
                </div>
            </div>
        </div>
        <div id="setup-screen" class="card p-6 sm:p-8 space-y-6 hidden">
            <div class="text-center">
                <h1 class="text-2xl sm:text-3xl font-bold">Hola, <span id="welcome-name" class="text-blue-400"></span></h1>
                <p class="text-gray-300 mt-2">A continuaci√≥n podr√°s iniciar tu evaluaci√≥n. Recuerda que una vez iniciada, no podr√°s pausarla.</p>
            </div>
			<div class="video-container w-full mt-4">
                <div class="video-wrapper" style="border: 1px solid #4fc3f7; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);">
                    <iframe src="https://www.youtube.com/embed/jh0xqP4IPhI?list=PLXOxJVJlgkrvbX27SwvdY4TupN5tS_BTH" title="Instrucciones" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                </div>
                <p class="text-center text-sm text-gray-400 mt-2">üëÜ Mira el video de instrucciones antes de iniciar</p>
            </div>
            
            <div id="evaluation-info" class="text-center space-y-4">
                <button id="start-evaluation-btn" class="btn btn-primary w-full text-lg py-6 text-xl">
                    INICIAR EVALUACI√ìN
                </button>
                <div id="evaluation-details" class="space-y-2 hidden">
                    <p class="text-gray-300">N√∫mero de preguntas: <span id="total-questions-count" class="font-bold text-white">0</span></p>
                    <p class="text-gray-300">Tiempo disponible: <span id="total-time-count" class="font-bold text-white">0 minutos</span></p>
                    <p class="text-sm text-yellow-300">Atneci√≥n esta actividad tiene temporizador, una vez que inicies, no podr√°s pausarla.</p>
                </div>
            </div>
            
            <p id="error-message" class="text-red-400 text-center text-sm h-4"></p>
        </div>
        <div id="quiz-screen" class="card p-4 sm:p-8 hidden flex flex-col">
            <div class="flex flex-row flex-wrap justify-between items-center mb-2 gap-y-1 gap-x-2 w-full">
                <div class="text-xs sm:text-lg font-bold text-gray-200 order-1">
                    Pregunta <span id="current-question-num"></span>/<span id="total-questions-num"></span>
                </div>
                <div id="live-score" class="flex gap-2 text-xs sm:text-lg order-2">
                    <span class="font-bold text-green-400">‚úì <span id="live-correct">0</span></span>
                    <span class="font-bold text-red-400">‚úó <span id="live-incorrect">0</span></span>
                </div>
                <div class="flex items-center space-x-1 text-xs sm:text-lg font-bold order-3" id="timer-container">
                    <svg class="h-4 w-4 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span id="timer" class="timer-green">00:00</span>
                </div>
                <div id="quiz-volume-control" class="flex items-center gap-1 order-4">
                    <button class="volume-btn-new w-5 h-5 sm:w-7 sm:h-7 text-xs sm:text-base flex items-center justify-center" data-action="down">-</button>
                    <i class="fas fa-volume-high text-gray-300 text-xs sm:text-lg"></i>
                    <span id="volume-indicator-quiz" class="text-xs sm:text-sm font-semibold w-6 sm:w-10 text-center">50%</span>
                    <button class="volume-btn-new w-5 h-5 sm:w-7 sm:h-7 text-xs sm:text-base flex items-center justify-center" data-action="up">+</button>
                </div>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-400 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div id="question-container" class="space-y-4 flex flex-col items-center">
                <h2 id="question-text" class="text-xl sm:text-2xl font-semibold text-center w-full"></h2>
                <div id="video-container" class="video-container w-full">
                    <div class="video-toggle" id="video-toggle">
                        <span><i class="fas fa-video mr-2"></i> Mostrar/Ocultar Video de Apoyo</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="video-content hidden" id="video-content">
                        <div class="video-wrapper">
                            <iframe id="video-iframe" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
                <div id="image-section-container" class="w-full hidden">
                    <div class="video-toggle" id="image-toggle">
                        <span><i class="fas fa-image mr-2"></i> Mostrar/Ocultar Imagen de Apoyo</span>
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    <div id="image-content" class="video-content p-0 bg-transparent" style="margin-top: 1rem;">
                            <div id="image-container" class="rounded-lg shadow-md m-auto">
                               <div id="watermark-overlay"></div>
                            </div>
                    </div>
                </div>
                <div id="text-section-container" class="video-container w-full hidden">
                    <div class="video-toggle" id="text-toggle">
                        <span><i class="fas fa-file-alt mr-2"></i> Mostrar/Ocultar Lectura de Apoyo</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="video-content hidden" id="text-content">
                        </div>
                </div>
                <div class="flex flex-row flex-nowrap items-center justify-between w-full my-2 gap-2 px-1">
                    <button id="mini-prev-btn" class="mini-nav-btn" title="Pregunta Anterior" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div class="flex flex-row flex-wrap items-center justify-center gap-2">
                        <div id="question-id-tags" class="question-id-tags !m-0">
                            <span id="question-id-display" class="question-id"></span>
                            <span id="uni-tags-display"></span>
                            <span id="level-tag-display"></span>
                        </div>

                        <button id="whiteboard-trigger-btn" class="text-blue-400 hover:text-white transition-all hover:scale-110 p-2 bg-gray-800 bg-opacity-80 rounded-full w-10 h-10 flex items-center justify-center border border-blue-400 shadow-lg" title="Abrir Pizarra de C√°lculos">
                            <i class="fas fa-pen-to-square"></i>
                        </button>
                    </div>

                    <button id="mini-next-btn" class="mini-nav-btn" title="Siguiente Pregunta" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div id="options-container" class="w-full space-y-3"></div>
                <div id="justification-box" class="justification w-full hidden">
                    <h4>Justificaci√≥n:</h4>
                    <p id="justification-text"></p>
                </div>
            </div>
            <div id="action-buttons" class="mt-6 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <button id="hint-btn" class="btn btn-hint w-full">üí° PISTA</button>
                    <button id="evaluate-btn" class="btn btn-primary w-full" disabled>
                        <span class="evaluate-emoji">ü§®</span> EVALUAR
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="prev-btn" class="btn btn-secondary w-full">‚Üê ANTERIOR</button>
                    <button id="next-btn" class="btn btn-secondary w-full" disabled>SIGUIENTE ‚Üí</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="skip-btn" class="btn btn-secondary w-full">OMITIR REACTIVO</button>
                    <button id="finish-btn" class="btn btn-secondary w-full">FINALIZAR EVALUACI√ìN</button>
                </div>
            </div>
            <div id="calculator-section" class="video-container w-full">
                <div id="calculator-toggle" class="video-toggle">
                    <span><i class="fas fa-calculator mr-2"></i> Calculadora</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="calculator-content" class="video-content hidden" style="background: transparent; padding: 0; margin-top: 10px;">
                    <div class="calculator-container">
                        <div class="calculator-display" id="calc-display">0</div>
                        <div class="calculator-buttons">
                            <button class="calculator-btn clear" data-value="C">C</button>
                            <button class="calculator-btn special" data-value="‚àö">‚àö</button>
                            <button class="calculator-btn operator" data-value="/">√∑</button>
                            <button class="calculator-btn operator" data-value="*">√ó</button>
                            <button class="calculator-btn" data-value="7">7</button>
                            <button class="calculator-btn" data-value="8">8</button>
                            <button class="calculator-btn" data-value="9">9</button>
                            <button class="calculator-btn operator" data-value="-">-</button>
                            <button class="calculator-btn" data-value="4">4</button>
                            <button class="calculator-btn" data-value="5">5</button>
                            <button class="calculator-btn" data-value="6">6</button>
                            <button class="calculator-btn operator" data-value="+">+</button>
                            <button class="calculator-btn" data-value="1">1</button>
                            <button class="calculator-btn" data-value="2">2</button>
                            <button class="calculator-btn" data-value="3">3</button>
                            <button class="calculator-btn" data-value="0">0</button>
                            <button class="calculator-btn" data-value=".">.</button>
                            <button class="calculator-btn equals" data-value="=">=</button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-3">
                 <button id="cancel-btn" class="btn btn-secondary w-full text-sm">VOLVER AL MEN√ö</button>
                 <a href="https://wa.link/kz8tbd" target="_blank" id="report-btn" class="btn btn-secondary w-full text-sm">REPORTAR ERROR</a>
            </div>
        </div>
        <div id="results-screen" class="card p-4 sm:p-8 text-center hidden">
            <h1 class="text-2xl sm:text-3xl font-bold">¬°Resultados Finales!</h1>
            <div id="result-image-container">
                <img id="result-image" src="" alt="Imagen de resultado">
            </div>
            <div class="flex flex-col lg:flex-row justify-around items-center gap-6 my-6">
                <div class="w-full lg:w-1/2"><canvas id="results-chart"></canvas></div>
                <div class="text-left space-y-2">
                    <p class="text-xl font-medium">Calificaci√≥n: <span id="final-score" class="font-bold text-blue-400"></span></p>
                    <p>Tiempo total: <span id="total-time" class="font-semibold"></span></p>
                    <p>Tiempo promedio: <span id="avg-time" class="font-semibold"></span></p>
                    <p class="text-green-400">Correctas: <span id="correct-count" class="font-semibold"></span></p>
                    <p class="text-red-400">Incorrectas: <span id="incorrect-count" class="font-semibold"></span></p>
                    <p class="text-yellow-400">Omitidas: <span id="omitted-count" class="font-semibold"></span></p>
                    <p class="text-gray-400">No identificadas: <span id="unanswered-count" class="font-semibold"></span></p>
                </div>
            </div>
             <div class="mt-8 overflow-x-auto">
                <h3 class="text-xl font-bold mb-4">Resumen de Respuestas</h3>
                <table id="results-table" class="w-full text-sm text-left">
                    <thead class="text-xs uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3">Reactivo</th>
                            <th scope="col" class="px-4 py-3">Pregunta</th>
                            <th scope="col" class="px-4 py-3">Tu Respuesta</th>
                            <th scope="col" class="px-4 py-3">Correcta</th>
                            <th scope="col" class="px-4 py-3">Resultado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="summary-box" class="card p-6 mt-8 text-left bg-gray-700">
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold mb-4">Resumen de la Evaluaci√≥n</h3>
                </div>
                <div class="space-y-2">
                    <p><strong>Nombre del Cuestionario:</strong> <span id="summary-eval-name"></span></p>
                    <p><strong>Fecha de Realizaci√≥n:</strong> <span id="summary-date"></span></p>
                    <p><strong>Resultado:</strong> <span id="summary-score" class="font-bold"></span></p>
                    <div>
                        <p><strong>IDs de esta Evaluaci√≥n:</strong></p>
                        <p id="summary-ids" class="text-xs text-gray-400 break-words"></p>
                    </div>
                    <div>
                        <p><strong>IDs Acumulados:</strong></p>
                        <p id="summary-ids-acumulados" class="text-xs text-gray-400 break-words"></p>
                    </div>
                </div>
            </div>
            <div class="mt-8 space-y-2">
                <label for="answered-ids-output" class="font-medium">Estos son los id¬¥s solo de los ejercicios correctamente respondidos en esta evaluaci√≥n, c√≥pialos si deseas que no aparezcan estos ejercicios en la siguiente evaluaci√≥n que realices:</label>
                <div class="flex gap-2">
                    <textarea id="answered-ids-output" rows="4" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 text-white" readonly></textarea>
                    <button id="copy-ids-btn" class="btn btn-secondary">Copiar</button>
                </div>
            </div>
            <button id="restart-quiz-btn" class="btn btn-primary w-full sm:w-auto mt-8">Hacer otro cuestionario</button>
        </div>
    </div>
    <div id="footer">
        <div id="footer-content">
            <div id="footer-links">
                <a href="https://simuladores.cepredix.com.mx/cepredix.html" target="_blank" class="footer-link social-link">
                    <i class="fas fa-globe"></i> WEB CEPREDIX
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.facebook.com/cepredix/" target="_blank" class="footer-link social-link">
                    <i class="fab fa-facebook"></i> Facebook
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.instagram.com/cepredix/" target="_blank" class="footer-link social-link">
                    <i class="fab fa-instagram"></i> Instagram
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.tiktok.com/@cepredix" target="_blank" class="footer-link social-link">
                    <i class="fab fa-tiktok"></i> TikTok
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.youtube.com/@Cepredix" target="_blank" class="footer-link social-link">
                    <i class="fab fa-youtube"></i> YouTube
                </a>
                <span class="text-gray-500">|</span>

                <a href="#" id="privacy-link" class="footer-link">Aviso de Privacidad</a>
            </div>
            <div id="copyright">
                &copy; CEPREDIX 2026 - Todos los derechos reservados. Versi√≥n CEP-2.2401
            </div>
        </div>
    </div>
<div id="overlay-whiteboard" class="fixed inset-0 z-[9999] hidden" style="touch-action: none;">
    <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-none"></div>
    
    <canvas id="wb-canvas" class="absolute inset-0 w-full h-full cursor-crosshair"></canvas>

    <button id="wb-close-btn" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white rounded-full w-10 h-10 lg:w-8 lg:h-8 flex items-center justify-center shadow-lg transition-transform hover:scale-110 z-50">
        <i class="fas fa-times lg:text-sm"></i>
    </button>

    <div class="absolute top-1/2 right-4 transform -translate-y-1/2 flex flex-col gap-4 z-50">
        <button id="wb-scroll-up" class="bg-gray-800 border border-gray-600 hover:bg-gray-700 text-white rounded-full w-12 h-12 lg:w-10 lg:h-10 flex items-center justify-center shadow-xl transition-transform active:scale-95" title="Subir pantalla">
            <i class="fas fa-arrow-up lg:text-sm"></i>
        </button>
        <button id="wb-scroll-down" class="bg-gray-800 border border-gray-600 hover:bg-gray-700 text-white rounded-full w-12 h-12 lg:w-10 lg:h-10 flex items-center justify-center shadow-xl transition-transform active:scale-95" title="Bajar pantalla">
            <i class="fas fa-arrow-down lg:text-sm"></i>
        </button>
    </div>

    <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 border border-gray-700 p-2 lg:p-1.5 rounded-full flex items-center gap-1 sm:gap-3 lg:gap-2 shadow-2xl z-50 overflow-x-auto max-w-[98%] sm:max-w-max">
        
        <button class="wb-tool-btn w-8 h-8 lg:w-6 lg:h-6 rounded-full border-2 border-white bg-white hover:scale-110 transition-transform shrink-0" data-color="#ffffff" title="Blanco"></button>
        <button class="wb-tool-btn w-8 h-8 lg:w-6 lg:h-6 rounded-full border-2 border-gray-600 bg-[#39ff14] hover:scale-110 transition-transform shadow-[0_0_10px_#39ff14] shrink-0" data-color="#39ff14" title="Verde Ne√≥n"></button>
        
        <div class="relative w-8 h-8 lg:w-6 lg:h-6 rounded-full border-2 border-gray-600 shrink-0 overflow-hidden hover:scale-110 transition-transform shadow-[0_0_10px_#ff073a]" title="Color Personalizable (Default: Rojo)">
            <input type="color" id="wb-custom-color-picker" value="#ff073a" class="absolute inset-0 w-[150%] h-[150%] -top-1/4 -left-1/4 p-0 m-0 border-0 cursor-pointer opacity-0">
            <div id="wb-custom-preview" class="w-full h-full bg-[#ff073a] pointer-events-none"></div>
        </div>
        
        <button id="wb-eraser-btn" class="w-8 h-8 lg:w-6 lg:h-6 rounded-full border-2 border-gray-500 bg-gray-700 text-white hover:scale-110 transition-transform flex items-center justify-center ml-1 shrink-0" title="Borrador">
            <i class="fas fa-eraser text-xs lg:text-[10px]"></i>
        </button>

        <div class="w-px h-6 lg:h-4 bg-gray-600 mx-1 shrink-0"></div>

        <div class="flex items-center gap-1 sm:gap-2 px-1 shrink-0" title="Ajustar grosor">
            <i class="fas fa-circle text-[4px] text-gray-400 hidden sm:block"></i>
            <input type="range" id="wb-width-slider" min="1" max="10" value="2" class="w-16 sm:w-24 lg:w-20 cursor-pointer h-1 bg-gray-600 rounded-lg appearance-none">
            <i class="fas fa-circle text-[10px] text-gray-400 hidden sm:block"></i>
        </div>

        <div class="w-px h-6 lg:h-4 bg-gray-600 mx-1 shrink-0"></div>

        <button id="wb-undo-btn" class="text-gray-300 hover:text-white p-2 lg:p-1 shrink-0" title="Deshacer">
            <i class="fas fa-undo lg:text-sm"></i>
        </button>
        <button id="wb-redo-btn" class="text-gray-300 hover:text-white p-2 lg:p-1 shrink-0" title="Rehacer">
            <i class="fas fa-redo lg:text-sm"></i>
        </button>
        
        <div class="w-px h-6 lg:h-4 bg-gray-600 mx-1 shrink-0"></div>

        <button id="wb-clear-btn" class="text-red-400 hover:text-red-300 p-2 lg:p-1 shrink-0" title="Borrar todo">
            <i class="fas fa-trash-alt lg:text-sm"></i>
        </button>
    </div>
</div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const QUIZ_JSON_URL = 'https://raw.githubusercontent.com/IALUMX/Bancos_prueba/refs/heads/main/00-json-prueba-v2-170126.json';
            const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5sU2hYNByYHNDESXxZPoe3dikV115hY_TII15wZtF8E0NWBFmnLSW2ad7ZqDdwk-jTPQfX-92n6zQ/pub?gid=0&single=true&output=csv';
            const CORS_PROXY_URL = 'https://corsproxy.io/?' + encodeURIComponent(GOOGLE_SHEET_URL);
            const RESULTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYESY3dBy0h5QrY5EyJ_jfHwlEwnhByFcPTywwK4jJhGa3rvrnIzR9OXleZUZ7zVqUqw/exec';
            const SUBMISSION_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxF2v5plRObokCgrV-3olVosjn-3q08B9bMUpeLMuYXyzuiRmsKAEadMUMb-WH2Dg7F/exec';
            const RESULT_IMAGES = {
                less7: 'https://i.imgur.com/pyBFfO9.png',
                between7_8: 'https://i.imgur.com/eMPH60B.png',
                between8_9: 'https://i.imgur.com/OY5wmBo.png',
                between9_9_5: 'https://i.imgur.com/uLpyVoj.png',
                between9_5_10: 'https://i.imgur.com/89lj6aD.png',
                perfect10: 'https://i.imgur.com/HGyyYIC.png'
            };
            const ADS_CSV_URL = "https://docs.google.com/spreadsheets/d/1VkMosrVw7vJdZqGvInDcu3oKlK7WZlTrWAnH2YHqrew/export?format=csv&gid=0";
            
            const screens = {
                login: document.getElementById('login-screen'),
                setup: document.getElementById('setup-screen'),
                quiz: document.getElementById('quiz-screen'),
                results: document.getElementById('results-screen'),
            };
            const loginForm = document.getElementById('login-form');
            const nameInput = document.getElementById('name-input');
            const emailInput = document.getElementById('email-input');
            const whatsappInput = document.getElementById('whatsapp-input');
            const loginBtn = document.getElementById('login-btn');
            const loginBtnText = document.getElementById('login-btn-text');
            const loginBtnSpinner = document.getElementById('login-btn-spinner');
            const loginErrorMessage = document.getElementById('login-error-message');
			const toggleAccessBtn = document.getElementById('toggle-access-btn');
			const accessInfoBox = document.getElementById('access-info-box');

			if (toggleAccessBtn && accessInfoBox) {
  			  toggleAccessBtn.addEventListener('click', () => {
   			     accessInfoBox.classList.toggle('hidden');
   			     const icon = toggleAccessBtn.querySelector('i');
   			     if (icon) {
    			        if (accessInfoBox.classList.contains('hidden')) {
    			            icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
    			        } else {
    			            icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
   			         }
    			    }
 			   });
			}
            const welcomeName = document.getElementById('welcome-name');
            const startEvaluationBtn = document.getElementById('start-evaluation-btn');
            const evaluationDetails = document.getElementById('evaluation-details');
            const totalQuestionsCount = document.getElementById('total-questions-count');
            const totalTimeCount = document.getElementById('total-time-count');
            const currentQuestionNum = document.getElementById('current-question-num');
            const totalQuestionsNum = document.getElementById('total-questions-num');
            const liveCorrect = document.getElementById('live-correct');
            const liveIncorrect = document.getElementById('live-incorrect');
            const timerDisplay = document.getElementById('timer');
            const timerContainer = document.getElementById('timer-container');
            const progressBar = document.getElementById('progress-bar');
            const questionText = document.getElementById('question-text');
            const questionIdDisplay = document.getElementById('question-id-display');
            const uniTagsDisplay = document.getElementById('uni-tags-display');
            const levelTagDisplay = document.getElementById('level-tag-display');
            const imageContainer = document.getElementById('image-container');
            const watermarkOverlay = document.getElementById('watermark-overlay');
            const optionsContainer = document.getElementById('options-container');
            const justificationBox = document.getElementById('justification-box');
            const justificationText = document.getElementById('justification-text');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const skipBtn = document.getElementById('skip-btn');
            const hintBtn = document.getElementById('hint-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const finishBtn = document.getElementById('finish-btn');
            const resultImage = document.getElementById('result-image');
            const finalScore = document.getElementById('final-score');
            const totalTime = document.getElementById('total-time');
            const avgTime = document.getElementById('avg-time');
            const correctCount = document.getElementById('correct-count');
            const incorrectCount = document.getElementById('incorrect-count');
            const omittedCount = document.getElementById('omitted-count');
            const unansweredCount = document.getElementById('unanswered-count');
            const resultsTableBody = document.querySelector('#results-table tbody');
            const answeredIdsOutput = document.getElementById('answered-ids-output');
            const copyIdsBtn = document.getElementById('copy-ids-btn');
            const restartQuizBtn = document.getElementById('restart-quiz-btn');
            const resultsChartCanvas = document.getElementById('results-chart');
            const summaryEvalName = document.getElementById('summary-eval-name');
            const summaryDate = document.getElementById('summary-date');
            const summaryScore = document.getElementById('summary-score');
            const summaryIds = document.getElementById('summary-ids');
            const summaryIdsAcumulados = document.getElementById('summary-ids-acumulados');
            const calculatorToggle = document.getElementById('calculator-toggle');
            const calculatorContent = document.getElementById('calculator-content');
            const calculatorDisplay = document.getElementById('calc-display');
            const videoContainer = document.getElementById('video-container');
            const videoToggle = document.getElementById('video-toggle');
            const videoContent = document.getElementById('video-content');
            const videoIframe = document.getElementById('video-iframe');
            const evaluateBtn = document.getElementById('evaluate-btn');
            const imageSectionContainer = document.getElementById('image-section-container');
            const imageToggle = document.getElementById('image-toggle');
            const imageContent = document.getElementById('image-content');
            const volumeIndicatorQuiz = document.getElementById('volume-indicator-quiz');
            const textSectionContainer = document.getElementById('text-section-container');
            const textToggle = document.getElementById('text-toggle');
            const textContent = document.getElementById('text-content');
            const correctSound = document.getElementById('correct-sound');
            const incorrectSound = document.getElementById('incorrect-sound');
            const buttonSound = document.getElementById('button-sound');
            const sadViolinSound = document.getElementById('sad-violin-sound');
            const simulacroFail1 = document.getElementById('simulacro-fail-1');
            const simulacroFail2 = document.getElementById('simulacro-fail-2');
            const simulacroSuccess1 = document.getElementById('simulacro-success-1');
            const simulacroSuccess2 = document.getElementById('simulacro-success-2');
            const privacyModal = document.getElementById('privacy-modal');
            const privacyLink = document.getElementById('privacy-link');
            const closePrivacyModal = document.querySelector('.privacy-modal-close');
            const adOverlay = document.getElementById('adOverlay');
            const adImage = document.getElementById('adImage');
            const adAudio = document.getElementById('adAudio');
            const skipBtnAd = document.getElementById('skipBtn');
            const infoBtn = document.getElementById('infoBtn');
            const logoutBtn = document.getElementById('logout-btn');
            const miniPrevBtn = document.getElementById('mini-prev-btn');
            const miniNextBtn = document.getElementById('mini-next-btn');
            
            let allQuestions = [], quizQuestions = [], userAnswers = [];
            let currentQuestionIndex = 0, timer, seconds = 0, resultsChart;
            let currentUser = {};
            let questionStartTime = 0;
            let totalQuestionTime = 0;
            let calculatorValue = '0';
            let calculatorWaitingForOperand = false;
            let calculatorOperator = null;
            let calculatorPreviousValue = '0';
            let effectsVolume = 0.5;
            let evaluateEmojiInterval;
            let totalAvailableQuestions = 0;
            let totalEvaluationTime = 0; // en segundos
            let evaluationTimer = null;
            let timeLeft = 0; // segundos restantes
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if(confirm("¬øEst√°s seguro de que deseas cerrar sesi√≥n?")) {
                        localStorage.removeItem('sessionToken');
                        localStorage.removeItem('userEmail');
                        location.reload();
                    }
                });
            }
            
            fetch(ADS_CSV_URL)
                .then(r => r.text())
                .then(csv => {
                    const rows = csv.split("\n").slice(1);
                    rows.forEach(row => {
                        const cols = row.split(",");
                        if (cols.length >= 5) {
                            const item = {
                                Imagen: cols[0].trim(),
                                Audio: cols[1].trim(),
                                Infolink: cols[2].trim(),
                                Tipo: cols[4].trim().replace(/\r/g, "")
                            };
                        }
                    });
                }).catch(err => {
                    console.error("Error al cargar publicidad:", err);
                });

            privacyLink.addEventListener('click', (e) => {
                e.preventDefault();
                privacyModal.style.display = 'flex';
            });
            
            closePrivacyModal.addEventListener('click', () => {
                privacyModal.style.display = 'none';
            });
            
            privacyModal.addEventListener('click', (e) => {
                if (e.target === privacyModal) {
                    privacyModal.style.display = 'none';
                }
            });

            function updateVolumeDisplay() {
                const percentage = Math.round(effectsVolume * 100) + '%';
                if(volumeIndicatorQuiz) volumeIndicatorQuiz.textContent = percentage;
            }

            function initializeVolumes() {
                correctSound.volume = effectsVolume;
                incorrectSound.volume = effectsVolume;
                buttonSound.volume = effectsVolume;
                sadViolinSound.volume = effectsVolume;
                simulacroFail1.volume = 0.3;
                simulacroFail2.volume = 0.3;
                simulacroSuccess1.volume = 0.3;
                simulacroSuccess2.volume = 0.3;
                updateVolumeDisplay();
            }
            
            document.querySelectorAll('.volume-btn-new').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (action === 'down') {
                        effectsVolume = Math.max(0, effectsVolume - 0.1);
                    } else if (action === 'up') {
                        effectsVolume = Math.min(1, effectsVolume + 0.1);
                    }
                    effectsVolume = parseFloat(effectsVolume.toFixed(2));
                    initializeVolumes();
                    const icon = btn.closest('div').querySelector('i');
                    if(icon) icon.classList.add('text-blue-400');
                    setTimeout(() => {
                        if(icon) icon.classList.remove('text-blue-400');
                    }, 300);
                });
            });

            function playButtonSound() {
                buttonSound.currentTime = 0;
                buttonSound.play().catch(e => console.error("Error al reproducir sonido de bot√≥n:", e));
            }
            
            document.body.addEventListener('click', (e) => {
                const soundClasses = [
                    '.btn', 
                    '.option-btn', 
                    '.calculator-btn', 
                    '.tag', 
                    '.video-toggle', 
                    '.control-btn', 
                    '.color-picker-wrapper', 
                    '#clear-button', 
                    '.volume-btn-new',
                    '.privacy-modal-close',
                    '.close-modal-btn',
                    '#logout-btn'
                ];

                const target = e.target.closest(soundClasses.join(','));

                if (target && !target.disabled && !target.classList.contains('btn-disabled')) {
                    playButtonSound();
                }
            });
            
            videoToggle.addEventListener('click', () => {
                videoContent.classList.toggle('hidden');
                const icon = videoToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (videoContent.classList.contains('hidden')) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });

            imageToggle.addEventListener('click', () => {
                imageContent.classList.toggle('hidden');
                const icon = imageToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (imageContent.classList.contains('hidden')) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });

            textToggle.addEventListener('click', () => {
                textContent.classList.toggle('hidden');
                const icon = textToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (textContent.classList.contains('hidden')) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });
            
            function startEvaluateEmojiAnimation() {
                const emojis = ['ü§®', 'üôÇ', 'üòÆ', 'üò´', 'üòé'];
                let index = 0;
                if (evaluateEmojiInterval) {
                    clearInterval(evaluateEmojiInterval);
                }
                evaluateEmojiInterval = setInterval(() => {
                    const emojiSpan = evaluateBtn.querySelector('.evaluate-emoji');
                    if (emojiSpan) {
                        index = (index + 1) % emojis.length;
                        emojiSpan.textContent = emojis[index];
                    }
                }, 200);
            }
            
            function stopEvaluateEmojiAnimation() {
                if (evaluateEmojiInterval) {
                    clearInterval(evaluateEmojiInterval);
                    evaluateEmojiInterval = null;
                    const emojiSpan = evaluateBtn.querySelector('.evaluate-emoji');
                    if (emojiSpan) {
                        emojiSpan.textContent = '‚úÖ';
                    }
                }
            }

            function evaluateCurrentAnswer() {
                const currentAnswer = userAnswers[currentQuestionIndex];
                const { question } = currentAnswer;
                const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
                totalQuestionTime += timeSpent;
                
                let isCorrect = false;
                let selectedTextForReport = "";
                let statusResult = 'incorrect';

                // Detectar si es h√≠brido
                const isHybrid = question.options.some(opt => 'text_op1' in opt);

                if (isHybrid) {
                    const sel1 = optionsContainer.querySelector('.option-btn[data-group="1"].selected');
                    const sel2 = optionsContainer.querySelector('.option-btn[data-group="2"].selected');
                    
                    const val1 = sel1 ? sel1.dataset.text : "Sin responder";
                    const val2 = sel2 ? sel2.dataset.text : "Sin responder";
                    
                    selectedTextForReport = `[1]: ${val1} | [2]: ${val2}`;

                    const correctOp1 = question.options.find(o => 'text_op1' in o && o.correct)?.text_op1;
                    const correctOp2 = question.options.find(o => 'text_op2' in o && o.correct)?.text_op2;

                    // L√≥gica estricta: Ambas deben ser correctas y NO ser la opci√≥n de "No puedo identificar"
                    const hit1 = (val1 === correctOp1);
                    const hit2 = (val2 === correctOp2);

                    if (val1.includes("No puedo identificar") || val2.includes("No puedo identificar")) {
                        statusResult = 'unidentified';
                    } else if (hit1 && hit2) {
                        isCorrect = true;
                        statusResult = 'correct';
                    } else {
                        statusResult = 'incorrect';
                    }

                } else {
                    // L√≥gica Est√°ndar
                    const selectedButton = optionsContainer.querySelector('.option-btn.selected');
                    const selectedOption = selectedButton ? selectedButton.dataset.text : "No puedo identificar la respuesta üò•";
                    selectedTextForReport = selectedOption;

                    const correctOption = question.options.find(opt => opt.correct);
                    isCorrect = correctOption && correctOption.text === selectedOption;

                    if (selectedOption.includes("No puedo identificar")) {
                        statusResult = 'unidentified';
                    } else if (isCorrect) {
                        statusResult = 'correct';
                    } else {
                        statusResult = 'incorrect';
                    }
                }
                
                // Actualizar respuesta
                currentAnswer.selected = selectedTextForReport;
                currentAnswer.timeSpent = timeSpent;
                currentAnswer.status = statusResult;

                if (statusResult === 'unidentified') {
                    if (effectsVolume > 0) {
                        incorrectSound.currentTime = 0;
                        incorrectSound.volume = effectsVolume;
                        incorrectSound.play().catch(e => console.error(e));
                    }
                } else if (statusResult === 'correct') {
                    if (effectsVolume > 0) {
                        correctSound.currentTime = 0;
                        correctSound.volume = effectsVolume;
                        correctSound.play().catch(e => console.error(e));
                    }
                } else {
                    if (effectsVolume > 0) {
                        incorrectSound.currentTime = 0;
                        incorrectSound.volume = effectsVolume;
                        incorrectSound.play().catch(e => console.error(e));
                    }
                }
                
                updateLiveScore();
                showFeedback();
                updateButtonStates();
            }

            function toggleCalculator() {
                const isHidden = calculatorContent.classList.toggle('hidden');
                const icon = calculatorToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (isHidden) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            }
            
            calculatorToggle.addEventListener('click', toggleCalculator);
            document.querySelectorAll('.calculator-btn').forEach(button => {
                button.addEventListener('click', () => calculatorButtonClick(button.dataset.value));
            });
            
            function calculatorButtonClick(value) {
                if (value === 'C') {
                    calculatorValue = '0';
                    calculatorWaitingForOperand = false;
                    calculatorOperator = null;
                    calculatorPreviousValue = '0';
                    } else if (value === '‚àö') {
                        try {
                            const currentVal = parseFloat(calculatorValue);
                            if (currentVal >= 0) {
                                const result = Math.sqrt(currentVal);
                                // Redondear para evitar n√∫meros infinitos en pantalla
                                calculatorValue = String(parseFloat(result.toFixed(8)));
                            } else {
                                calculatorValue = 'Error';
                            }
                            calculatorWaitingForOperand = true;
                        } catch {
                            calculatorValue = 'Error';
                        }
                    } else if (value === '=') {
                    if (calculatorOperator) {
                        const current = parseFloat(calculatorValue);
                        const previous = parseFloat(calculatorPreviousValue);
                        let result;
                        switch (calculatorOperator) {
                            case '+': result = previous + current; break;
                            case '-': result = previous - current; break;
                            case '*': result = previous * current; break;
                            case '/': 
                                if (current !== 0) {
                                    result = previous / current;
                                } else {
                                    result = 'Error';
                                }
                                break;
                            default: result = current;
                        }
                        calculatorValue = String(result);
                        calculatorOperator = null;
                        calculatorPreviousValue = '0';
                        calculatorWaitingForOperand = true;
                    }
                } else if (['+', '-', '*', '/'].includes(value)) {
                    if (calculatorOperator && !calculatorWaitingForOperand) {
                        calculatorButtonClick('=');
                    }
                    calculatorPreviousValue = calculatorValue;
                    calculatorOperator = value;
                    calculatorWaitingForOperand = true;
                } else {
                    if (calculatorWaitingForOperand) {
                        calculatorValue = '0';
                        calculatorWaitingForOperand = false;
                    }
                    if (value === '.') {
                        if (!calculatorValue.includes('.')) {
                            calculatorValue += '.';
                        }
                    } else {
                        calculatorValue = calculatorValue === '0' ? value : calculatorValue + value;
                    }
                }
                calculatorDisplay.textContent = calculatorValue;
            }
            
            async function validateUserAccess(name, email, whatsapp) {
                try {
                    const timestamp = new Date().getTime();
                    const freshSheetUrl = GOOGLE_SHEET_URL + '&v=' + timestamp;
                    const freshProxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(freshSheetUrl);
                    
                    const responseCsv = await fetch(freshProxyUrl);
                    const csvText = await responseCsv.text();
                    
                    const rows = csvText.split('\n').map(row => row.split(',').map(c => c.trim()));

                    const cleanEmail = email.trim().toLowerCase();
                    const cleanWhatsapp = whatsapp.trim().replace(/\D/g, '');
                    
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (cols.length < 3) continue;

                        const rowEmail = cols[1] ? cols[1].toLowerCase() : "";
                        const rowWhatsapp = cols[2] ? cols[2].replace(/\D/g, '') : "";
                        
                        if (rowEmail === cleanEmail && rowWhatsapp === cleanWhatsapp) {
                            const status = cols[6] ? cols[6].toUpperCase().replace(/[^A-Z]/g, '') : 'ACTIVO';
                            
                            if (status === 'INACTIVO') {
                                if(loginErrorMessage) {
                                    loginErrorMessage.style.color = "#ff5722";
                                    loginErrorMessage.textContent = "En estos momentos no tienes acceso al banco de preguntas y simulacros, por favor contacta al administrador del curso üò•";
                                }
                                return false;
                            }
                            break;
                        }
                    }

                    const formData = new FormData();
                    formData.append('action', 'login');
                    formData.append('email', email);
                    formData.append('whatsapp', whatsapp);

                    const response = await fetch(RESULTS_SCRIPT_URL, {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow' 
                    });
                    
                    const textResponse = await response.text();
                    
                    let data;
                    try {
                        data = JSON.parse(textResponse);
                    } catch (e) {
                        console.error("Error respuesta servidor:", textResponse);
                        alert("Error t√©cnico al procesar respuesta del servidor.");
                        return false;
                    }
                    
                    if (data.success) {
                        localStorage.setItem('sessionToken', data.token);
                        localStorage.setItem('userEmail', email);
                        
                        if(data.name) currentUser.name = data.name; 
                        
                        startSessionCheck();
                        return true;
                    } else {
                        if(loginErrorMessage) {
                            loginErrorMessage.style.color = "#f87171";
                            loginErrorMessage.textContent = data.message;
                        }
                        return false;
                    }
                } catch (error) {
                    console.error('Error de red o conexi√≥n:', error);
                    alert("Error de conexi√≥n: " + error.message); 
                    return false;
                }
            }
			
            let sessionInterval;

            function startSessionCheck() {
                if (sessionInterval) clearInterval(sessionInterval);

                sessionInterval = setInterval(async () => {
                    const token = localStorage.getItem('sessionToken');
                    const email = localStorage.getItem('userEmail');
                    
                    if (!token || !email) return;

                    try {
                        const formData = new FormData();
                        formData.append('action', 'check_session');
                        formData.append('email', email);
                        formData.append('token', token);

                        const response = await fetch(RESULTS_SCRIPT_URL, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.valid === false) {
                            clearInterval(sessionInterval);
                            alert("‚ö†Ô∏è SE HA DETECTADO UNA NUEVA SESI√ìN.\n\nTu cuenta ha sido abierta en otro dispositivo o navegador.\nEsta sesi√≥n se cerrar√° autom√°ticamente.");
                            window.location.reload();
                        }
                    } catch (e) {
                        console.log("Error verificando sesi√≥n (puede ser red inestable), reintentando luego...");
                    }
                }, 20000);
            }

            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const name = nameInput.value.trim();
                const emailToValidate = emailInput.value.trim();
                const whatsappToValidate = whatsappInput.value.trim();
                loginErrorMessage.textContent = '';
                loginBtnText.classList.add('hidden');
                loginBtnSpinner.classList.remove('hidden');
                loginBtn.disabled = true;
                try {
                    const isValid = await validateUserAccess(name, emailToValidate, whatsappToValidate);
                    if (isValid) {
                        if (!currentUser.name) {
                             currentUser = { name, email: emailToValidate, whatsapp: whatsappToValidate };
                        } else {
                             currentUser.email = emailToValidate;
                             currentUser.whatsapp = whatsappToValidate;
                        }
                        
                        screens.login.classList.add('hidden');
                        screens.setup.classList.remove('hidden');
                        welcomeName.textContent = currentUser.name;
                        if(logoutBtn) logoutBtn.style.display = 'flex';
                        
                        await loadData();
                    } else {
                        loginErrorMessage.textContent = 'Los datos no coinciden. Por favor, verifica tu informaci√≥n.';
                    }
                } catch (error) {
                    loginErrorMessage.textContent = 'Error al conectar con la base de datos. Intenta de nuevo.';
                } finally {
                    loginBtnText.classList.remove('hidden');
                    loginBtnSpinner.classList.add('hidden');
                    loginBtn.disabled = false;
                }
            });
            
            const loadData = async () => {
                try {
                    const response = await fetch(QUIZ_JSON_URL);
                    if (!response.ok) {
                        throw new Error('No se pudo cargar el archivo JSON');
                    }
                    let jsonText = await response.text();
                    jsonText = jsonText.replace(/\\\\\\\\/g, '\\\\');
                    jsonText = jsonText.replace(/\\u00a0/g, ' ');
                    jsonText = jsonText.replace(/,\s*}/g, '}');
                    jsonText = jsonText.replace(/,\s*\]/g, ']');
                    try {
                        allQuestions = JSON.parse(jsonText);
                    } catch (parseError) {
                        console.error('Error al parsear JSON:', parseError.message);
                        allQuestions = [];
                    }
                    
                    // Mostrar informaci√≥n de la evaluaci√≥n
                    totalAvailableQuestions = allQuestions.length;
                    totalEvaluationTime = Math.ceil(totalAvailableQuestions * 1.5 * 60); // En segundos (preguntas * 1.5 minutos)
                    
                    totalQuestionsCount.textContent = totalAvailableQuestions;
                    const minutes = Math.floor(totalEvaluationTime / 60);
                    totalTimeCount.textContent = `${minutes} minutos`;
                    
                    evaluationDetails.classList.remove('hidden');
                } catch (error) {
                    console.error('Error cr√≠tico:', error);
                    startEvaluationBtn.disabled = true;
                }
            };
            
            startEvaluationBtn.addEventListener('click', () => {
                if (confirm("Atenci√≥n: esta actividad tiene temporizador, una vez que inicies, no podr√°s pausarla. ¬øDeseas continuar?")) {
                    startQuiz();
                }
            });

            function startQuiz() {
                currentQuestionIndex = 0;
                seconds = 0;
                totalQuestionTime = 0;
                
                // Usar TODAS las preguntas en el orden del JSON (sin aleatoriedad)
                quizQuestions = [...allQuestions];
                
                userAnswers = quizQuestions.map(q => ({
                    question: q, status: 'unanswered', selected: null, timeSpent: 0
                }));
                
                screens.setup.classList.add('hidden');
                screens.results.classList.add('hidden');
                screens.quiz.classList.remove('hidden');
                
                timerContainer.style.display = 'flex';
                document.getElementById('live-score').style.display = 'flex';
                
                // Iniciar temporizador de evaluaci√≥n
                clearInterval(evaluationTimer);
                timeLeft = totalEvaluationTime;
                updateEvaluationTimerDisplay();
                
                evaluationTimer = setInterval(() => {
                    timeLeft--;
                    updateEvaluationTimerDisplay();
                    if (timeLeft <= 0) {
                        clearInterval(evaluationTimer);
                        endQuiz();
                    }
                }, 1000);
                
                questionStartTime = Date.now();
                displayQuestion();
                updateLiveScore();
                startEvaluateEmojiAnimation();
                document.getElementById('action-buttons').classList.remove('hidden');
            }
            
            function updateEvaluationTimerDisplay() {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                // Cambiar color seg√∫n tiempo restante
                timerDisplay.classList.remove('timer-green', 'timer-orange', 'timer-red');
                if (minutes > 10) {
                    timerDisplay.classList.add('timer-green');
                } else if (minutes > 5) {
                    timerDisplay.classList.add('timer-orange');
                } else {
                    timerDisplay.classList.add('timer-red');
                }
            }

            function displayQuestion() {
                const currentAnswer = userAnswers[currentQuestionIndex];
                const { question } = currentAnswer;
                justificationBox.classList.add('hidden');
                justificationText.innerHTML = '';
                
                // Actualizar progreso
                const answeredCount = userAnswers.filter(a => a.status !== 'unanswered').length;
                const totalQuestionsInQuiz = quizQuestions.length;
                const progressPercentage = totalQuestionsInQuiz > 0 ?
                    (answeredCount / totalQuestionsInQuiz) * 100 : 0;
                progressBar.style.width = `${progressPercentage}%`;
                
                totalQuestionsNum.textContent = quizQuestions.length;
                currentQuestionNum.textContent = currentQuestionIndex + 1;
                
                questionIdDisplay.textContent = question.id || 'N/A';
                uniTagsDisplay.innerHTML = (question.uni_tags || []).map(t => `<span class="uni-tag-display">${t}</span>`).join(' ');
                levelTagDisplay.innerHTML = (question.level_tag || []).map(t => `<span class="level-tag-display">${t}</span>`).join(' ');
                let questionHTML = question.question;
                questionText.innerHTML = questionHTML;
                questionStartTime = Date.now();
                if (question.explanative_video) {
                    const videoId = getYouTubeID(question.explanative_video);
                    if (videoId) {
                        videoIframe.src = `https://www.youtube.com/embed/${videoId}`;
                        videoContainer.style.display = 'block';
                        videoContent.classList.add('hidden');
                        videoToggle.querySelector('.fa-chevron-down, .fa-chevron-up').classList.replace('fa-chevron-up', 'fa-chevron-down');
                    } else {
                        videoContainer.style.display = 'none';
                    }
                } else {
                    videoContainer.style.display = 'none';
                }
                if (question.image) {
                    imageSectionContainer.classList.remove('hidden');
                    imageContent.classList.remove('hidden');
                    imageToggle.querySelector('.fa-chevron-down, .fa-chevron-up').classList.replace('fa-chevron-down', 'fa-chevron-up');
                    imageContainer.style.backgroundImage = `url(${question.image})`;
                    if (question.image.includes('imgur.com')) {
                        const watermarkText = `${currentUser.name} ${currentUser.email} ${currentUser.whatsapp} &nbsp; `.repeat(150);
                        watermarkOverlay.innerHTML = watermarkText;
                    } else {
                        watermarkOverlay.innerHTML = '';
                    }
                } else {
                    imageSectionContainer.classList.add('hidden');
                }
                if (question.collapsible_text) {
                    textSectionContainer.classList.remove('hidden');
                    let processedText = question.collapsible_text || '';
                    const urlRegex = /(https?:\/\/[^\s<]+)/g;
                    processedText = processedText.replace(urlRegex, function(url) {
                        return '<a href="' + url + '" target="_blank" class="text-blue-400 underline break-all" style="position: relative; z-index: 50;">' + url + '</a>';
                    });
                    textContent.innerHTML = processedText;
                    textContent.classList.add('hidden');
                    textToggle.querySelector('.fa-chevron-down, .fa-chevron-up').classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    textSectionContainer.classList.add('hidden');
                }
                optionsContainer.innerHTML = '';
                
                // DETECCI√ìN DE FORMATO H√çBRIDO
                const isHybrid = question.options.some(opt => 'text_op1' in opt);

                if (isHybrid) {
                    optionsContainer.className = 'hybrid-container';
                    
                    // Separar opciones
                    let group1 = question.options.filter(o => 'text_op1' in o).map(o => ({ text: o.text_op1, correct: o.correct, group: 1 }));
                    let group2 = question.options.filter(o => 'text_op2' in o).map(o => ({ text: o.text_op2, correct: o.correct, group: 2 }));
                    
                    // Agregar opci√≥n de salida a ambos
                    const noIdObj = { text: "No puedo identificar la respuesta üò•", correct: false, isNoId: true };
                    group1.push({...noIdObj, group: 1});
                    group2.push({...noIdObj, group: 2});

                    // NO mezclar - mantener orden original
                    const keepOrder = (arr) => {
                        let mainOpts = arr.filter(o => !o.isNoId);
                        let lastOpt = arr.find(o => o.isNoId);
                        if(lastOpt) mainOpts.push(lastOpt);
                        return mainOpts;
                    };

                    // --- L√ìGICA DE RECUPERACI√ìN DE RESPUESTA ERR√ìNEA (H√çBRIDO) ---
                    let prevSel1 = null;
                    let prevSel2 = null;
                    // Si la pregunta ya fue respondida, intentamos recuperar qu√© eligi√≥ el estudiante
                    if (userAnswers[currentQuestionIndex].status !== 'unanswered') {
                        const selText = userAnswers[currentQuestionIndex].selected; 
                        if (selText && selText.includes('|')) {
                            const parts = selText.split('|');
                            if(parts.length >= 2) {
                                prevSel1 = parts[0].substring(parts[0].indexOf(':') + 1).trim();
                                prevSel2 = parts[1].substring(parts[1].indexOf(':') + 1).trim();
                            }
                        }
                    }
                    // -------------------------------------------------------------

                    const renderGroup = (opts, groupNum) => {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'hybrid-group';
                        colDiv.innerHTML = `<div class="hybrid-group-title">Columna ${groupNum}</div>`;
                        
                        opts.forEach((opt, idx) => {
                            const btn = document.createElement('button');
                            btn.className = 'option-btn';
                            btn.dataset.text = opt.text;
                            btn.dataset.group = groupNum;
                            btn.style.fontSize = '0.9rem';

                            // APLICAR SELECCI√ìN PREVIA
                            if (groupNum === 1 && opt.text === prevSel1) btn.classList.add('selected');
                            if (groupNum === 2 && opt.text === prevSel2) btn.classList.add('selected');

                            const letter = document.createElement('div');
                            letter.className = 'option-letter';
                            
                            // Letras: Columna 1 (A,B,C,D,E), Columna 2 (F,G,H,I,J)
                            const letterCode = groupNum === 1 ? (65 + idx) : (70 + idx); 
                            
                            if (opt.isNoId) {
                                letter.style.display = 'none';
                                btn.style.paddingLeft = '15px';
                            } else {
                                letter.textContent = String.fromCharCode(letterCode);
                            }
                            
                            btn.appendChild(letter);
                            const span = document.createElement('span');
                            span.innerHTML = opt.text;
                            btn.appendChild(span);

                            // Evento Click H√≠brido
                            btn.addEventListener('click', () => {
                                if (userAnswers[currentQuestionIndex].status !== 'unanswered') return;

                                // Deseleccionar otros de este grupo
                                colDiv.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                                btn.classList.add('selected');

                                // Verificar si ambos grupos tienen selecci√≥n para activar bot√≥n evaluar
                                const g1Selected = optionsContainer.querySelector('.option-btn[data-group="1"].selected');
                                const g2Selected = optionsContainer.querySelector('.option-btn[data-group="2"].selected');
                                
                                evaluateBtn.disabled = !(g1Selected && g2Selected);
                            });

                            colDiv.appendChild(btn);
                        });
                        return colDiv;
                    };

                    optionsContainer.appendChild(renderGroup(keepOrder(group1), 1));
                    optionsContainer.appendChild(renderGroup(keepOrder(group2), 2));

                } else {
                    // --- L√ìGICA EST√ÅNDAR (FORMATO ACTUAL) ---
                    let options = [...question.options];
                    options.push({ text: "No puedo identificar la respuesta üò•", correct: false });
                    
                    // NO mezclar - mantener orden original
                    let orderedOptions = options.filter(opt => !opt.text.includes('No puedo identificar'));
                    const noIdOption = options.find(opt => opt.text.includes('No puedo identificar'));
                    if(noIdOption) orderedOptions.push(noIdOption);

                    const hasImages = orderedOptions.some(opt => isImageOption(opt.text));

                    if (hasImages) {
                        optionsContainer.className = 'w-full options-grid-mode';
                    } else {
                        optionsContainer.className = 'w-full space-y-3';
                    }

                    orderedOptions.forEach((option, index) => {
                        const isNoId = option.text.includes('No puedo identificar');
                        const isImg = isImageOption(option.text);
                        const button = document.createElement('button');
                        const letterElement = document.createElement('div');
                        
                        letterElement.className = 'option-letter';
                        button.className = 'option-btn';
                        
                        if (isImg) button.classList.add('is-image');
                        if (isNoId && hasImages) button.classList.add('full-width');

                        if (isNoId) {
                            letterElement.style.display = 'none';
                            if (!hasImages) button.style.paddingLeft = '15px';
                        } else {
                            letterElement.textContent = String.fromCharCode(65 + index);
                        }

                        button.appendChild(letterElement);

                        if (isImg) {
                            const img = document.createElement('img');
                            img.src = option.text;
                            img.className = 'option-image-content';
                            button.appendChild(img);
                             if (option.text.includes('imgur.com')) {
                                const watermark = document.createElement('div');
                                watermark.className = 'option-watermark';
                                watermark.textContent = (currentUser.name + ' CEPREDIX ').repeat(50);
                                button.appendChild(watermark);
                            }
                        } else {
                            const textSpan = document.createElement('span');
                            textSpan.innerHTML = option.text;
                            button.appendChild(textSpan);
                        }

                        button.dataset.text = option.text;
                        
                        // Triple clic logic standard
                        let clickCount = 0;
                        let clickTimer = null;

                        button.addEventListener('click', () => {
                            if (currentAnswer.status === 'unanswered') {
                                document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                                button.classList.add('selected');
                                evaluateBtn.disabled = false;

                                clickCount++;
                                if (clickTimer) clearTimeout(clickTimer);
                                if (clickCount === 3) {
                                    clickCount = 0;
                                    evaluateCurrentAnswer();
                                } else {
                                    clickTimer = setTimeout(() => { clickCount = 0; }, 400);
                                }
                            }
                        });
                        optionsContainer.appendChild(button);
                    });
                }
                setTimeout(() => {
                    MathJax.typesetPromise([questionText, optionsContainer, textContent]).then(() => {
                    }).catch((err) => console.log('Error renderizando formulas:', err));
                }, 50);
                
                updateButtonStates();
                if (currentAnswer.status !== 'unanswered') {
                    showFeedback();
                } else {
                    startEvaluateEmojiAnimation();
                }
                evaluateBtn.disabled = true;
            }

            function isImageOption(text) {
                if (typeof text !== 'string') return false;
                return text.match(/\.(jpeg|jpg|gif|png|webp)$/i) != null;
            }

            function getYouTubeID(url) {
                if (!url) return null;
                url = url.trim(); 
                const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regExp);
                if (!match) {
                     const fallbackMatch = url.match(/([a-zA-Z0-9_-]{11})/);
                     return fallbackMatch ? fallbackMatch[1] : null;
                }
                return match[1];
            }
            
           function updateButtonStates() {
                const isAnswered = userAnswers[currentQuestionIndex].status !== 'unanswered';
                const isLastQuestion = currentQuestionIndex === userAnswers.length - 1;
                
                // Actualizar estado de botones principales
                prevBtn.disabled = currentQuestionIndex === 0;
                
                if (isAnswered) {
                    nextBtn.disabled = false;
                    evaluateBtn.disabled = true;
                    stopEvaluateEmojiAnimation();
                    if (isLastQuestion) {
                        nextBtn.textContent = 'VER RESULTADOS';
                    } else {
                        nextBtn.textContent = 'SIGUIENTE ‚Üí';
                    }
                } else {
                    nextBtn.disabled = true;
                }

                // --- L√ìGICA PARA FLECHAS MINI ---
                if (miniPrevBtn) {
                    miniPrevBtn.disabled = prevBtn.disabled;
                    miniPrevBtn.onclick = () => prevBtn.click();
                }
                if (miniNextBtn) {
                    miniNextBtn.disabled = nextBtn.disabled;
                    miniNextBtn.onclick = () => nextBtn.click();
                }
            }

           function showFeedback() {
                const { question, selected, status } = userAnswers[currentQuestionIndex];
                const isHybrid = question.options.some(opt => 'text_op1' in opt);

                if (isHybrid) {
                    const correctOp1 = question.options.find(o => 'text_op1' in o && o.correct)?.text_op1;
                    const correctOp2 = question.options.find(o => 'text_op2' in o && o.correct)?.text_op2;
                    
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        const txt = btn.dataset.text;
                        const group = btn.dataset.group;
                        const isSelected = btn.classList.contains('selected');

                        // Colorear Correctas
                        if ((group === "1" && txt === correctOp1) || (group === "2" && txt === correctOp2)) {
                            btn.classList.add('correct');
                        }
                        
                        // Colorear Incorrectas Seleccionadas
                        if (isSelected && status !== 'correct') {
                             if (!((group === "1" && txt === correctOp1) || (group === "2" && txt === correctOp2))) {
                                 btn.classList.add('incorrect');
                             }
                        }
                    });

                } else {
                    const correctOption = question.options.find(opt => opt.correct)?.text || null;
                    const userSelectedText = userAnswers[currentQuestionIndex].selected;

                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        
                        // 1. Marcar siempre la correcta en verde
                        if (btn.dataset.text === correctOption) btn.classList.add('correct');
                        
                        // 2. Verificar si este es el bot√≥n que el usuario presion√≥ previamente
                        if (btn.dataset.text === userSelectedText) {
                            btn.classList.add('selected');
                            if (status === 'incorrect' || status === 'unidentified') {
                                if (btn.dataset.text !== correctOption) {
                                    btn.classList.add('incorrect');
                                }
                            }
                        }
                    });
                }

                if (question.explanation) {
                    justificationText.innerHTML = question.explanation;
                    justificationBox.classList.remove('hidden');
                    MathJax.typesetPromise([justificationText]);
                }
            }
            
            if (evaluateBtn) {
                evaluateBtn.addEventListener('click', evaluateCurrentAnswer);
            }
            
            prevBtn.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    questionStartTime = Date.now();
                    displayQuestion();
                }
            });
            
            nextBtn.addEventListener('click', () => {
                if (currentQuestionIndex < userAnswers.length - 1) {
                    currentQuestionIndex++;
                    questionStartTime = Date.now();
                    displayQuestion();
                } else {
                    endQuiz();
                }
            });
            
            skipBtn.addEventListener('click', () => {
                const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
                totalQuestionTime += timeSpent;
                userAnswers[currentQuestionIndex].timeSpent = timeSpent;
                userAnswers[currentQuestionIndex].status = 'omitted';
                updateLiveScore();
                
                if (currentQuestionIndex < userAnswers.length - 1) {
                    currentQuestionIndex++;
                    questionStartTime = Date.now();
                    displayQuestion();
                } else {
                    endQuiz();
                }
            });
            
            cancelBtn.addEventListener('click', () => {
                clearInterval(evaluationTimer);
                
                screens.quiz.classList.add('hidden');
                screens.setup.classList.remove('hidden');
                if(logoutBtn) logoutBtn.style.display = 'flex';
                
                correctSound.pause();
                incorrectSound.pause();
                buttonSound.pause();
                sadViolinSound.pause();
                simulacroFail1.pause();
                simulacroFail2.pause();
                simulacroSuccess1.pause();
                simulacroSuccess2.pause();
            });
            
            finishBtn.addEventListener('click', () => endQuiz());
            
            hintBtn.addEventListener('click', () => {
                const question = userAnswers[currentQuestionIndex].question;
                const modalElement = document.createElement('div');
                modalElement.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[1001]";
                modalElement.innerHTML = `
                    <div class="card w-full max-w-lg relative">
                        <button class="absolute top-2 right-4 text-3xl font-bold text-gray-500 hover:text-white close-modal-btn">&times;</button>
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-4">Pista</h3>
                            <div class="text-gray-300 max-h-[60vh] overflow-y-auto hint-content">
                                ${question.hint || "No hay una pista disponible para esta pregunta."}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalElement);
                modalElement.querySelector('.close-modal-btn').addEventListener('click', () => {
                    modalElement.remove();
                });
                MathJax.typesetPromise([modalElement.querySelector('.hint-content')]);
            });
            
            function updateLiveScore() {
                const correct = userAnswers.filter(a => a.status === 'correct').length;
                const incorrect = userAnswers.filter(a => a.status === 'incorrect').length;
                liveCorrect.textContent = correct;
                liveIncorrect.textContent = incorrect;
            }
            
            async function submitResults(stats, score, totalTime, idsString, numQuestions) {
                const formData = new FormData();
                
                formData.append('EvaluationName', "PRUEBA (Global)"); 
                
                formData.append('Name', currentUser.name || '');
                formData.append('Email', currentUser.email || '');
                formData.append('WhatsApp', currentUser.whatsapp || '');
                formData.append('TotalTime', totalTime);
                formData.append('AverageTime', numQuestions > 0 ? (totalTime / numQuestions).toFixed(2) : 0);
                formData.append('Score', score.toFixed(2));
                formData.append('CorrectAnswers', stats.correct);
                formData.append('TotalQuestions', numQuestions);
                formData.append('IDs', idsString);
                
                formData.append('UserType', 'Registrado');

                try {
                    await fetch(SUBMISSION_SCRIPT_URL, { method: 'POST', body: formData });
                    console.log("Resultados enviados con √©xito al script de respaldo.");
                } catch (error) {
                    console.error("Error al enviar los resultados:", error);
                }
            }            
            function endQuiz() {
                clearInterval(evaluationTimer);
                
                screens.quiz.classList.add('hidden');
                screens.results.classList.remove('hidden');
                let answersToEvaluate = userAnswers;
                if (userAnswers.filter(a => a.status !== 'unanswered').length < userAnswers.length) {
                    answersToEvaluate = userAnswers.filter(a => a.status !== 'unanswered');
                    if (answersToEvaluate.length === 0) {
                        showTemporaryMessage("No has respondido ninguna pregunta. Volviendo al men√∫.");
                        screens.results.classList.add('hidden');
                        screens.setup.classList.remove('hidden');
                        return;
                    }
                }
                const stats = {
                    correct: answersToEvaluate.filter(a => a.status === 'correct').length,
                    incorrect: answersToEvaluate.filter(a => a.status === 'incorrect').length,
                    omitted: answersToEvaluate.filter(a => a.status === 'omitted').length,
                    unidentified: answersToEvaluate.filter(a => a.status === 'unidentified').length
                };
                const totalEvaluated = stats.correct + stats.incorrect + stats.unidentified;
                const finalScoreValue = totalEvaluated > 0 ? (stats.correct / totalEvaluated) * 10 : 0;
                const totalTimeEvaluated = answersToEvaluate.reduce((acc, curr) => acc + curr.timeSpent, 0);
                const averageTime = answersToEvaluate.length > 0 ? (totalTimeEvaluated / answersToEvaluate.length).toFixed(2) : 0;
                const idsString = answersToEvaluate.map(a => a.question.id).filter(id => id).join(', ');
                finalScore.textContent = `${finalScoreValue.toFixed(2)} / 10.00`;
                totalTime.textContent = `${totalTimeEvaluated} segundos`;
                avgTime.textContent = `${averageTime} seg por pregunta`;
                correctCount.textContent = stats.correct;
                incorrectCount.textContent = stats.incorrect;
                omittedCount.textContent = stats.omitted;
                unansweredCount.textContent = stats.unidentified;
                if (finalScoreValue === 10) resultImage.src = RESULT_IMAGES.perfect10;
                else if (finalScoreValue >= 9.5) resultImage.src = RESULT_IMAGES.between9_5_10;
                else if (finalScoreValue >= 9) resultImage.src = RESULT_IMAGES.between9_9_5;
                else if (finalScoreValue >= 8) resultImage.src = RESULT_IMAGES.between8_9;
                else if (finalScoreValue >= 7) resultImage.src = RESULT_IMAGES.between7_8;
                else resultImage.src = RESULT_IMAGES.less7;
                
                submitResults(stats, finalScoreValue, totalTimeEvaluated, idsString, answersToEvaluate.length);
                
                populateResultsTable(answersToEvaluate);
                drawResultsChart(stats);
                const allAnsweredIds = generateAnsweredIdsList();
                populateSummaryBox(finalScoreValue, idsString, allAnsweredIds);
                
                copyIdsBtn.disabled = false;
                copyIdsBtn.classList.remove('btn-disabled');
            }
            
            function showTemporaryMessage(message, bgColor = "bg-blue-600") {
                const tempMessage = document.createElement('div');
                tempMessage.className = `fixed top-1/4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50`;
                tempMessage.style.maxWidth = "80%";
                tempMessage.textContent = message;
                document.body.appendChild(tempMessage);
                setTimeout(() => {
                    if (document.body.contains(tempMessage)) {
                        document.body.removeChild(tempMessage);
                    }
                }, 2000);
            }
            
            function populateResultsTable(answers) {
                resultsTableBody.innerHTML = '';
                answers.forEach(answer => {
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-700 border-b border-gray-600';
                    const correctOption = answer.question.options.find(o => o.correct);
                    const correctText = correctOption ? correctOption.text : 'N/A';
                    let resultText, resultClass;
                    switch(answer.status) {
                        case 'correct': resultText = 'Correcta'; resultClass = 'text-green-400 font-bold'; break;
                        case 'incorrect': resultText = 'Incorrecta'; resultClass = 'text-red-400 font-bold'; break;
                        case 'omitted': resultText = 'Omitida'; resultClass = 'text-gray-400 font-bold'; break;
                        case 'unidentified': resultText = 'No Identificada'; resultClass = 'text-yellow-400 font-bold'; break;
                        default: resultText = 'No contestada'; resultClass = 'text-gray-400 font-bold';
                    }
                    row.innerHTML = `
                        <td class="px-4 py-2">${answer.question.id || 'N/A'}</td>
                        <td class="px-4 py-2">${answer.question.question}</td>
                        <td class="px-4 py-2">${answer.selected || '---'}</td>
                        <td class="px-4 py-2">${correctText}</td>
                        <td class="px-4 py-2 ${resultClass}">${resultText}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
                MathJax.typesetPromise([resultsTableBody]);
            }
            
            function populateSummaryBox(score, idsString, allAnsweredIds) {
                summaryEvalName.textContent = "PRUEBA (Global)";
                summaryDate.textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                summaryScore.textContent = `${score.toFixed(2)} / 10.00`;
                summaryIds.textContent = idsString;
                summaryIdsAcumulados.textContent = allAnsweredIds;
            }
            
            function generateAnsweredIdsList() {
                const correctIds = userAnswers
                    .filter(a => a.status === 'correct' && a.question.id)
                    .map(a => a.question.id);
                const sortedIds = [...correctIds].sort();
                const idsString = sortedIds.join(', ');
                answeredIdsOutput.value = idsString;
                return idsString;
            }
            
            copyIdsBtn.addEventListener('click', () => {
                answeredIdsOutput.select();
                document.execCommand('copy');
                copyIdsBtn.textContent = '¬°Copiado!';
                setTimeout(() => { copyIdsBtn.textContent = 'Copiar'; }, 2000);
            });
            
            function drawResultsChart(stats) {
                if (resultsChart) resultsChart.destroy();
                resultsChart = new Chart(resultsChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: ['Correctas', 'Incorrectas', 'Omitidas', 'No identificadas'],
                        datasets: [{
                            data: [stats.correct, stats.incorrect, stats.omitted, stats.unidentified],
                            backgroundColor: ['#10b981', '#ef4444', '#6b7280', '#f59e0b'],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: { color: '#fff' }
                            } 
                        } 
                    }
                });
            }
            
            restartQuizBtn.addEventListener('click', () => {
                screens.results.classList.add('hidden');
                screens.setup.classList.remove('hidden');
                copyIdsBtn.disabled = false;
                copyIdsBtn.classList.remove('btn-disabled');
            });
            
            loadData();
            initializeVolumes();

            const wbTriggerBtn = document.getElementById('whiteboard-trigger-btn');
            const wbOverlay = document.getElementById('overlay-whiteboard');
            const wbCanvas = document.getElementById('wb-canvas');
            const wbCloseBtn = document.getElementById('wb-close-btn');
            const wbCtx = wbCanvas ? wbCanvas.getContext('2d') : null;
            
            let wbIsDrawing = false;
            let wbHistory = [];
            let wbStep = -1;
            let wbCurrentColor = '#ffffff';
            let wbCurrentWidth = 2;

            // Ajustar tama√±o del canvas al abrir
            function resizeWbCanvas() {
                if(!wbCanvas) return;
                wbCanvas.width = window.innerWidth;
                wbCanvas.height = window.innerHeight;
                // Restaurar imagen si existe historial
                if (wbStep >= 0) {
                    const img = new Image();
                    img.src = wbHistory[wbStep];
                    img.onload = () => wbCtx.drawImage(img, 0, 0);
                }
                // Reconfigurar contexto
                wbCtx.lineCap = 'round';
                wbCtx.lineJoin = 'round';
                wbCtx.strokeStyle = wbCurrentColor;
                wbCtx.lineWidth = wbCurrentWidth;
            }

            // Guardar estado para deshacer
            function wbSaveState() {
                if (wbStep < wbHistory.length - 1) {
                    wbHistory = wbHistory.slice(0, wbStep + 1);
                }
                wbHistory.push(wbCanvas.toDataURL());
                wbStep++;
            }

            if (wbOverlay) {
                // Funci√≥n unificada para abrir pizarra
                const openWhiteboard = () => {
                    wbOverlay.classList.remove('hidden');
                    resizeWbCanvas();
                    if (wbStep === -1) wbSaveState();
                };

                // Abrir Pizarra desde el Quiz
                if (wbTriggerBtn) {
                    wbTriggerBtn.addEventListener('click', openWhiteboard);
                }

                // Cerrar Pizarra
                wbCloseBtn.addEventListener('click', () => {
                    wbOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto';
                });

                // Eventos de Dibujo (Rat√≥n y T√°ctil)
                const getWbPos = (e) => {
                    const rect = wbCanvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: clientX - rect.left, y: clientY - rect.top };
                };

                const startWbDraw = (e) => {
                    wbIsDrawing = true;
                    wbCtx.beginPath();
                    const pos = getWbPos(e);
                    wbCtx.moveTo(pos.x, pos.y);
                    if(e.type === 'touchstart') e.preventDefault(); 
                };

                const moveWbDraw = (e) => {
                    if (!wbIsDrawing) return;
                    const pos = getWbPos(e);
                    wbCtx.lineTo(pos.x, pos.y);
                    wbCtx.stroke();
                    if(e.type === 'touchmove') e.preventDefault();
                };

                const endWbDraw = (e) => {
                    if (wbIsDrawing) {
                        wbCtx.closePath();
                        wbIsDrawing = false;
                        wbSaveState();
                    }
                };

                wbCanvas.addEventListener('mousedown', startWbDraw);
                wbCanvas.addEventListener('mousemove', moveWbDraw);
                wbCanvas.addEventListener('mouseup', endWbDraw);
                wbCanvas.addEventListener('mouseout', endWbDraw);
                
                wbCanvas.addEventListener('touchstart', startWbDraw, { passive: false });
                wbCanvas.addEventListener('touchmove', moveWbDraw, { passive: false });
                wbCanvas.addEventListener('touchend', endWbDraw);

                // Control del Slider de Grosor
                const wbWidthSlider = document.getElementById('wb-width-slider');
                if(wbWidthSlider) {
                    wbWidthSlider.addEventListener('input', (e) => {
                        wbCurrentWidth = parseInt(e.target.value);
                        wbCtx.lineWidth = wbCurrentWidth;
                    });
                }

                // Herramientas: Colores Fijos
                document.querySelectorAll('.wb-tool-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        wbCurrentColor = e.target.dataset.color;
                        wbCtx.globalCompositeOperation = 'source-over';
                        wbCtx.strokeStyle = wbCurrentColor;
                        wbCtx.lineWidth = wbCurrentWidth;
                    });
                });

                // Herramienta: Color Personalizable (Rojo por defecto)
                const customPicker = document.getElementById('wb-custom-color-picker');
                const customPreview = document.getElementById('wb-custom-preview');
                
                if (customPicker && customPreview) {
                    customPicker.addEventListener('input', (e) => {
                        wbCurrentColor = e.target.value;
                        wbCtx.globalCompositeOperation = 'source-over';
                        wbCtx.strokeStyle = wbCurrentColor;
                        wbCtx.lineWidth = wbCurrentWidth;
                        customPreview.style.backgroundColor = wbCurrentColor;
                        customPreview.parentElement.style.boxShadow = `0 0 10px ${wbCurrentColor}`;
                    });

                    customPicker.addEventListener('click', () => {
                         wbCurrentColor = customPicker.value;
                         wbCtx.globalCompositeOperation = 'source-over';
                         wbCtx.strokeStyle = wbCurrentColor;
                    });
                }

                // L√≥gica de los Botones de Scroll
                const btnScrollUp = document.getElementById('wb-scroll-up');
                const btnScrollDown = document.getElementById('wb-scroll-down');
                const scrollAmount = 300;

                if (btnScrollUp) {
                    btnScrollUp.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.scrollBy({ top: -scrollAmount, behavior: 'smooth' });
                    });
                }

                if (btnScrollDown) {
                    btnScrollDown.addEventListener('click', (e) => {
                        e.stopPropagation();
                        window.scrollBy({ top: scrollAmount, behavior: 'smooth' });
                    });
                }

                // Herramienta: Borrador
                document.getElementById('wb-eraser-btn').addEventListener('click', () => {
                    wbCurrentWidth = 10;
                    wbCtx.lineWidth = wbCurrentWidth;
                    wbCtx.globalCompositeOperation = 'destination-out';
                    
                    const slider = document.getElementById('wb-width-slider');
                    if(slider) slider.value = 10;
                });

                document.getElementById('wb-clear-btn').addEventListener('click', () => {
                    wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
                    wbSaveState();
                });

                document.getElementById('wb-undo-btn').addEventListener('click', () => {
                    if (wbStep > 0) {
                        wbStep--;
                        const img = new Image();
                        img.src = wbHistory[wbStep];
                        img.onload = () => {
                            wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
                            wbCtx.globalCompositeOperation = 'source-over';
                            wbCtx.drawImage(img, 0, 0);
                            wbCtx.globalCompositeOperation = wbCurrentWidth === 20 ? 'destination-out' : 'source-over';
                        };
                    }
                });

                document.getElementById('wb-redo-btn').addEventListener('click', () => {
                    if (wbStep < wbHistory.length - 1) {
                        wbStep++;
                        const img = new Image();
                        img.src = wbHistory[wbStep];
                        img.onload = () => {
                            wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
                            wbCtx.globalCompositeOperation = 'source-over';
                            wbCtx.drawImage(img, 0, 0);
                            wbCtx.globalCompositeOperation = wbCurrentWidth === 20 ? 'destination-out' : 'source-over';
                        };
                    }
                });
                
                window.addEventListener('resize', () => {
                    if(!wbOverlay.classList.contains('hidden')) {
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = wbCanvas.width;
                        tempCanvas.height = wbCanvas.height;
                        tempCanvas.getContext('2d').drawImage(wbCanvas, 0, 0);
                        
                        wbCanvas.width = window.innerWidth;
                        wbCanvas.height = window.innerHeight;
                        
                        wbCtx.lineCap = 'round';
                        wbCtx.lineJoin = 'round';
                        wbCtx.strokeStyle = wbCurrentColor;
                        wbCtx.lineWidth = wbCurrentWidth;
                        
                        wbCtx.drawImage(tempCanvas, 0, 0);
                    }
                });
            }
        });
    </script>
</body>
</html>
