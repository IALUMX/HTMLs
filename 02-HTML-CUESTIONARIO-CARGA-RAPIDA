<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PRUEBA (Global)</title>
    <link rel="icon" href="https://raw.githubusercontent.com/IALUMX/img_cepredix/main/00-WEBLogo-circular-cepredix.png" type="image/png">
    
    <meta property="og:image" content="https://raw.githubusercontent.com/IALUMX/img_cepredix/main/Thumbnail-CEP-HTML.png">
    <meta property="og:image:secure_url" content="https://raw.githubusercontent.com/IALUMX/img_cepredix/main/Thumbnail-CEP-HTML.png">
    <meta property="og:image:type" content="image/png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <meta property="og:title" content="PRUEBA (Global) - CEPREDIX">
    <meta property="og:description" content="Plataforma de evaluación educativa.">
    <meta property="og:type" content="website">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                packages: ['base', 'ams', 'physics']
            },
            svg: {
                fontCache: 'global'
            },
            loader: {load: ['[tex]/physics']}
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-image: url('https://i.imgur.com/7ndIyWP.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: #fff;
            padding: 15px;
            position: relative;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        body::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.6); z-index: -1;
        }
        .container {
            width: 100%; max-width: 1200px; margin: 0 auto;
            display: flex; flex-direction: column;            
        }
        .header {
            text-align: center; padding: 15px; border-radius: 15px; margin-bottom: 20px;
            background: linear-gradient(45deg, #0d47a1, #00695c, #ff6f00, #b71c1c, #4a148c);
            background-size: 400% 400%; animation: gradientBG 15s ease infinite;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; overflow: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .logo {
            width: 100px; height: 100px; margin: 0 auto 10px;
            background: url('https://i.imgur.com/I1unSiu.png') center/contain no-repeat;
        }
        .logout-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 20;
            font-size: 1rem;
        }
        .logout-btn:hover {
            background: rgba(244, 67, 54, 0.8);
            border-color: #f44336;
            transform: scale(1.1);
        }
        .card {
            background: rgba(25, 25, 35, 0.85); backdrop-filter: blur(10px);
            border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.4);
            width: 100%; margin-bottom: 20px; position: relative;
        }
        .btn {
            padding: 10px 20px; font-size: 1.1rem; border: none; border-radius: 50px;
            cursor: pointer; transition: all 0.3s ease; font-weight: 600;
            text-transform: uppercase; letter-spacing: 1px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); margin: 8px;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: linear-gradient(45deg, #2196F3, #21CBF3); color: white; }
        .btn-secondary { background: linear-gradient(45deg, #f44336, #ff9800); color: white; }
        .btn-hint { background: linear-gradient(45deg, #FFC107, #FF9800); color: white; }
        .btn-correct { background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white; }
        .btn-incorrect { background: linear-gradient(45deg, #f44336, #ff5722); color: white; }
        .btn-disabled, .btn:disabled {
            background: #9e9e9e; cursor: not-allowed; transform: none !important;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
        }
        .btn:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.4); }
        .btn:active:not(:disabled) { transform: translateY(1px); }
        .question-container {
            margin: 15px 0 20px; padding: 20px; background: rgba(30, 30, 40, 0.8);
            border-radius: 15px; border-left: 5px solid #4fc3f7; position: relative;
        }
        .question-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; justify-content: center; }
        .tag {
            background: rgba(79, 195, 247, 0.2); padding: 4px 10px; border-radius: 15px;
            font-size: 0.8rem; border: 1px solid #4fc3f7; cursor: pointer; transition: all 0.2s ease;
        }
        .tag.selected { background: rgba(79, 195, 247, 0.8); color: white; font-weight: bold; transform: scale(1.05); }
        .option-btn {
            padding: 15px 15px 15px 50px; background: rgba(50, 50, 70, 0.8);
            border-radius: 10px; cursor: pointer; transition: all 0.3s ease;
            font-size: 1.1rem; border: 2px solid transparent; text-align: left;
            position: relative; width: 100%; margin-bottom: 12px; display: flex; align-items: center;
        }
        .option-btn:hover:not([disabled]) { background: rgba(70, 70, 90, 0.9); transform: translateY(-2px); }
        .option-btn.selected { filter: brightness(0.7); border-color: #ff9800; box-shadow: 0 0 0 2px #ff9800; }
        .option-btn.correct {
            background: linear-gradient(45deg, #4CAF50, #8BC34A) !important; color: white !important;
            transform: scale(1.01); box-shadow: 0 0 10px rgba(76, 175, 80, 0.6);
        }
        .option-btn.incorrect {
            background: linear-gradient(45deg, #f44336, #ff5722) !important; color: white !important;
            animation: shake 0.5s;
        }
        .option-letter {
            position: absolute; left: 15px; top: 50%; transform: translateY(-50%);
            width: 25px; height: 25px; background: rgba(79, 195, 247, 0.3);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold; margin-right: 10px;
        }
        .justification {
            background: rgba(40, 40, 50, 0.9); border-radius: 10px; padding: 15px;
            margin-top: 20px; text-align: left; border-left: 4px solid #4fc3f7;
            overflow-x: auto; /* Agrega scroll horizontal si es necesario */
            word-wrap: break-word; /* Rompe palabras largas */
        }
        .justification h4 { color: #4fc3f7; margin-bottom: 8px; font-size: 1.2rem; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .timer-green { color: #4CAF50; }
        .timer-orange { color: #FF9800; }
        .timer-red { color: #f44336; }
        #discrete-timer-wrapper {
            margin-top: -0.5rem;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 30;
        }
        #dt-tab {
            width: 50px;
            height: 20px;
            background: rgba(30, 30, 40, 0.9);
            margin: 0 auto;
            border-radius: 10px 10px 0 0;
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s;
        }
        #dt-tab:hover { background: rgba(50, 50, 70, 1); }
        #dt-bar {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 10px;
            background: rgba(20, 20, 30, 0.95);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.3);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            max-height: 500px;
            opacity: 1;
            overflow: hidden;
        }
        #dt-bar.hidden {
            max-height: 0;
            opacity: 0;
            padding: 0;
            margin: 0;
            border: none;
        }
        .dt-progress-area {
            flex: 1;
            min-width: 150px;
            height: 36px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 8px;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #dt-progress-fill {
            height: 100%;
            transition: width 0.5s linear, background-color 0.5s ease;
        }
        .dt-click-zone {
            position: absolute;
            top: 0;
            height: 100%;
            width: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: background 0.2s;
            z-index: 10;
        }
        .dt-click-zone:hover { background: rgba(255, 255, 255, 0.05); }
        .dt-click-zone:active { background: rgba(255, 255, 255, 0.1); }
        #dt-zone-minus { left: 0; padding-left: 10px; justify-content: flex-start; }
        #dt-zone-plus { right: 0; padding-right: 10px; justify-content: flex-end; }
        .dt-icon-overlay {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            pointer-events: none;
        }
        .dt-controls-area {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        #dt-display {
            background: #000;
            color: #4fc3f7;
            font-family: monospace;
            font-size: 1.2rem;
            padding: 5px 12px;
            border-radius: 6px;
            border: 1px solid #333;
            min-width: 70px;
            text-align: center;
            font-weight: bold;
        }
        .dt-ctrl-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            color: white;
            font-size: 1rem;
        }
        #dt-play-btn { background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; color: #4CAF50; }
        #dt-play-btn:hover { background: rgba(76, 175, 80, 0.4); transform: scale(1.05); }
        #dt-reset-btn { background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; color: #ff9800; }
        #dt-reset-btn:hover { background: rgba(255, 152, 0, 0.4); transform: scale(1.05); }
        .bg-green-500 { background: linear-gradient(90deg, #4CAF50, #8BC34A); box-shadow: 0 0 10px rgba(76, 175, 80, 0.4); }
        .bg-yellow-500 { background: linear-gradient(90deg, #FF9800, #FFC107); box-shadow: 0 0 10px rgba(255, 152, 0, 0.4); }
        .bg-red-600 { background: linear-gradient(90deg, #f44336, #ff5722); box-shadow: 0 0 10px rgba(244, 67, 54, 0.4); }
        @media (max-width: 480px) {
            #dt-bar { 
                gap: 5px; 
                padding: 5px; 
                flex-wrap: nowrap;
            }
            .dt-controls-area { 
                width: auto; 
                justify-content: flex-end; 
                margin-top: 0; 
                flex-shrink: 0;
            }
            .dt-progress-area { 
                width: auto; 
                flex: 1;
                min-width: 0;
            }
            #dt-display { font-size: 1rem; padding: 4px 6px; min-width: 55px; }
            .dt-ctrl-btn { width: 30px; height: 30px; font-size: 0.9rem; }
        }
        #calculator-section { width: 100%; margin: 20px 0; }
        #calculator-toggle {
            background: rgba(255, 152, 0, 0.2); border: 1px solid #ff9800; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        #calculator-toggle:hover { background: rgba(255, 152, 0, 0.4); }
        #calculator-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
        }
        .calculator-container {
            background: #202020; border-radius: 12px; padding: 15px;
            margin: 0 auto; width: 100%; max-width: 320px; display: flex; flex-direction: column;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        .calculator-display {
            width: 100%; padding: 15px; font-size: 2rem; background: #000;
            border: 1px solid #333; border-radius: 8px; margin-bottom: 15px;
            text-align: right; color: #fff; height: 70px; overflow: hidden; font-family: monospace;
        }
        .calculator-buttons { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
        }
        .calculator-btn {
            padding: 15px; font-size: 1.2rem; border: none; border-radius: 8px;
            background: #333; color: white; cursor: pointer; transition: all 0.2s;
            font-weight: bold;
        }
        .calculator-btn:hover { background: #444; }
        .calculator-btn.operator { background: #ff9800; color: #000; }
        .calculator-btn.operator:hover { background: #f57c00; }
        .calculator-btn.special { background: #9c27b0; }
        .calculator-btn.special:hover { background: #7b1fa2; }
        .calculator-btn.equals { background: #4caf50; grid-column: span 2; }
        .calculator-btn.equals:hover { background: #388e3c; }
        .calculator-btn.clear { background: #f44336; }
        .calculator-btn.clear:hover { background: #d32f2f; }
        .results-container { background: rgba(30, 30, 40, 0.8); border-radius: 15px; padding: 20px; margin: 15px 0; }
        .result-stats { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin: 20px 0; }
        .stat-box { background: rgba(50, 50, 70, 0.8); border-radius: 10px; padding: 15px; min-width: 160px; flex: 1; }
        .stat-box h3 { font-size: 1.1rem; margin-bottom: 8px; color: #4fc3f7; }
        .stat-box p { font-size: 1.5rem; font-weight: 700; }
        #result-image-container {
            width: 100%; max-width: 600px; margin: 1.5rem auto; display: flex;
            justify-content: center; align-items: center;
        }
        #result-image {
            max-width: 100%; height: auto; border-radius: 0.5rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3); object-fit: contain;
        }
        #image-container {
            position: relative; width: 100%; max-width: 100%; 
            height: 45vh; /* Usa el 45% de la altura de la pantalla del dispositivo */
            max-height: 500px; /* Límite para que no sea gigante en PC */
            min-height: 250px; /* Límite para que no sea muy chica en móviles */
            background-size: contain; background-position: center; background-repeat: no-repeat;
            overflow: hidden; margin: 15px auto; border-radius: 10px;
            background-color: rgba(0,0,0,0.2); /* Fondo sutil para distinguir el área */
        }
        #watermark-overlay {
            position: absolute; inset: -50%; width: 200%; height: 200%;
            color: rgba(255, 220, 220, 0.01); font-size: 1rem; font-weight: 600;
            pointer-events: none; display: flex; flex-wrap: wrap; align-items: center;
            justify-content: center; word-spacing: 1rem; animation: watermark-scroll 40s linear infinite;
        }
        @keyframes watermark-scroll {
            from { transform: rotate(-30deg) translate(0, 0); }
            to { transform: rotate(-30deg) translate(-25%, -25%); }
        }
        .question-id-tags {
            position: relative;
            margin: 10px auto;
            background: rgba(0, 0, 0, 0.7);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            width: fit-content;
        }
        .question-id { color: #4fc3f7; }
        .mini-nav-btn {
            width: 32px; height: 32px; border-radius: 50%; 
            background: rgba(30, 30, 40, 0.8); border: 1px solid #4fc3f7; 
            color: #4fc3f7; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem;
        }
        .mini-nav-btn:hover:not(:disabled) {
            background: rgba(79, 195, 247, 0.3); transform: scale(1.1);
        }
        .mini-nav-btn:disabled {
            opacity: 0.3; cursor: not-allowed; border-color: #555; color: #777;
        }
        .uni-tag-display { color: #81c784; }
        .options-grid-mode {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        /* NUEVO ESTILO HÍBRIDO */
        .hybrid-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }
        .hybrid-group {
            background: rgba(0, 0, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.1);
        }
        .hybrid-group-title {
            text-align: center;
            color: #4fc3f7;
            font-size: 0.9rem;
            margin-bottom: 8px;
            font-weight: bold;
            text-transform: uppercase;
        }
        @media (min-width: 768px) {
            .hybrid-container {
                flex-direction: row;
            }
            .hybrid-group {
                flex: 1;
            }
        }
        .option-btn.is-image {
            padding: 5px !important;
            height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .option-btn.is-image .option-letter {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }
        .option-image-content {
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 5px;
        }
        .option-btn.full-width {
            grid-column: span 2;
            height: auto !important;
            padding: 15px 15px 15px 50px !important;
        }
        .option-watermark {
            position: absolute;
            inset: -50%;
            width: 200%;
            height: 200%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            opacity: 0.15;
            pointer-events: none;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: bold;
            white-space: pre-wrap;
            text-align: center;
            line-height: 2;
            z-index: 5;
            animation: watermark-scroll 40s linear infinite;
        }
        @media (max-width: 480px) {
            .option-btn.is-image { height: 150px; }
        }
        .level-tag-display { color: #ffd54f; }
        .video-link {
            color: #4fc3f7; font-style: italic; margin-left: 5px; text-decoration: underline;
        }
        .video-container { width: 100%; margin: 15px 0; }
        .video-toggle {
            background: rgba(79, 195, 247, 0.2); border: 1px solid #4fc3f7; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        .video-toggle:hover { background: rgba(79, 195, 247, 0.4); }
        .video-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
            padding: 15px; overflow: hidden;
        }
        .video-wrapper {
            position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;
        }
        .video-wrapper iframe {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border: none; border-radius: 5px;
        }
        .volume-btn-new {
            width: 28px; height: 28px; border-radius: 50%; border: 1px solid #6b7280;
            background: rgba(50, 50, 70, 0.8); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 1rem; font-weight: bold; transition: background 0.2s;
        }
        .volume-btn-new:hover { background: rgba(70, 70, 90, 0.9); }
        .volume-btn-new:active { transform: scale(0.95); }
        #chalkboard-section { width: 100%; margin: 20px 0; }
        #chalkboard-toggle {
            background: rgba(100, 181, 246, 0.2); border: 1px solid #64b5f6; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        #chalkboard-toggle:hover { background: rgba(100, 181, 246, 0.4); }
        #chalkboard-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
            padding: 15px; overflow: hidden;
        }
        #canvas-container {
            width: 100%; aspect-ratio: 4 / 3; background-size: cover; background-position: center;
            border-radius: 0.5rem; box-shadow: 0 10px 20px rgba(0,0,0,0.3); overflow: hidden;
        }
        #chalkboard { display: block; width: 100%; height: 100%; }
        #chalkboard-controls {
            background: rgba(30, 30, 40, 0.9); padding: 10px; border-radius: 0.5rem;
            margin-top: 10px; width: 100%; display: flex; flex-wrap: wrap;
            align-items: center; justify-content: center; gap: 12px;
        }
        .control-btn.active { box-shadow: 0 0 0 3px #4a90e2; border-color: #4a90e2; }
        .color-picker-wrapper { position: relative; width: 36px; height: 36px; }
        .color-picker-wrapper input[type="color"] {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            opacity: 0; cursor: pointer;
        }
        .color-picker-wrapper .color-preview {
            width: 100%; height: 100%; border-radius: 0.375rem;
            border: 2px solid white; pointer-events: none;
        }
        #graphing-tool-section { width: 100%; margin: 20px 0; }
        #graphing-tool-toggle {
            background: rgba(156, 39, 176, 0.2); border: 1px solid #9c27b0; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        #graphing-tool-toggle:hover { background: rgba(156, 39, 176, 0.4); }
        #graphing-tool-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
            padding: 15px; overflow: hidden;
        }
        .graphing-container {
            background: rgba(30, 30, 40, 0.9); border-radius: 8px;
            padding: 20px; margin-bottom: 15px;
        }
        .graphing-title { color: #9c27b0; font-size: 1.3rem; margin-bottom: 15px; text-align: center; }
        .graphing-subtitle { color: #bdbdbd; font-size: 0.9rem; margin-bottom: 20px; text-align: center; }
        .graphing-main-content { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 20px; 
            margin-bottom: 20px; 
            justify-content: center; 
        }
        .graphing-canvas-container {
            flex: 1;
            min-width: 300px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            margin: 0 auto;
            width: 100%;
            max-width: 600px;
        }
        .graphing-controls-container {
            width: 350px; background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px;
            margin: 0 auto; 
        }
        .graphing-section-title {
            color: #4fc3f7; font-size: 1.1rem; margin-bottom: 15px;
            padding-bottom: 8px; border-bottom: 1px solid rgba(79, 195, 247, 0.3);
        }
        .graphing-function-buttons {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;
        }
        .graphing-func-btn {
            padding: 8px 5px; background-color: rgba(50, 50, 70, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3); border-radius: 4px; cursor: pointer;
            font-size: 0.8rem; color: white; transition: all 0.2s;
        }
        .graphing-func-btn:hover { background-color: rgba(79, 195, 247, 0.3); }
        .graphing-func-btn.active { background-color: #9c27b0; color: white; border-color: #7b1fa2; }
        .graphing-equation-display {
            background-color: rgba(0, 0, 0, 0.3); border-radius: 4px; padding: 12px;
            margin-bottom: 15px; font-family: 'Courier New', monospace; border-left: 3px solid #9c27b0;
            text-align: center; 
        }
        .graphing-equation-display h3 { font-size: 0.9rem; margin-bottom: 8px; color: #4fc3f7; }
        .graphing-equation { font-size: 1rem; color: #ffffff; min-height: 30px; }
        .graphing-param-group { margin-bottom: 12px; }
        .graphing-param-group label { display: block; margin-bottom: 5px; color: #bdbdbd; font-size: 0.85rem; }
        .graphing-param-input {
            width: 100%; padding: 8px 12px; background: rgba(50, 50, 70, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3); border-radius: 4px;
            font-size: 0.9rem; color: white;
        }
        .graphing-param-input:focus {
            outline: none; border-color: #9c27b0; box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.2);
        }
        .graphing-controls-footer { display: flex; justify-content: space-between; margin-top: 20px; }
        .graphing-btn {
            padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer;
            font-weight: 500; transition: all 0.2s; font-size: 0.9rem;
        }
        .graphing-btn-primary { background: linear-gradient(45deg, #9c27b0, #7b1fa2); color: white; }
        .graphing-btn-primary:hover { background: linear-gradient(45deg, #7b1fa2, #6a1b9a); }
        .graphing-btn-secondary {
            background: rgba(50, 50, 70, 0.8); color: white; border: 1px solid rgba(79, 195, 247, 0.3);
        }
        .graphing-btn-secondary:hover { background: rgba(70, 70, 90, 0.9); }
        .graphing-info-box {
            background-color: rgba(0, 0, 0, 0.3); border-radius: 4px; padding: 12px;
            margin-top: 15px; font-size: 0.8rem; color: #bdbdbd;
            text-align: center; 
        }
        .graphing-info-box h4 { color: #4fc3f7; margin-bottom: 5px; }
        .graphing-form-toggle {
            display: flex; margin-bottom: 15px; border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 4px; overflow: hidden;
        }
        .graphing-form-toggle-btn {
            flex: 1; padding: 8px; text-align: center; background-color: rgba(50, 50, 70, 0.8);
            border: none; cursor: pointer; font-size: 0.8rem; color: white; transition: all 0.2s;
        }
        .graphing-form-toggle-btn.active { background-color: #9c27b0; color: white; }
        .graphing-select-control {
            width: 100%; padding: 8px 12px; background: rgba(50, 50, 70, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3); border-radius: 4px;
            font-size: 0.9rem; color: white; margin-bottom: 12px;
        }
        .canvas-container {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1;
            margin-top: 5px;
        }
        .graphing-zoom-controls {
            display: flex; justify-content: center; align-items: center; gap: 15px;
            margin-top: 15px; padding: 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;
        }
        .zoom-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: rgba(79, 195, 247, 0.3); color: white; font-size: 1.2rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .zoom-btn:hover:not(:disabled) { background: rgba(79, 195, 247, 0.5); transform: scale(1.1); }
        .zoom-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .scale-indicator { font-size: 0.9rem; color: #bdbdbd; min-width: 80px; text-align: center; }
        .lookup-question-container {
            background: rgba(30, 30, 40, 0.9); border-radius: 15px; padding: 20px;
            margin: 15px 0; border-left: 5px solid #4fc3f7;
        }
        .lookup-option {
            padding: 12px 12px 12px 40px; background: rgba(50, 50, 70, 0.8);
            border-radius: 10px; margin-bottom: 10px; position: relative;
            border-left: 4px solid #4CAF50; 
        }
        .lookup-option.incorrect {
            border-left-color: #f44336; 
        }
        .lookup-option-label {
            position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
            width: 24px; height: 24px; background: rgba(79, 195, 247, 0.3);
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-weight: bold;
        }
        .lookup-correct-badge {
            background: linear-gradient(45deg, #4CAF50, #8BC34A); color: white;
            padding: 4px 12px; border-radius: 15px; font-size: 0.8rem;
            font-weight: bold; margin-left: 10px;
        }
        .lookup-section {
            background: rgba(40, 40, 50, 0.9); border-radius: 10px; padding: 15px;
            margin-top: 15px; border-left: 4px solid #4fc3f7;
        }
        .lookup-section-title {
            color: #4fc3f7; margin-bottom: 8px; font-size: 1.1rem;
        }
        .evaluate-emoji {
            display: inline-block;
            animation: emoji-animation 2s infinite;
        }
        @keyframes emoji-animation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        #chatbot-section { width: 100%; margin: 20px 0; }
        #chatbot-toggle {
            background: rgba(76, 175, 80, 0.2); border: 1px solid #4CAF50; color: white;
            padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex;
            align-items: center; justify-content: space-between; transition: all 0.3s ease;
        }
        #chatbot-toggle:hover { background: rgba(76, 175, 80, 0.4); }
        #chatbot-content {
            margin-top: 10px; background: rgba(0, 0, 0, 0.5); border-radius: 8px;
            padding: 15px; overflow: hidden;
        }
        .chatbot-container {
            background: rgba(30, 30, 40, 0.9); border-radius: 8px;
            padding: 20px; margin-bottom: 15px;
        }
        .chatbot-title { color: #4CAF50; font-size: 1.3rem; margin-bottom: 15px; text-align: center; }
        #chatbot-chat {
            background: rgba(0, 0, 0, 0.3); border-radius: 8px; padding: 15px;
            height: 200px; overflow-y: auto; margin-bottom: 15px;
            font-size: 14px;
        }
        .chatbot-user { color: #4fc3f7; }
        .chatbot-bot { color: #4CAF50; }
        .chatbot-system {
            color: #bdbdbd; font-style: italic; font-size: 13px;
        }
        #advertisement-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 9999;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #advertisement-image {
            max-width: 90%; max-height: 70%;
            border-radius: 15px; box-shadow: 0 0 50px rgba(255, 152, 0, 0.5);
            animation: pulse-ad 1s infinite alternate;
        }
        @keyframes pulse-ad {
            from { transform: scale(0.95); box-shadow: 0 0 50px rgba(255, 152, 0, 0.5); }
            to { transform: scale(1); box-shadow: 0 0 100px rgba(255, 152, 0, 0.8); }
        }
        #advertisement-countdown {
            margin-top: 20px; color: #ff9800; font-size: 1.5rem; font-weight: bold;
        }
        #advertisement-skip {
            margin-top: 20px; background: rgba(255, 152, 0, 0.3); 
            border: 1px solid #ff9800; color: white; padding: 10px 20px;
            border-radius: 8px; cursor: not-allowed; opacity: 0.5;
        }
        #simulacro-end-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95); z-index: 9998;
            display: none; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #simulacro-end-image {
            max-width: 90%; max-height: 60%; border-radius: 15px;
            margin-bottom: 30px;
        }
        #simulacro-end-timer {
            color: #ff9800; font-size: 1.2rem; margin-bottom: 20px;
        }
        #game-mode-rules {
            background: #000; border: 2px solid #FFD700; animation: pulse 2s infinite;
            padding: 10px; margin-bottom: 15px; border-radius: 10px;
        }
        #game-mode-rules-text {
            color: #FFD700; font-size: 0.9rem; text-align: center; margin-top: 5px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(79, 195, 247, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(79, 195, 247, 0); }
            100% { box-shadow: 0 0 0 0 rgba(79, 195, 247, 0); }
        }
        .game-mode-warning {
            animation: pulse-warning 1.5s infinite alternate;
            background: #000; 
            background-size: 200% 200%;
            border: 2px solid #FFD700;
            color: #FFD700;
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.7);
        }
        @keyframes pulse-warning {
            0% { 
                box-shadow: 0 0 20px rgba(255, 152, 0, 0.7);
            }
            100% { 
                box-shadow: 0 0 40px rgba(255, 87, 34, 0.9);
            }
        }
        .game-mode-loss {
            background: rgba(244, 67, 54, 0.9); border: 2px solid #f44336; animation: shake 0.5s;
        }
        .game-mode-win {
            background: rgba(76, 175, 80, 0.9); border: 2px solid #4CAF50;
        }
        #banner-container {
            width: 100%;
            max-width: 720px;
            height: auto;
            min-height: 50px;
            margin: 10px auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            border: 1px solid rgba(79, 195, 247, 0.3);
        }
        #banner-img {
            width: 100%;
            height: auto;
            object-fit: contain;
            display: block;
        }
        @media (max-width: 480px) {
            .graphing-container { padding: 10px; }
            .graphing-canvas-container { 
                padding: 5px;
                min-width: 100%; 
            }
        }
        #adOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        #adBox {
            background: #1a1a2e;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #4fc3f7;
            box-shadow: 0 0 20px rgba(79, 195, 247, 0.3);
            position: relative;
        }
        #adBox img {
            max-width: 100%;
            height: auto;
            max-height: 40vh;
            object-fit: contain;
            border-radius: 6px;
            margin-bottom: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        #adButtons {
            margin-top: 15px;
        }
        #adButtons button,
        #adButtons a {
            margin: 5px;
            padding: 10px 15px;
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            border-radius: 5px;
            text-decoration: none;
            cursor: pointer;
            font-weight: bold;
        }
        #adButtons button:disabled {
            background: #999;
            cursor: not-allowed;
        }
        #chatbot-input {
            flex: 1;
            padding: 12px;
            background-color: rgba(0, 0, 0, 0.6);
            color: #ffffff;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            outline: none;
            font-size: 1rem;
        }
        #chatbot-input::placeholder {
            color: #aaaaaa;
        }
        #chatbot-send {
            padding: 10px 20px;
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
        }
        #chatbot-send:hover {
            transform: scale(1.05);
        }
        #footer {
            position: relative;
            width: 100%;
            margin-top: 50px;
            background: rgba(25, 25, 35, 0.95);
            backdrop-filter: blur(10px);
            color: white;
            padding: 20px 0;
            text-align: center;
            font-size: 12px;
            z-index: 100;
            border-top: 1px solid rgba(79, 195, 247, 0.3);
        }
        #footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        #footer-links {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-bottom: 3px;
        }
        .footer-link {
            color: #4fc3f7;
            text-decoration: none;
            transition: color 0.3s ease;
            cursor: pointer;
        }
        .footer-link:hover {
            color: #21CBF3;
            text-decoration: underline;
        }
        .social-link {
            color: #4fc3f7;
            text-decoration: none;
            transition: color 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .social-link:hover {
            color: #21CBF3;
        }
        #copyright {
            color: #aaaaaa;
            font-size: 11px;
        }
        #privacy-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .privacy-modal-content {
            background: rgba(25, 25, 35, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            border: 2px solid #4fc3f7;
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
            position: relative;
        }
        .privacy-modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s ease;
        }
        .privacy-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .privacy-title {
            color: #4fc3f7;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        .privacy-content {
            color: #fff;
            font-size: 14px;
            line-height: 1.6;
        }
        .privacy-section {
            margin-bottom: 20px;
        }
        .privacy-section h3 {
            color: #4fc3f7;
            font-size: 16px;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .privacy-section p {
            margin-bottom: 10px;
        }
        #guest-info-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .guest-info-content {
            background: rgba(25, 25, 35, 0.95);
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            padding: 30px;
            border: 2px solid #4fc3f7;
            box-shadow: 0 0 30px rgba(79, 195, 247, 0.3);
        }
        .guest-info-title {
            color: #4fc3f7;
            font-size: 24px;
            margin-bottom: 20px;
            text-align: center;
        }
        .guest-info-text {
            color: #fff;
            margin-bottom: 25px;
            text-align: center;
            line-height: 1.5;
        }
        .guest-info-form {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .guest-info-form input {
            padding: 15px;
            background: rgba(50, 50, 70, 0.8);
            border: 1px solid rgba(79, 195, 247, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 16px;
        }
        .guest-info-form input:focus {
            outline: none;
            border-color: #4fc3f7;
            box-shadow: 0 0 0 2px rgba(79, 195, 247, 0.2);
        }
        .guest-error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        .guest-info-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        .guest-info-buttons button {
            flex: 1;
            padding: 12px;
            font-weight: 600;
        }
        @media (max-width: 768px) {
            .btn { font-size: 1rem; padding: 8px 16px; width: 100%; max-width: 300px; }
            .option-btn { font-size: 0.9rem !important; padding: 12px 12px 12px 40px !important; }
            .question-controls, .global-controls { flex-direction: column; align-items: center; }
            .header { padding: 12px; }
            .header h1 { font-size: 1.5rem; }
            .header h2 { font-size: 1.2rem; }
            .card { padding: 15px; }
            .question-container { padding: 15px; margin: 10px 0; }
            #question-text { font-size: 1.2rem !important; }
            .justification { padding: 12px; }
            .option-letter { width: 22px; height: 22px; font-size: 0.9rem; }
            #action-buttons { gap: 10px; }
            #action-buttons .btn { margin: 4px; }
            .results-container { padding: 15px; }
            .stat-box { min-width: 120px; padding: 10px; }
            .stat-box h3 { font-size: 1rem; }
            .stat-box p { font-size: 1.3rem; }
            #results-table { font-size: 0.8rem; }
            #results-table th, #results-table td { padding: 8px 4px; }
            .graphing-main-content { flex-direction: column; }
            .graphing-controls-container { width: 100%; }
            .graphing-canvas-container { min-width: auto; }
            .graphing-zoom-controls { flex-wrap: wrap; }
            .lookup-option { padding: 10px 10px 10px 35px; }
            .calculator-container { width: 280px; height: 350px; }
            #footer {
                padding: 5px 0;
            }
            #footer-links {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 12px;
                row-gap: 5px;
            }
            #footer-links span.text-gray-500 {
                display: none;
            }
            .footer-link, .social-link {
                font-size: 0.75rem; 
                padding: 4px 6px;
                background: rgba(0,0,0,0.2);
                border-radius: 4px;
            }
            .privacy-modal-content {
                padding: 20px;
                margin: 10px;
            }
            .guest-info-content {
                padding: 20px;
            }
            .guest-info-buttons {
                flex-direction: column;
            }
        }
        @media (max-width: 480px) {
            body { padding: 8px !important; }
            .option-btn { font-size: 0.85rem !important; padding: 10px 10px 10px 35px !important; }
            .option-letter { width: 20px !important; height: 20px !important; font-size: 0.8rem !important; left: 10px !important; }
            .btn { font-size: 0.9rem; padding: 7px 14px; }
            .question-id-tags { font-size: 0.6rem; padding: 2px 5px; }
            .header h1 { font-size: 1.5rem !important; }
            .header h2 { font-size: 1.2rem !important; }
            #question-text { font-size: 1.1rem !important; }
            #image-container { max-width: 100%; }
            .graphing-function-buttons { grid-template-columns: repeat(2, 1fr); }
            .justification h4 { font-size: 1rem !important; }
            .calculator-container { width: 95%; max-width: 300px; height: auto; padding-bottom: 20px; }
        }
    </style>
</head>
<body class="p-2 sm:p-4">
    <audio id="correct-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/Correct_sound.mp3" preload="auto"></audio>
    <audio id="incorrect-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/Incorrect_sound.mp3" preload="auto"></audio>
    <audio id="button-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/Clic_sound.mp3" preload="auto"></audio>
    <audio id="sad-violin-sound" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/sad_violin.mp3" preload="auto"></audio>
    <audio id="simulacro-fail-1" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/simulacro_fail_1.mp3" preload="auto"></audio>
    <audio id="simulacro-fail-2" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/sad_violin.mp3" preload="auto"></audio>
    <audio id="simulacro-success-1" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/simulacro_logrado_1.mp3" preload="auto"></audio>
    <audio id="simulacro-success-2" src="https://github.com/IALUMX/Audios_cepredix/raw/refs/heads/main/simulacro_logrado_2.mp3" preload="auto"></audio>
    <div id="adOverlay" style="display: none;">
        <div id="adBox">
            <img id="adImage" src="" alt="Publicidad">
            <audio id="adAudio"></audio>
            <div id="adButtons">
                <button id="skipBtn" disabled>Saltar info</button>
                <a id="infoBtn" href="#" target="_blank" style="pointer-events:none;">
                    Me interesa
                </a>
            </div>
        </div>
    </div>
    <div id="privacy-modal" style="display: none;">
        <div class="privacy-modal-content">
            <button class="privacy-modal-close">&times;</button>
            <h2 class="privacy-title">AVISO DE PRIVACIDAD</h2>
            <div class="privacy-content">
                <div class="privacy-section">
                    <h3>CEPREDIX</h3>
                    <p>En cumplimiento con lo dispuesto por la Ley Federal de Protección de Datos Personales en Posesión de los Particulares y su Reglamento, CEPREDIX, como responsable del tratamiento de datos personales, pone a disposición de estudiantes, tutores, usuarios y clientes el presente Aviso de Privacidad.</p>
                </div>
                <div class="privacy-section">
                    <h3>1. Identidad del responsable</h3>
                    <p>CEPREDIX es un servicio educativo que brinda cursos, plataformas educativas, simulacros, bancos de preguntas y otros servicios relacionados con la formación académica.</p>
                    <p>CEPREDIX es responsable del uso, protección y tratamiento de los datos personales que recaba de sus usuarios y estudiantes.</p>
                </div>
                <div class="privacy-section">
                    <h3>2. Datos personales que se recaban</h3>
                    <p>Para la prestación de nuestros servicios educativos, CEPREDIX podrá recabar los siguientes datos personales:</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Nombre del estudiante</li>
                        <li>Nombre del tutor (en caso de menores de edad)</li>
                        <li>Correo electrónico de contacto</li>
                        <li>Número telefónico con acceso a WhatsApp</li>
                    </ul>
                    <p>CEPREDIX no recaba datos personales sensibles.</p>
                </div>
                <div class="privacy-section">
                    <h3>3. Finalidades del tratamiento de los datos personales</h3>
                    <p>Los datos personales recabados serán utilizados exclusivamente para fines internos, relacionados con:</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Registro y administración de estudiantes y usuarios</li>
                        <li>Acceso y uso de plataformas educativas</li>
                        <li>Comunicación académica, administrativa y operativa</li>
                        <li>Envío de información relacionada con cursos, servicios o soporte</li>
                        <li>Seguimiento del servicio contratado</li>
                    </ul>
                    <p>En ningún caso los datos serán utilizados para fines distintos a los aquí señalados.</p>
                </div>
                <div class="privacy-section">
                    <h3>4. Conservación de los datos</h3>
                    <p>Los datos personales se conservarán únicamente durante el tiempo en que el usuario o estudiante mantenga una relación activa con CEPREDIX.</p>
                    <p>Una vez concluida la contratación de los servicios, los datos personales serán eliminados de nuestra base de datos en un plazo máximo de 30 días naturales, salvo aquellos que deban conservarse por disposición legal aplicable.</p>
                </div>
                <div class="privacy-section">
                    <h3>5. Transferencia de datos personales</h3>
                    <p>CEPREDIX no comparte, vende, cede ni transfiere datos personales a terceros, ya sea nacionales o extranjeros.</p>
                    <p>Toda la información recabada es utilizada exclusivamente para fines internos del servicio educativo.</p>
                </div>
                <div class="privacy-section">
                    <h3>6. Medidas de seguridad</h3>
                    <p>CEPREDIX implementa medidas administrativas, técnicas y organizativas razonables para proteger los datos personales contra daño, pérdida, alteración, destrucción o uso, acceso o tratamiento no autorizado.</p>
                </div>
                <div class="privacy-section">
                    <h3>7. Derechos ARCO (Acceso, Rectificación, Cancelación y Oposición)</h3>
                    <p>Los titulares de los datos personales tienen derecho a:</p>
                    <ul style="margin-left: 20px; margin-bottom: 10px;">
                        <li>Acceder a sus datos personales</li>
                        <li>Rectificar datos incorrectos o incompletos</li>
                        <li>Cancelar sus datos cuando consideren que no se requieren para los fines señalados</li>
                        <li>Oponerse al tratamiento de sus datos</li>
                    </ul>
                    <p>Para ejercer estos derechos, el titular podrá enviar una solicitud a través de los medios de contacto oficiales de CEPREDIX, indicando claramente el derecho que desea ejercer.</p>
                </div>
                <div class="privacy-section">
                    <h3>8. Cambios al aviso de privacidad</h3>
                    <p>CEPREDIX se reserva el derecho de realizar modificaciones o actualizaciones al presente Aviso de Privacidad en cualquier momento.
                    Las modificaciones estarán disponibles a través de los medios oficiales del servicio.</p>
                </div>
                <div class="privacy-section">
                    <h3>9. Consentimiento</h3>
                    <p>Al utilizar los servicios educativos de CEPREDIX, el usuario y/o tutor manifiesta su consentimiento para el tratamiento de sus datos personales conforme a lo establecido en el presente Aviso de Privacidad.</p>
                </div>
            </div>
        </div>
    </div>
    <div id="guest-info-modal" style="display: none;">
        <div class="guest-info-content">
            <h2 class="guest-info-title">📧 Completa tus datos para ver los resultados</h2>
            <p class="guest-info-text">
                Como usuario invitado, necesitamos tu correo y WhatsApp para mostrarte tus resultados 
                y enviarte un resumen de tu desempeño.
            </p>
            <form id="guest-info-form" class="guest-info-form">
                <div>
                    <input type="email" id="guest-email-input" 
                           placeholder="Correo electrónico (ejemplo@dominio.com)" 
                           required>
                    <div id="guest-email-error" class="guest-error-message">
                        ❌ Debe ser un correo válido con @
                    </div>
                </div>
                <div>
                    <input type="tel" id="guest-whatsapp-input" 
                           placeholder="WhatsApp (10 dígitos sin espacios)"
                           maxlength="10"
                           inputmode="numeric"
                           required>
                    <div id="guest-whatsapp-error" class="guest-error-message">
                        ❌ Debe tener 10 dígitos
                    </div>
                </div>
                <div class="guest-info-buttons">
                    <button type="submit" id="guest-submit-btn" class="btn btn-primary">
                        Ver mis resultados
                    </button>
                    <button type="button" id="guest-cancel-btn" class="btn btn-secondary">
                        Cancelar
                    </button>
                </div>
            </form>
            <p style="color: #aaa; font-size: 12px; text-align: center; margin-top: 20px;">
                Tu nombre se registrará automáticamente como "Invitado"
            </p>
        </div>
    </div>
    <div id="simulacro-end-screen" style="display: none;">
        <img id="simulacro-end-image" src="" alt="Fin del simulacro">
        <div id="simulacro-end-timer">Volviendo al menú en 10 segundos...</div>
        <button id="simulacro-return-btn" class="btn" style="background: linear-gradient(45deg, #ff9800, #ff5722);">VOLVER AL MENÚ</button>
    </div>
    <div id="app-container" class="w-full max-w-2xl mx-auto">
        <header class="header">
            <button id="logout-btn" class="logout-btn" title="Cerrar sesión">
                <i class="fas fa-power-off"></i>
            </button>
            <a href="https://simuladores.cepredix.com.mx/cepredix.html" target="_blank" title="Ir a Web CEPREDIX">
                <div class="logo"></div>
            </a>
            <h1 class="text-2xl sm:text-3xl font-bold">PRUEBA (Global)</h1>
            <h2 class="text-xl sm:text-2xl">Diseñado con pasión 💜 por el CEPREDIX</h2>
            <p class="text-sm sm:text-base">Prueba tus conocimientos con este cuestionario interactivo de opción múltiple 🧠</p>
        </header>
        <div id="banner-container" style="display: none;">
            <a id="banner-link" href="#" target="_blank">
                <img id="banner-img" src="" alt="Aviso">
            </a>
            <audio id="banner-audio-player"></audio>
        </div>
        <div id="login-screen" class="card p-6 sm:p-8 space-y-6">
            <div class="text-center">
                <h2 class="text-2xl sm:text-3xl font-bold">HOLA 🖐 TE DAMOS LA BIENVENIDA 😉</h2>
                <p class="text-gray-300 mt-2">Por favor, valida tus datos para comenzar</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div>
                    <label for="name-input" class="font-medium">Nombre y apellido</label>
                    <input type="text" id="name-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="Tu nombre o nombre completo" required>
                </div>
                <div>
                    <label for="email-input" class="font-medium">Correo Electrónico</label>
                    <input type="email" id="email-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="tu.correo@ejemplo.com" required>
                </div>
                <div>
                    <label for="whatsapp-input" class="font-medium">WhatsApp (10 dígitos sin espacios)</label>
                    <input type="password" id="whatsapp-input" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="••••••••••" maxlength="10" inputmode="numeric" required>
                </div>
                <button id="login-btn" type="submit" class="btn btn-correct w-full text-lg">
                    <span id="login-btn-text">Verificar y Entrar</span>
                    <span id="login-btn-spinner" class="hidden animate-spin">&#9696;</span>
                </button>
            </form>
            <div class="space-y-2">
                <button id="guest-login-btn" class="btn btn-secondary w-full">ACCEDER COMO INVITADO</button>
                <p class="text-xs text-center text-gray-300">Recuerda que al acceder como invitado NO se generan registros de tu avance, tampoco tendrás control de los filtros y algunos ejercicios no estarán disponibles para ti. Contacta al administrador en el link de abajo (NO TENGO ACCESO 😥) para más información.</p>
            </div>
            <a href="https://wa.link/i5rp89" target="_blank" class="btn btn-secondary w-full !mt-2">NO TENGO ACCESO 😥</a>
            <p id="login-error-message" class="text-red-400 text-center text-sm h-4"></p>
        </div>
        <div id="setup-screen" class="card p-6 sm:p-8 space-y-6 hidden">
             <div class="video-container w-full mb-6" style="margin-top: 60px;">
                <div class="video-toggle" id="welcome-video-toggle">
                    <span><i class="fab fa-youtube mr-2"></i> Ver Video de Bienvenida e Instrucciones</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="video-content hidden" id="welcome-video-content">
                    <div class="video-wrapper">
                        <iframe src="https://www.youtube.com/embed/VIDEO_ID_AQUI" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
            <div id="setup-volume-control" class="absolute top-4 right-4 flex items-center gap-2">
                <button class="volume-btn-new" data-action="down">-</button>
                <i class="fas fa-volume-high text-gray-300 text-lg"></i>
                <span id="volume-indicator-setup" class="text-sm font-semibold w-12 text-center">50%</span>
                <button class="volume-btn-new" data-action="up">+</button>
            </div>
            <div class="text-center">
                <h1 class="text-2xl sm:text-3xl font-bold">Hola, <span id="welcome-name" class="text-blue-400"></span></h1>
                <p class="text-gray-300 mt-2">Configura tu prueba para comenzar a practicar. Recuerda que si estás como INVITADO tendrás funciones limitadas</p>
            </div>
            <div class="space-y-4">
                <div class="space-y-2 mt-4 pt-4 border-t border-gray-700">
                    <label class="font-medium flex items-center">
                        <input type="checkbox" id="continuous-mode-toggle" class="mr-2 h-5 w-5">
                        MODO AVANCE CONTINUO 🚀 (Sin límite de preguntas)
                    </label>
                    <p class="text-xs text-gray-400">Responde preguntas del banco de forma aleatoria sin fin. Termina la ronda cuando quieras con "Evaluar avance".</p>
                </div>
                <div class="space-y-2 mt-4 pt-4 border-t border-gray-700">
                    <label class="font-medium flex items-center">
                        <input type="checkbox" id="game-mode-toggle" class="mr-2 h-5 w-5">
                        MODO SIMULACRO MORTAL ☠ (Desafío)
                    </label>
                    <p class="text-xs text-gray-400">Temporizador fijo de 30 minutos, 20 ejercicios aleatorios y 3 vidas</p>
                </div>
            </div>
            <div class="space-y-4">
                <div class="space-y-2">
                    <p class="font-medium">Proceso de Admisión</p>
                    <p class="text-xs text-gray-400">Selecciona tu proceso de admisión, recuerda que "GENERAL" significa que el ejercicio aplica para todos los procesos de admisión.</p>
                    <div id="uni-tags-container" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="space-y-2">
                    <p class="font-medium">Nivel de Dificultad</p>
                    <p class="text-xs text-gray-400">Selecciona el grado de dificultad de los ejercicios.</p>
                    <div id="level-tags-container" class="flex flex-wrap gap-2"></div>
                </div>
                <div class="space-y-2">
                    <p class="font-medium">Tipo de Reactivo</p>
                    <p class="text-xs text-gray-400">Selecciona el tipo de pregunta (ej. TEST, REAL, HÍBRIDO).</p>
                    <div id="type-tags-container" class="flex flex-wrap gap-2"></div>
                </div>
            </div>
            <div class="space-y-2">
                <label for="answered-ids-input" class="font-medium">Pegar IDs de ejercicios ya respondidos (opcional)</label>
                <textarea id="answered-ids-input" rows="3" class="w-full p-3 mt-1 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="CEPCOL8Ht, CEPCOL4aA, ..."></textarea>
                <div class="text-sm text-gray-300 space-y-2 mt-2 bg-gray-800 p-3 rounded-lg">
                    <div class="flex justify-between">
                        <span>📚 Total Banco:</span> 
                        <strong id="stats-total">0</strong>
                    </div>
                    <div class="flex justify-between">
                        <span>🔍 Con Filtros (Nivel/Proceso):</span> 
                        <strong id="stats-total-filtered">0</strong>
                    </div>
                    <div class="flex justify-between text-green-400 font-bold border-t border-gray-600 pt-1 mt-1">
                        <span>✨ Preguntas Restantes:</span> 
                        <strong id="stats-remaining-filtered">0</strong>
                    </div>
                </div>
            </div>
            <button id="start-quiz-btn" class="btn btn-primary w-full text-lg">Empezar Cuestionario</button>
            <p id="error-message" class="text-red-400 text-center text-sm h-4"></p>
            <div class="space-y-2 border-t border-gray-600 pt-4 mt-4">
                <div class="video-toggle" id="lookup-toggle">
                    <span><i class="fas fa-search mr-2"></i> Verificar Pregunta por ID</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="lookup-section-content" class="hidden mt-3">
                    <div class="flex gap-2">
                        <input type="text" id="lookup-id-input" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 text-white" placeholder="Introduce el ID del reactivo">
                        <button id="lookup-btn" class="btn btn-secondary !m-0">Buscar</button>
                    </div>
                    <div id="lookup-result-container" class="mt-2 p-4 bg-gray-800 rounded-lg hidden text-left">
                    </div>
                </div>
            </div>
        </div>
        <div id="quiz-screen" class="card p-4 sm:p-8 hidden flex flex-col">
            <div id="game-mode-rules" class="card p-3 mb-4 hidden">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-2">
                    <div class="flex items-center space-x-4">
                        <div class="text-yellow-400 font-bold text-xl" style="color: #FFD700;">⭐ MODO SIMULACRO MORTAL ☠ ACTIVADO</div>
                        <div class="flex space-x-2 ml-4">
                             <span id="game-mode-lives" class="bg-gray-700 px-4 py-1 rounded-full">❤️ ❤️ ❤️</span>
                        </div>
                    </div>
                    <div id="game-mode-rules-text" class="text-sm text-yellow-300 text-center sm:text-right" style="color: #FFD700;">
                        Reglas: Tienes 30 min y 3 vidas para responder 20 ejercicios al azar, responde tres veces seguidas y recupera 1 vida
                    </div>
                </div>
            </div>
            <div class="flex flex-row flex-wrap justify-between items-center mb-2 gap-y-1 gap-x-2 w-full">
                <div class="text-xs sm:text-lg font-bold text-gray-200 order-1">
                    Pregunta <span id="current-question-num"></span>/<span id="total-questions-num"></span>
                </div>
                <div id="live-score" class="flex gap-2 text-xs sm:text-lg order-2">
                    <span class="font-bold text-green-400">✓ <span id="live-correct">0</span></span>
                    <span class="font-bold text-red-400">✗ <span id="live-incorrect">0</span></span>
                </div>
                <div class="flex items-center space-x-1 text-xs sm:text-lg font-bold order-3" id="timer-container">
                    <svg class="h-4 w-4 sm:h-6 sm:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span id="timer" class="timer-green">30:00</span>
                </div>
                <div id="quiz-volume-control" class="flex items-center gap-1 order-4">
                    <button class="volume-btn-new w-5 h-5 sm:w-7 sm:h-7 text-xs sm:text-base flex items-center justify-center" data-action="down">-</button>
                    <i class="fas fa-volume-high text-gray-300 text-xs sm:text-lg"></i>
                    <span id="volume-indicator-quiz" class="text-xs sm:text-sm font-semibold w-6 sm:w-10 text-center">50%</span>
                    <button class="volume-btn-new w-5 h-5 sm:w-7 sm:h-7 text-xs sm:text-base flex items-center justify-center" data-action="up">+</button>
                </div>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2.5 mb-6">
                <div id="progress-bar" class="bg-blue-400 h-2.5 rounded-full" style="width: 0%"></div>
            </div>
            <div id="discrete-timer-wrapper">
                <div id="dt-tab" title="Mostrar/Ocultar Temporizador">
                    <i id="dt-icon" class="fas fa-chevron-down text-xs text-blue-300"></i>
                </div>
                <div id="dt-bar">
                    <div class="dt-progress-area">
                        <div id="dt-progress-fill" class="bg-green-500" style="width: 100%;"></div>
                        <div id="dt-zone-minus" class="dt-click-zone" title="Restar 30s">
                            <i class="fas fa-minus dt-icon-overlay"></i>
                        </div>
                        <div id="dt-zone-plus" class="dt-click-zone" title="Sumar 30s">
                            <i class="fas fa-plus dt-icon-overlay"></i>
                        </div>
                    </div>
                    <div class="dt-controls-area">
                        <div id="dt-display">01:30</div>
                        <button id="dt-play-btn" class="dt-ctrl-btn" title="Iniciar/Pausar">
                            <i class="fas fa-play"></i>
                        </button>
                        <button id="dt-reset-btn" class="dt-ctrl-btn" title="Reiniciar">
                            <i class="fas fa-redo"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div id="question-container" class="space-y-4 flex flex-col items-center">
                <h2 id="question-text" class="text-xl sm:text-2xl font-semibold text-center w-full"></h2>
                <div id="video-container" class="video-container w-full">
                    <div class="video-toggle" id="video-toggle">
                        <span><i class="fas fa-video mr-2"></i> Mostrar/Ocultar Video de Apoyo</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="video-content hidden" id="video-content">
                        <div class="video-wrapper">
                            <iframe id="video-iframe" allowfullscreen></iframe>
                        </div>
                    </div>
                </div>
                <div id="image-section-container" class="w-full hidden">
                    <div class="video-toggle" id="image-toggle">
                        <span><i class="fas fa-image mr-2"></i> Mostrar/Ocultar Imagen de Apoyo</span>
                        <i class="fas fa-chevron-up"></i>
                    </div>
                    <div id="image-content" class="video-content p-0 bg-transparent" style="margin-top: 1rem;">
                            <div id="image-container" class="rounded-lg shadow-md m-auto">
                               <div id="watermark-overlay"></div>
                            </div>
                    </div>
                </div>
                <div id="text-section-container" class="video-container w-full hidden">
                    <div class="video-toggle" id="text-toggle">
                        <span><i class="fas fa-file-alt mr-2"></i> Mostrar/Ocultar Lectura de Apoyo</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="video-content hidden" id="text-content">
                        </div>
                </div>
                <div class="flex flex-row flex-nowrap items-center justify-between w-full my-2 gap-2 px-1">
                    <button id="mini-prev-btn" class="mini-nav-btn" title="Pregunta Anterior" disabled>
                        <i class="fas fa-chevron-left"></i>
                    </button>

                    <div class="flex flex-row flex-wrap items-center justify-center gap-2">
                        <div id="question-id-tags" class="question-id-tags !m-0">
                            <span id="question-id-display" class="question-id"></span>
                            <span id="uni-tags-display"></span>
                            <span id="level-tag-display"></span>
                        </div>

                        <button id="whiteboard-trigger-btn" class="text-blue-400 hover:text-white transition-all hover:scale-110 p-2 bg-gray-800 bg-opacity-80 rounded-full w-10 h-10 flex items-center justify-center border border-blue-400 shadow-lg" title="Abrir Pizarra de Cálculos">
                            <i class="fas fa-pen-to-square"></i>
                        </button>
                    </div>

                    <button id="mini-next-btn" class="mini-nav-btn" title="Siguiente Pregunta" disabled>
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div id="options-container" class="w-full space-y-3"></div>
                <div id="justification-box" class="justification w-full hidden">
                    <h4>Justificación:</h4>
                    <p id="justification-text"></p>
                </div>
            </div>
            <div id="action-buttons" class="mt-6 space-y-3">
                <div class="grid grid-cols-2 gap-3">
                    <button id="hint-btn" class="btn btn-hint w-full">💡 PISTA</button>
                    <button id="evaluate-btn" class="btn btn-primary w-full" disabled>
                        <span class="evaluate-emoji">🤨</span> EVALUAR
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="prev-btn" class="btn btn-secondary w-full">← ANTERIOR</button>
                    <button id="next-btn" class="btn btn-secondary w-full" disabled>SIGUIENTE →</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <button id="skip-btn" class="btn btn-secondary w-full">OMITIR REACTIVO</button>
                    <button id="finish-btn" class="btn btn-secondary w-full hidden btn-disabled" disabled>EVALUAR AVANCE (0/10)</button>
                </div>
            </div>
            <div id="all-questions-completed-message" class="mt-6 space-y-3 hidden">
                <div class="p-4 bg-gradient-to-r from-green-500 to-blue-500 rounded-lg text-center">
                    <div class="text-2xl mb-2">🎉FELICIDADES🎉</div>
                    <div class="text-lg mb-3">Has concluido todas las preguntas con estos filtros. Evalúa tu avance 😉. ¡MUCHO ÉXITO! 😎</div>
                    <button id="force-evaluate-btn" class="btn btn-primary w-full">EVALUAR AVANCE</button>
                </div>
            </div>
            <div id="calculator-section" class="w-full">
                <div id="calculator-toggle">
                    <span><i class="fas fa-calculator mr-2"></i> Calculadora</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="calculator-content" class="hidden">
                    <div class="calculator-container">
                        <div class="calculator-display" id="calc-display">0</div>
                        <div class="calculator-buttons">
                            <button class="calculator-btn clear" data-value="C">C</button>
                            <button class="calculator-btn special" data-value="√">√</button>
                            <button class="calculator-btn operator" data-value="/">÷</button>
                            <button class="calculator-btn operator" data-value="*">×</button>
                            <button class="calculator-btn" data-value="7">7</button>
                            <button class="calculator-btn" data-value="8">8</button>
                            <button class="calculator-btn" data-value="9">9</button>
                            <button class="calculator-btn operator" data-value="-">-</button>
                            <button class="calculator-btn" data-value="4">4</button>
                            <button class="calculator-btn" data-value="5">5</button>
                            <button class="calculator-btn" data-value="6">6</button>
                            <button class="calculator-btn operator" data-value="+">+</button>
                            <button class="calculator-btn" data-value="1">1</button>
                            <button class="calculator-btn" data-value="2">2</button>
                            <button class="calculator-btn" data-value="3">3</button>
                            <button class="calculator-btn equals" data-value="=">=</button>
                            <button class="calculator-btn zero" data-value="0">0</button>
                            <button class="calculator-btn" data-value=".">.</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chatbot-section" class="w-full">
                <div id="chatbot-toggle">
                    <span><i class="fas fa-robot mr-2"></i> Túul  tu Chatbot de Ayuda</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="chatbot-content" class="hidden">
                    <div class="chatbot-container">
                        <h2 class="chatbot-title">Túul – Asistente de IA 🤖</h2>
                        <p class="graphing-subtitle">Escribe solo un concepto para conocer su significado, por ejemplo: <b>MITOCONDRIA</b></p>
                        <div id="chatbot-chat">
                            <p class="chatbot-system">Hola 🖐 soy Túul, tu asistente de IA para resolver dudas. Escribe un concepto para conocer su significado.</p>
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="chatbot-input" placeholder="Ej. mitocondria">
                            <button id="chatbot-send">Consultar</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="graphing-tool-section" class="w-full">
                <div id="graphing-tool-toggle">
                    <span><i class="fas fa-chart-line mr-2"></i> Visualizador de Ecuaciones</span>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="graphing-tool-content" class="hidden">
                    <div class="graphing-container">
                        <h2 class="graphing-title">Visualizador de Ecuaciones en el Plano Cartesiano</h2>
                        <p class="graphing-subtitle">Explora funciones lineales, cuadráticas, cúbicas, trigonométricas, cónicas y más</p>
                        <div class="graphing-main-content">
                            <div class="graphing-canvas-container">
                                <h3 class="graphing-section-title">Gráfica de la Ecuación</h3>
                                <div class="canvas-container">
                                    <canvas id="equationChart" style="width: 100%; height: 100%;"></canvas>
                                </div>
                                <div class="graphing-zoom-controls">
                                    <button class="zoom-btn" id="zoom-out-btn" title="Alejar (Zoom Out)">-</button>
                                    <span class="scale-indicator" id="scale-indicator">Escala: ±10</span>
                                    <button class="zoom-btn" id="zoom-in-btn" title="Acercar (Zoom In)">+</button>
                                </div>
                            </div>
                            <div class="graphing-controls-container">
                                <h3 class="graphing-section-title">Controles de la Función</h3>
                                <div class="graphing-function-buttons" id="graphingFunctionButtons">
                                </div>
                                <div class="graphing-form-toggle" id="graphingFormToggle">
                                </div>
                                <div class="graphing-equation-display">
                                    <h3>Ecuación Actual</h3>
                                    <div class="graphing-equation" id="graphingCurrentEquation">y = x</div>
                                </div>
                                <div class="graphing-param-controls" id="graphingParamControls">
                                </div>
                                <div class="graphing-section-title" style="margin-top: 20px;">Marcar Coordenadas</div>
                                <div class="graphing-param-group" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                    <div>
                                        <label for="coord-x1">X1</label>
                                        <input type="number" id="coord-x1" step="any" class="graphing-param-input">
                                    </div>
                                    <div>
                                        <label for="coord-y1">Y1</label>
                                        <input type="number" id="coord-y1" step="any" class="graphing-param-input">
                                    </div>
                                    <div>
                                        <label for="coord-x2">X2</label>
                                        <input type="number" id="coord-x2" step="any" class="graphing-param-input">
                                    </div>
                                    <div>
                                        <label for="coord-y2">Y2</label>
                                        <input type="number" id="coord-y2" step="any" class="graphing-param-input">
                                    </div>
                                    <div>
                                        <label for="coord-x3">X3</label>
                                        <input type="number" id="coord-x3" step="any" class="graphing-param-input">
                                    </div>
                                    <div>
                                        <label for="coord-y3">Y3</label>
                                        <input type="number" id="coord-y3" step="any" class="graphing-param-input">
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 10px;">
                                    <button class="graphing-btn graphing-btn-secondary" id="mark-coords-btn">Marcar Coordenadas</button>
                                    <button class="graphing-btn graphing-btn-secondary" id="clear-coords-btn">Limpiar Marcas</button>
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="graphing-btn graphing-btn-primary" id="project-line-btn" disabled>Unir y proyectar</button>
                                </div>
                                <div class="graphing-section-title" style="margin-top: 20px;">Graficar Expresión Algebraica</div>
                                <div class="graphing-param-group">
                                    <label for="algebraic-expression">Expresión (en términos de x, ej: x^2 + 3*x - 5)</label>
                                    <input type="text" id="algebraic-expression" class="graphing-param-input" placeholder="x^2 + sin(x)">
                                </div>
                                <div style="margin-top: 10px; display: flex; gap: 10px;">
                                    <button class="graphing-btn graphing-btn-primary" id="plot-expression-btn" style="flex: 1;">Graficar Expresión</button>
                                    <button class="graphing-btn graphing-btn-secondary" id="clear-expression-btn" style="background: #f44336; border-color: #d32f2f;">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                                <div class="graphing-controls-footer">
                                    <button class="graphing-btn graphing-btn-secondary" id="graphingResetBtn">Restablecer</button>
                                    <button class="graphing-btn graphing-btn-primary" id="graphingUpdateBtn">Actualizar Gráfica</button>
                                </div>
                            </div>
                        </div>
                        <div class="graphing-info-box">
                            <h4>Instrucciones:</h4>
                            <p>1. Selecciona el tipo de función que deseas visualizar.</p>
                            <p>2. Ingresa los valores de los parámetros manualmente.</p>
                            <p>3. Alterna entre forma canónica y general usando los botones.</p>
                            <p>4. Haz clic en "Actualizar Gráfica" para ver los cambios.</p>
                            <p>5. Usa los botones +/- para ajustar el zoom del gráfico (±5, ±10, ±15, ±20, ±25, ±30, ±35, ±40, ±45, ±50).</p>
                            <p>6. <strong>Para graficar expresiones algebraicas:</strong> escribe una expresión en términos de x (ej: x^2 + 3*x - 5) y haz clic en "Graficar Expresión".</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4 grid grid-cols-2 gap-3">
                 <button id="cancel-btn" class="btn btn-secondary w-full text-sm">VOLVER AL MENÚ</button>
                 <a href="https://wa.link/kz8tbd" target="_blank" id="report-btn" class="btn btn-secondary w-full text-sm">REPORTAR ERROR</a>
            </div>
        </div>
        <div id="results-screen" class="card p-4 sm:p-8 text-center hidden">
            <h1 class="text-2xl sm:text-3xl font-bold">¡Resultados Finales!</h1>
            <div id="result-image-container">
                <img id="result-image" src="" alt="Imagen de resultado">
            </div>
            <div class="flex flex-col lg:flex-row justify-around items-center gap-6 my-6">
                <div class="w-full lg:w-1/2"><canvas id="results-chart"></canvas></div>
                <div class="text-left space-y-2">
                    <p class="text-xl font-medium">Calificación: <span id="final-score" class="font-bold text-blue-400"></span></p>
                    <p>Tiempo total: <span id="total-time" class="font-semibold"></span></p>
                    <p>Tiempo promedio: <span id="avg-time" class="font-semibold"></span></p>
                    <p class="text-green-400">Correctas: <span id="correct-count" class="font-semibold"></span></p>
                    <p class="text-red-400">Incorrectas: <span id="incorrect-count" class="font-semibold"></span></p>
                    <p class="text-yellow-400">Omitidas: <span id="omitted-count" class="font-semibold"></span></p>
                    <p class="text-gray-400">No identificadas: <span id="unanswered-count" class="font-semibold"></span></p>
                </div>
            </div>
             <div class="mt-8 overflow-x-auto">
                <h3 class="text-xl font-bold mb-4">Resumen de Respuestas</h3>
                <table id="results-table" class="w-full text-sm text-left">
                    <thead class="text-xs uppercase bg-gray-700">
                        <tr>
                            <th scope="col" class="px-4 py-3">Reactivo</th>
                            <th scope="col" class="px-4 py-3">Pregunta</th>
                            <th scope="col" class="px-4 py-3">Tu Respuesta</th>
                            <th scope="col" class="px-4 py-3">Correcta</th>
                            <th scope="col" class="px-4 py-3">Resultado</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="summary-box" class="card p-6 mt-8 text-left bg-gray-700">
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold mb-4">Resumen de la Evaluación</h3>
                </div>
                <div class="space-y-2">
                    <p><strong>Nombre del Cuestionario:</strong> <span id="summary-eval-name"></span></p>
                    <p><strong>Fecha de Realización:</strong> <span id="summary-date"></span></p>
                    <p><strong>Resultado:</strong> <span id="summary-score" class="font-bold"></span></p>
                    <div>
                        <p><strong>IDs de esta Evaluación:</strong></p>
                        <p id="summary-ids" class="text-xs text-gray-400 break-words"></p>
                    </div>
                    <div>
                        <p><strong>IDs Acumulados:</strong></p>
                        <p id="summary-ids-acumulados" class="text-xs text-gray-400 break-words"></p>
                    </div>
                </div>
            </div>
            <div class="mt-8 space-y-2">
                <label for="answered-ids-output" class="font-medium">Estos son los id´s solo de los ejercicios correctamente respondidos en esta evaluación, cópialos si deseas que no aparezcan estos ejercicios en la siguiente evaluación que realices:</label>
                <div class="flex gap-2">
                    <textarea id="answered-ids-output" rows="4" class="w-full p-3 bg-gray-700 rounded-lg border border-gray-600 text-white" readonly></textarea>
                    <button id="copy-ids-btn" class="btn btn-secondary">Copiar</button>
                </div>
            </div>
            <button id="restart-quiz-btn" class="btn btn-primary w-full sm:w-auto mt-8">Hacer otro cuestionario</button>
        </div>
    </div>
    <div id="footer">
        <div id="footer-content">
            <div id="footer-links">
                <a href="https://simuladores.cepredix.com.mx/cepredix.html" target="_blank" class="footer-link social-link">
                    <i class="fas fa-globe"></i> WEB CEPREDIX
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.facebook.com/cepredix/" target="_blank" class="footer-link social-link">
                    <i class="fab fa-facebook"></i> Facebook
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.instagram.com/cepredix/" target="_blank" class="footer-link social-link">
                    <i class="fab fa-instagram"></i> Instagram
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.tiktok.com/@cepredix" target="_blank" class="footer-link social-link">
                    <i class="fab fa-tiktok"></i> TikTok
                </a>
                <span class="text-gray-500">|</span>

                <a href="https://www.youtube.com/@Cepredix" target="_blank" class="footer-link social-link">
                    <i class="fab fa-youtube"></i> YouTube
                </a>
                <span class="text-gray-500">|</span>

                <a href="#" id="privacy-link" class="footer-link">Aviso de Privacidad</a>
            </div>
            <div id="copyright">
                &copy; CEPREDIX 2026 - Todos los derechos reservados. Versión CEP-2.1501
            </div>
        </div>
    </div>
<div id="overlay-whiteboard" class="fixed inset-0 z-[9999] hidden" style="touch-action: none;">
        <div class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-none"></div>
        
        <canvas id="wb-canvas" class="absolute inset-0 w-full h-full cursor-crosshair"></canvas>

        <button id="wb-close-btn" class="absolute top-4 right-4 bg-red-600 hover:bg-red-700 text-white rounded-full w-10 h-10 flex items-center justify-center shadow-lg transition-transform hover:scale-110 z-50">
            <i class="fas fa-times"></i>
        </button>

        <div class="absolute bottom-6 left-1/2 transform -translate-x-1/2 bg-gray-900 border border-gray-700 p-2 rounded-full flex items-center gap-1 sm:gap-3 shadow-2xl z-50 overflow-x-auto max-w-[98%] sm:max-w-max">
            
            <button class="wb-tool-btn w-8 h-8 rounded-full border-2 border-white bg-white hover:scale-110 transition-transform shrink-0" data-color="#ffffff" title="Blanco"></button>
            <button class="wb-tool-btn w-8 h-8 rounded-full border-2 border-gray-600 bg-[#39ff14] hover:scale-110 transition-transform shadow-[0_0_10px_#39ff14] shrink-0" data-color="#39ff14" title="Verde Neón"></button>
            <button class="wb-tool-btn w-8 h-8 rounded-full border-2 border-gray-600 bg-[#ff073a] hover:scale-110 transition-transform shadow-[0_0_10px_#ff073a] shrink-0" data-color="#ff073a" title="Rojo Neón"></button>
            
            <button id="wb-eraser-btn" class="w-8 h-8 rounded-full border-2 border-gray-500 bg-gray-700 text-white hover:scale-110 transition-transform flex items-center justify-center ml-1 shrink-0" title="Borrador">
                <i class="fas fa-eraser text-xs"></i>
            </button>

            <div class="w-px h-6 bg-gray-600 mx-1 shrink-0"></div>

            <div class="flex items-center gap-1 sm:gap-2 px-1 shrink-0" title="Ajustar grosor">
                <i class="fas fa-circle text-[4px] text-gray-400 hidden sm:block"></i>
                <input type="range" id="wb-width-slider" min="1" max="10" value="2" class="w-16 sm:w-24 cursor-pointer h-1 bg-gray-600 rounded-lg appearance-none">
                <i class="fas fa-circle text-[10px] text-gray-400 hidden sm:block"></i>
            </div>

            <div class="w-px h-6 bg-gray-600 mx-1 shrink-0"></div>

            <button id="wb-undo-btn" class="text-gray-300 hover:text-white p-2 shrink-0" title="Deshacer">
                <i class="fas fa-undo"></i>
            </button>
            <button id="wb-redo-btn" class="text-gray-300 hover:text-white p-2 shrink-0" title="Rehacer">
                <i class="fas fa-redo"></i>
            </button>
            
            <div class="w-px h-6 bg-gray-600 mx-1 shrink-0"></div>

            <button id="wb-clear-btn" class="text-red-400 hover:text-red-300 p-2 shrink-0" title="Borrar todo">
                <i class="fas fa-trash-alt"></i>
            </button>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const QUIZ_JSON_URL = 'https://raw.githubusercontent.com/IALUMX/Bancos_prueba/refs/heads/main/00-json-prueba-v2-170126.json';
            const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS5sU2hYNByYHNDESXxZPoe3dikV115hY_TII15wZtF8E0NWBFmnLSW2ad7ZqDdwk-jTPQfX-92n6zQ/pub?gid=0&single=true&output=csv';
            const CORS_PROXY_URL = 'https://corsproxy.io/?' + encodeURIComponent(GOOGLE_SHEET_URL);
            const RESULTS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxYESY3dBy0h5QrY5EyJ_jfHwlEwnhByFcPTywwK4jJhGa3rvrnIzR9OXleZUZ7zVqUqw/exec';
            const SUBMISSION_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxF2v5plRObokCgrV-3olVosjn-3q08B9bMUpeLMuYXyzuiRmsKAEadMUMb-WH2Dg7F/exec';
            const RESULT_IMAGES = {
                less7: 'https://i.imgur.com/pyBFfO9.png',
                between7_8: 'https://i.imgur.com/eMPH60B.png',
                between8_9: 'https://i.imgur.com/OY5wmBo.png',
                between9_9_5: 'https://i.imgur.com/uLpyVoj.png',
                between9_5_10: 'https://i.imgur.com/89lj6aD.png',
                perfect10: 'https://i.imgur.com/HGyyYIC.png'
            };
            const ADS_CSV_URL = "https://docs.google.com/spreadsheets/d/1VkMosrVw7vJdZqGvInDcu3oKlK7WZlTrWAnH2YHqrew/export?format=csv&gid=0";
            
            const screens = {
                login: document.getElementById('login-screen'),
                setup: document.getElementById('setup-screen'),
                quiz: document.getElementById('quiz-screen'),
                results: document.getElementById('results-screen'),
            };
            const loginForm = document.getElementById('login-form');
            const nameInput = document.getElementById('name-input');
            const emailInput = document.getElementById('email-input');
            const whatsappInput = document.getElementById('whatsapp-input');
            const loginBtn = document.getElementById('login-btn');
            const loginBtnText = document.getElementById('login-btn-text');
            const loginBtnSpinner = document.getElementById('login-btn-spinner');
            const loginErrorMessage = document.getElementById('login-error-message');
            const guestLoginBtn = document.getElementById('guest-login-btn');
            const noAccessBtn = document.querySelector('a[href="https://wa.link/i5rp89"]');
            const welcomeName = document.getElementById('welcome-name');
            const gameModeToggle = document.getElementById('game-mode-toggle');
            const continuousModeToggle = document.getElementById('continuous-mode-toggle');
           const uniTagsContainer = document.getElementById('uni-tags-container');
            const levelTagsContainer = document.getElementById('level-tags-container');
            const typeTagsContainer = document.getElementById('type-tags-container');
            const answeredIdsInput = document.getElementById('answered-ids-input');
            const statsTotal = document.getElementById('stats-total');
            const statsTotalFiltered = document.getElementById('stats-total-filtered');
            const statsRemainingFiltered = document.getElementById('stats-remaining-filtered');
            const startQuizBtn = document.getElementById('start-quiz-btn');
            const errorMessage = document.getElementById('error-message');
            const currentQuestionNum = document.getElementById('current-question-num');
            const totalQuestionsNum = document.getElementById('total-questions-num');
            const liveCorrect = document.getElementById('live-correct');
            const liveIncorrect = document.getElementById('live-incorrect');
            const timerDisplay = document.getElementById('timer');
            const timerContainer = document.getElementById('timer-container');
            const progressBar = document.getElementById('progress-bar');
            const questionText = document.getElementById('question-text');
            const questionIdDisplay = document.getElementById('question-id-display');
            const uniTagsDisplay = document.getElementById('uni-tags-display');
            const levelTagDisplay = document.getElementById('level-tag-display');
            const imageContainer = document.getElementById('image-container');
            const watermarkOverlay = document.getElementById('watermark-overlay');
            const optionsContainer = document.getElementById('options-container');
            const justificationBox = document.getElementById('justification-box');
            const justificationText = document.getElementById('justification-text');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            const skipBtn = document.getElementById('skip-btn');
            const hintBtn = document.getElementById('hint-btn');
            const cancelBtn = document.getElementById('cancel-btn');
            const finishBtn = document.getElementById('finish-btn');
            const resultImage = document.getElementById('result-image');
            const finalScore = document.getElementById('final-score');
            const totalTime = document.getElementById('total-time');
            const avgTime = document.getElementById('avg-time');
            const correctCount = document.getElementById('correct-count');
            const incorrectCount = document.getElementById('incorrect-count');
            const omittedCount = document.getElementById('omitted-count');
            const unansweredCount = document.getElementById('unanswered-count');
            const resultsTableBody = document.querySelector('#results-table tbody');
            const answeredIdsOutput = document.getElementById('answered-ids-output');
            const copyIdsBtn = document.getElementById('copy-ids-btn');
            const restartQuizBtn = document.getElementById('restart-quiz-btn');
            const resultsChartCanvas = document.getElementById('results-chart');
            const summaryEvalName = document.getElementById('summary-eval-name');
            const summaryDate = document.getElementById('summary-date');
            const summaryScore = document.getElementById('summary-score');
            const summaryIds = document.getElementById('summary-ids');
            const summaryIdsAcumulados = document.getElementById('summary-ids-acumulados');
            const calculatorToggle = document.getElementById('calculator-toggle');
            const calculatorContent = document.getElementById('calculator-content');
            const calculatorDisplay = document.getElementById('calc-display');
            const lookupIdInput = document.getElementById('lookup-id-input');
            const lookupBtn = document.getElementById('lookup-btn');
            const lookupResultContainer = document.getElementById('lookup-result-container');
            const lookupToggle = document.getElementById('lookup-toggle');
            const lookupSectionContent = document.getElementById('lookup-section-content');
            const gameModeRules = document.getElementById('game-mode-rules');
            const gameModeLivesDisplay = document.getElementById('game-mode-lives');
            const videoContainer = document.getElementById('video-container');
            const videoToggle = document.getElementById('video-toggle');
            const videoContent = document.getElementById('video-content');
            const videoIframe = document.getElementById('video-iframe');
            const evaluateBtn = document.getElementById('evaluate-btn');
            const allQuestionsCompletedMessage = document.getElementById('all-questions-completed-message');
            const forceEvaluateBtn = document.getElementById('force-evaluate-btn');
            const welcomeVideoToggle = document.getElementById('welcome-video-toggle');
            const welcomeVideoContent = document.getElementById('welcome-video-content');
            const imageSectionContainer = document.getElementById('image-section-container');
            const imageToggle = document.getElementById('image-toggle');
            const imageContent = document.getElementById('image-content');
            const volumeIndicatorSetup = document.getElementById('volume-indicator-setup');
            const volumeIndicatorQuiz = document.getElementById('volume-indicator-quiz');
            const textSectionContainer = document.getElementById('text-section-container');
            const textToggle = document.getElementById('text-toggle');
            const textContent = document.getElementById('text-content');
            const graphingToolToggle = document.getElementById('graphing-tool-toggle');
            const graphingToolContent = document.getElementById('graphing-tool-content');
            const graphingFunctionButtons = document.getElementById('graphingFunctionButtons');
            const graphingFormToggle = document.getElementById('graphingFormToggle');
            const graphingCurrentEquation = document.getElementById('graphingCurrentEquation');
            const graphingParamControls = document.getElementById('graphingParamControls');
            const graphingResetBtn = document.getElementById('graphingResetBtn');
            const graphingUpdateBtn = document.getElementById('graphingUpdateBtn');
            const equationChartCanvas = document.getElementById('equationChart');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');
            const scaleIndicator = document.getElementById('scale-indicator');
            const correctSound = document.getElementById('correct-sound');
            const incorrectSound = document.getElementById('incorrect-sound');
            const buttonSound = document.getElementById('button-sound');
            const sadViolinSound = document.getElementById('sad-violin-sound');
            const simulacroFail1 = document.getElementById('simulacro-fail-1');
            const simulacroFail2 = document.getElementById('simulacro-fail-2');
            const simulacroSuccess1 = document.getElementById('simulacro-success-1');
            const simulacroSuccess2 = document.getElementById('simulacro-success-2');
            const chatbotToggle = document.getElementById('chatbot-toggle');
            const chatbotContent = document.getElementById('chatbot-content');
            const chatbotChat = document.getElementById('chatbot-chat');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotSend = document.getElementById('chatbot-send');
            const simulacroEndScreen = document.getElementById('simulacro-end-screen');
            const simulacroEndImage = document.getElementById('simulacro-end-image');
            const simulacroEndTimer = document.getElementById('simulacro-end-timer');
            const simulacroReturnBtn = document.getElementById('simulacro-return-btn');
            const markCoordsBtn = document.getElementById('mark-coords-btn');
            const clearCoordsBtn = document.getElementById('clear-coords-btn');
            const projectLineBtn = document.getElementById('project-line-btn');
            const coordX1 = document.getElementById('coord-x1');
            const coordY1 = document.getElementById('coord-y1');
            const coordX2 = document.getElementById('coord-x2');
            const coordY2 = document.getElementById('coord-y2');
            const coordX3 = document.getElementById('coord-x3');
            const coordY3 = document.getElementById('coord-y3');
            const algebraicExpression = document.getElementById('algebraic-expression');
            const plotExpressionBtn = document.getElementById('plot-expression-btn');
            const privacyModal = document.getElementById('privacy-modal');
            const privacyLink = document.getElementById('privacy-link');
            const closePrivacyModal = document.querySelector('.privacy-modal-close');
            const adOverlay = document.getElementById('adOverlay');
            const adImage = document.getElementById('adImage');
            const adAudio = document.getElementById('adAudio');
            const skipBtnAd = document.getElementById('skipBtn');
            const infoBtn = document.getElementById('infoBtn');
            const guestInfoModal = document.getElementById('guest-info-modal');
            const guestInfoForm = document.getElementById('guest-info-form');
            const guestEmailInput = document.getElementById('guest-email-input');
            const guestWhatsappInput = document.getElementById('guest-whatsapp-input');
            const guestEmailError = document.getElementById('guest-email-error');
            const guestWhatsappError = document.getElementById('guest-whatsapp-error');
            const guestSubmitBtn = document.getElementById('guest-submit-btn');
            const guestCancelBtn = document.getElementById('guest-cancel-btn');
            const logoutBtn = document.getElementById('logout-btn');
            const miniPrevBtn = document.getElementById('mini-prev-btn');
            const miniNextBtn = document.getElementById('mini-next-btn');
            
            let allQuestions = [], quizQuestions = [], userAnswers = [], pastedAnsweredIds = new Set();
            let currentQuestionIndex = 0, timer, seconds = 0, resultsChart;
            let currentUser = {};
            let questionStartTime = 0;
            let totalQuestionTime = 0;
            let isGuest = false;
            let isGameMode = false;
            let isContinuousMode = false;
            let gameModeLives = 3;
            let consecutiveCorrect = 0;
            let gameModeTimer;
            let gameModeSeconds = 30 * 60;
            let calculatorValue = '0';
            let calculatorWaitingForOperand = false;
            let calculatorOperator = null;
            let calculatorPreviousValue = '0';
            let effectsVolume = 0.5;
            let evaluateEmojiInterval;
            let answeredIdsInContinuousMode = new Set();
            let availableQuestionsInContinuousMode = [];
            let questionCountInGuestMode = 0;
            let ads = [];
            let totalAvailableQuestions = 0;
            let graphingChart = null;
            let currentGraphingFunction = 'linear';
            let isGraphingCanonical = true;
            let currentScale = 10;
            const MIN_SCALE = 5;
            const MAX_SCALE = 50;
            const SCALE_STEPS = [5, 10, 15, 20, 25, 30, 35, 40, 45, 50];
            let markedCoordinates = [];
            let lineProjectionDataset = null;
            let algebraicDataset = null;
            let guestAds = [];
            let mainBanner = null;
            let pubBanners = [];
            let lastShownAdUrl = null;
            let adTimeoutId = null;
            let adIntervalId = null;
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    if(confirm("¿Estás seguro de que deseas cerrar sesión?")) {
                        localStorage.removeItem('sessionToken');
                        localStorage.removeItem('userEmail');
                        location.reload();
                    }
                });
            }
            
            fetch(ADS_CSV_URL)
                .then(r => r.text())
                .then(csv => {
                    const rows = csv.split("\n").slice(1);
                    rows.forEach(row => {
                        const cols = row.split(",");
                        if (cols.length >= 5) {
                            const item = {
                                Imagen: cols[0].trim(),
                                Audio: cols[1].trim(),
                                Infolink: cols[2].trim(),
                                Tipo: cols[4].trim().replace(/\r/g, "")
                            };

                            if (item.Tipo === "PUB-INVITADO") {
                                guestAds.push(item);
                            } else if (item.Tipo === "BANNER-PRINCIPAL") {
                                mainBanner = item;
                            } else if (item.Tipo === "BANNER-PUB") {
                                pubBanners.push(item);
                            }
                        }
                    });
                    
                    initBannerCycle();
                }).catch(err => {
                    console.error("Error al cargar publicidad:", err);
                });

            function initBannerCycle() {
                const bannerContainer = document.getElementById('banner-container');
                
                if (!mainBanner) { 
                    bannerContainer.style.display = 'none'; 
                    return; 
                }

                bannerContainer.style.display = 'block';
                runMainBanner();
            }

            function runMainBanner() {
                if (!mainBanner) return;
                setBannerContent(mainBanner);

                setTimeout(() => {
                    runPubBanner();
                }, 20000); 
            }

            function runPubBanner() {
                if (pubBanners.length > 0) {
                    const randomPub = pubBanners[Math.floor(Math.random() * pubBanners.length)];
                    setBannerContent(randomPub);
                    
                    setTimeout(() => {
                        runMainBanner();
                    }, 10000);
                } else {
                    runMainBanner();
                }
            }

            function setBannerContent(item) {
                const imgEl = document.getElementById('banner-img');
                const linkEl = document.getElementById('banner-link');
                const audioEl = document.getElementById('banner-audio-player');

                if (imgEl) imgEl.src = item.Imagen;
                
                if (linkEl) {
                    if (item.Infolink && item.Infolink.length > 5) {
                        linkEl.href = item.Infolink;
                        linkEl.style.pointerEvents = "auto";
                        linkEl.style.cursor = "pointer";
                    } else {
                        linkEl.removeAttribute('href');
                        linkEl.style.pointerEvents = "none";
                        linkEl.style.cursor = "default";
                    }
                }

                if (audioEl && item.Audio && item.Audio.length > 5) {
                    audioEl.src = item.Audio;
                    audioEl.play().catch(e => console.log("Audio banner silenciado por navegador")); 
                }
            }

            
            privacyLink.addEventListener('click', (e) => {
                e.preventDefault();
                privacyModal.style.display = 'flex';
            });
            
            closePrivacyModal.addEventListener('click', () => {
                privacyModal.style.display = 'none';
            });
            
            privacyModal.addEventListener('click', (e) => {
                if (e.target === privacyModal) {
                    privacyModal.style.display = 'none';
                }
            });

            function showAd() {
                if (!isGuest || !(isContinuousMode || isGameMode)) return;
                
                if (!guestAds || guestAds.length === 0) return; 

                if (adTimeoutId) clearTimeout(adTimeoutId);
                if (adIntervalId) clearInterval(adIntervalId);

                let candidateAds = guestAds;
                if (guestAds.length > 1 && lastShownAdUrl) {
                    candidateAds = guestAds.filter(ad => ad.Imagen !== lastShownAdUrl);
                }

                const ad = candidateAds[Math.floor(Math.random() * candidateAds.length)];
                lastShownAdUrl = ad.Imagen;

                const adImage = document.getElementById('adImage');
                const adAudio = document.getElementById('adAudio');
                const infoBtn = document.getElementById('infoBtn');
                const skipBtnAd = document.getElementById('skipBtn');
                const adOverlay = document.getElementById('adOverlay');

                if(adImage) adImage.src = ad.Imagen;
                if(adAudio) adAudio.src = ad.Audio;
                
                if(adAudio) {
                    adAudio.play().catch(e => {
                        console.log("Audio no se pudo reproducir automáticamente:", e);
                    });
                }

                if (infoBtn) {
                    if (ad.Infolink && ad.Infolink.length > 5) {
                        infoBtn.href = ad.Infolink;
                        infoBtn.style.pointerEvents = "auto";
                        infoBtn.style.opacity = "1";
                    } else {
                        infoBtn.removeAttribute('href');
                        infoBtn.style.pointerEvents = "none";
                        infoBtn.style.opacity = "0.5";
                    }
                }
                
                if (skipBtnAd) {
                    skipBtnAd.disabled = true;
                    skipBtnAd.style.opacity = "0.5";
                    skipBtnAd.textContent = "Espera 5s...";
                    skipBtnAd.onclick = hideAd;
                }
                
                if (adOverlay) {
                    adOverlay.style.display = "flex";
                    document.body.style.overflow = 'hidden';
                }
                
                let countdown = 5;
                
                adIntervalId = setInterval(() => {
                    countdown--;
                    if (skipBtnAd) {
                        if (countdown > 0) {
                            skipBtnAd.textContent = `Espera ${countdown}s...`;
                        } else {
                            clearInterval(adIntervalId);
                            adIntervalId = null;
                            skipBtnAd.disabled = false;
                            skipBtnAd.style.opacity = "1";
                            skipBtnAd.textContent = "Saltar Publicidad";
                        }
                    }
                }, 1000);
                
                adTimeoutId = setTimeout(hideAd, 25000);
            }
            
            function hideAd() {
                if (adTimeoutId) {
                    clearTimeout(adTimeoutId);
                    adTimeoutId = null;
                }
                if (adIntervalId) {
                    clearInterval(adIntervalId);
                    adIntervalId = null;
                }

                const adAudio = document.getElementById('adAudio');
                if(adAudio) {
                    adAudio.pause();
                    adAudio.currentTime = 0;
                }

                const adOverlay = document.getElementById('adOverlay');
                if(adOverlay) {
                    adOverlay.style.display = "none";
                }
                
                document.body.style.overflow = 'auto'; 
            }

            chatbotSend.addEventListener('click', async function() {
                const concepto = chatbotInput.value.trim();
                if (!concepto) return;
                
                chatbotChat.innerHTML += `<p class="chatbot-user"><b>Tú:</b> ${concepto}</p>`;
                chatbotInput.value = "";
                chatbotChat.scrollTop = chatbotChat.scrollHeight;

                try {
                    chatbotChat.innerHTML += `<p class="chatbot-system">Consultando...</p>`;
                    
                    const response = await fetch(
                        "https://chatbot-uni-html.contacto-cepredix.workers.dev",
                        {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({ concepto: concepto })
                        }
                    );
                    
                    const data = await response.json();
                    
                    const chatMessages = chatbotChat.querySelectorAll('p');
                    if (chatMessages.length > 0 && chatMessages[chatMessages.length - 1].textContent.includes('Consultando...')) {
                        chatMessages[chatMessages.length - 1].remove();
                    }
                    
                    chatbotChat.innerHTML += `<p class="chatbot-bot"><b>Túul:</b> ${data.respuesta}</p>`;
                } catch (error) {
                    chatbotChat.innerHTML += `<p class="chatbot-bot"><b>Túul:</b> Error al conectar con el chatbot.</p>`;
                }
                chatbotChat.scrollTop = chatbotChat.scrollHeight;
            });
            
            chatbotInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    chatbotSend.click();
                }
            });

            chatbotToggle.addEventListener('click', () => {
                if (isGuest) {
                    return; 
                }
                const isHidden = chatbotContent.classList.toggle('hidden');
                const icon = chatbotToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (isHidden) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });
            
            function showSimulacroEndScreen() {
                simulacroEndImage.src = 'https://raw.githubusercontent.com/IALUMX/img_cepredix/refs/heads/main/Final_simulacro.png';
                simulacroEndScreen.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                correctSound.pause();
                incorrectSound.pause();
                buttonSound.pause();
                sadViolinSound.pause();
                simulacroFail1.pause();
                simulacroFail2.pause();
                simulacroSuccess1.pause();
                simulacroSuccess2.pause();
                
                const failSounds = [simulacroFail1, simulacroFail2];
                const randomFailSound = failSounds[Math.floor(Math.random() * failSounds.length)];
                if (effectsVolume > 0) {
                    randomFailSound.currentTime = 0;
                    randomFailSound.volume = 0.3;
                    randomFailSound.play().catch(e => console.error("Error al reproducir sonido de fallo:", e));
                }
                let countdown = 10;
                simulacroEndTimer.textContent = `Volviendo al menú en ${countdown} segundos...`;
                const countdownInterval = setInterval(() => {
                    countdown--;
                    simulacroEndTimer.textContent = `Volviendo al menú en ${countdown} segundos...`;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        returnToMenuFromSimulacro();
                    }
                }, 1000);
                simulacroReturnBtn.onclick = returnToMenuFromSimulacro;
            }
            
            function returnToMenuFromSimulacro() {
                simulacroEndScreen.style.display = 'none';
                document.body.style.overflow = 'auto';
                screens.quiz.classList.add('hidden');
                screens.setup.classList.remove('hidden');
                clearInterval(gameModeTimer);
                
                correctSound.pause();
                incorrectSound.pause();
                buttonSound.pause();
                sadViolinSound.pause();
                simulacroFail1.pause();
                simulacroFail2.pause();
                simulacroSuccess1.pause();
                simulacroSuccess2.pause();
            }
            
            async function validateUserAccess(name, email, whatsapp) {
                if (isGuest) return true;
                
                try {
                    const timestamp = new Date().getTime();
                    const freshSheetUrl = GOOGLE_SHEET_URL + '&v=' + timestamp;
                    const freshProxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(freshSheetUrl);
                    
                    const responseCsv = await fetch(freshProxyUrl);
                    const csvText = await responseCsv.text();
                    
                    const rows = csvText.split('\n').map(row => row.split(',').map(c => c.trim()));

                    const cleanEmail = email.trim().toLowerCase();
                    const cleanWhatsapp = whatsapp.trim().replace(/\D/g, '');
                    
                    for (let i = 1; i < rows.length; i++) {
                        const cols = rows[i];
                        if (cols.length < 3) continue;

                        const rowEmail = cols[1] ? cols[1].toLowerCase() : "";
                        const rowWhatsapp = cols[2] ? cols[2].replace(/\D/g, '') : "";
                        
                        if (rowEmail === cleanEmail && rowWhatsapp === cleanWhatsapp) {
                            const status = cols[6] ? cols[6].toUpperCase().replace(/[^A-Z]/g, '') : 'ACTIVO';
                            
                            if (status === 'INACTIVO') {
                                if(loginErrorMessage) {
                                    loginErrorMessage.style.color = "#ff5722";
                                    loginErrorMessage.textContent = "En estos momentos no tienes acceso al banco de preguntas y simulacros, por favor contacta al administrador del curso 😥";
                                }
                                return false;
                            }
                            break;
                        }
                    }

                    const formData = new FormData();
                    formData.append('action', 'login');
                    formData.append('email', email);
                    formData.append('whatsapp', whatsapp);

                    const response = await fetch(RESULTS_SCRIPT_URL, {
                        method: 'POST',
                        body: formData,
                        redirect: 'follow' 
                    });
                    
                    const textResponse = await response.text();
                    
                    let data;
                    try {
                        data = JSON.parse(textResponse);
                    } catch (e) {
                        console.error("Error respuesta servidor:", textResponse);
                        alert("Error técnico al procesar respuesta del servidor.");
                        return false;
                    }
                    
                    if (data.success) {
                        localStorage.setItem('sessionToken', data.token);
                        localStorage.setItem('userEmail', email);
                        
                        if(data.name) currentUser.name = data.name; 
                        
                        startSessionCheck();
                        return true;
                    } else {
                        if(loginErrorMessage) {
                            loginErrorMessage.style.color = "#f87171";
                            loginErrorMessage.textContent = data.message;
                        }
                        return false;
                    }
                } catch (error) {
                    console.error('Error de red o conexión:', error);
                    alert("Error de conexión: " + error.message); 
                    return false;
                }
            }
			let sessionInterval;

            function startSessionCheck() {
                if (isGuest) return;
                
                if (sessionInterval) clearInterval(sessionInterval);

                sessionInterval = setInterval(async () => {
                    const token = localStorage.getItem('sessionToken');
                    const email = localStorage.getItem('userEmail');
                    
                    if (!token || !email) return;

                    try {
                        const formData = new FormData();
                        formData.append('action', 'check_session');
                        formData.append('email', email);
                        formData.append('token', token);

                        const response = await fetch(RESULTS_SCRIPT_URL, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        
                        if (data.valid === false) {
                            clearInterval(sessionInterval);
                            alert("⚠️ SE HA DETECTADO UNA NUEVA SESIÓN.\n\nTu cuenta ha sido abierta en otro dispositivo o navegador.\nEsta sesión se cerrará automáticamente.");
                            window.location.reload();
                        }
                    } catch (e) {
                        console.log("Error verificando sesión (puede ser red inestable), reintentando luego...");
                    }
                }, 20000);
            }

            function updateEvaluationButton() {
                if (!finishBtn) return;
                
                // El botón debe ser visible tanto en modo continuo como en modo normal
                // Solo se oculta si estamos en "Modo Simulacro Mortal"
                if (isGameMode) {
                    finishBtn.classList.add('hidden');
                    return;
                }

                // Aseguramos que sea visible
                finishBtn.classList.remove('hidden');
                
                // Contamos cuántas preguntas tienen una respuesta (correcta, incorrecta, omitida o no identificada)
                const answeredCount = userAnswers.filter(a => a.status !== 'unanswered').length;
                const minQuestionsRequired = 10;
                
                if (answeredCount < minQuestionsRequired) {
                    // Si hay menos de 10, el botón se muestra pero está deshabilitado
                    finishBtn.disabled = true;
                    finishBtn.classList.add('btn-disabled');
                    finishBtn.style.opacity = "0.5"; 
                    finishBtn.style.cursor = "not-allowed";
                    finishBtn.innerHTML = `<i class="fas fa-lock"></i> EVALUAR AVANCE (${answeredCount}/${minQuestionsRequired})`;
                } else {
                    // Si ya respondió 10 o más, el botón se habilita y cambia de color
                    finishBtn.disabled = false;
                    finishBtn.classList.remove('btn-disabled');
                    finishBtn.style.opacity = "1";
                    finishBtn.style.cursor = "pointer";
                    // Le ponemos un color llamativo (azul/celeste) para indicar que ya puede finalizar
                    finishBtn.style.background = "linear-gradient(45deg, #2196F3, #21CBF3)";
                    finishBtn.innerHTML = `<i class="fas fa-check-circle"></i> EVALUAR AVANCE (${answeredCount} RESPONDIDAS)`;
                }
            }

            function startEvaluateEmojiAnimation() {
                const emojis = ['🤨', '🙂', '😮', '😫', '😎'];
                let index = 0;
                if (evaluateEmojiInterval) {
                    clearInterval(evaluateEmojiInterval);
                }
                evaluateEmojiInterval = setInterval(() => {
                    const emojiSpan = evaluateBtn.querySelector('.evaluate-emoji');
                    if (emojiSpan) {
                        index = (index + 1) % emojis.length;
                        emojiSpan.textContent = emojis[index];
                    }
                }, 200);
            }
            
            function stopEvaluateEmojiAnimation() {
                if (evaluateEmojiInterval) {
                    clearInterval(evaluateEmojiInterval);
                    evaluateEmojiInterval = null;
                    const emojiSpan = evaluateBtn.querySelector('.evaluate-emoji');
                    if (emojiSpan) {
                        emojiSpan.textContent = '✅';
                    }
                }
            }

            function evaluateCurrentAnswer() {
                const currentAnswer = userAnswers[currentQuestionIndex];
                const { question } = currentAnswer;
                const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
                totalQuestionTime += timeSpent;
                
                let isCorrect = false;
                let selectedTextForReport = "";
                let statusResult = 'incorrect';

                // Detectar si es híbrido
                const isHybrid = question.options.some(opt => 'text_op1' in opt);

                if (isHybrid) {
                    const sel1 = optionsContainer.querySelector('.option-btn[data-group="1"].selected');
                    const sel2 = optionsContainer.querySelector('.option-btn[data-group="2"].selected');
                    
                    const val1 = sel1 ? sel1.dataset.text : "Sin responder";
                    const val2 = sel2 ? sel2.dataset.text : "Sin responder";
                    
                    selectedTextForReport = `[1]: ${val1} | [2]: ${val2}`;

                    const correctOp1 = question.options.find(o => 'text_op1' in o && o.correct)?.text_op1;
                    const correctOp2 = question.options.find(o => 'text_op2' in o && o.correct)?.text_op2;

                    // Lógica estricta: Ambas deben ser correctas y NO ser la opción de "No puedo identificar"
                    const hit1 = (val1 === correctOp1);
                    const hit2 = (val2 === correctOp2);

                    if (val1.includes("No puedo identificar") || val2.includes("No puedo identificar")) {
                        statusResult = 'unidentified';
                    } else if (hit1 && hit2) {
                        isCorrect = true;
                        statusResult = 'correct';
                    } else {
                        statusResult = 'incorrect';
                    }

                } else {
                    // Lógica Estándar
                    const selectedButton = optionsContainer.querySelector('.option-btn.selected');
                    const selectedOption = selectedButton ? selectedButton.dataset.text : "No puedo identificar la respuesta 😥";
                    selectedTextForReport = selectedOption;

                    const correctOption = question.options.find(opt => opt.correct);
                    isCorrect = correctOption && correctOption.text === selectedOption;

                    if (selectedOption.includes("No puedo identificar")) {
                        statusResult = 'unidentified';
                    } else if (isCorrect) {
                        statusResult = 'correct';
                    } else {
                        statusResult = 'incorrect';
                    }
                }
                
                // Actualizar respuesta
                currentAnswer.selected = selectedTextForReport;
                currentAnswer.timeSpent = timeSpent;
                currentAnswer.status = statusResult;

                // --- BLOQUE DE SONIDOS Y VIDAS (Igual que antes) ---
                if (statusResult === 'unidentified') {
                    if (effectsVolume > 0) {
                        incorrectSound.currentTime = 0;
                        incorrectSound.volume = effectsVolume;
                        incorrectSound.play().catch(e => console.error(e));
                    }
                    if (isGameMode) handleGameModeLifeLoss();

                } else if (statusResult === 'correct') {
                    if (effectsVolume > 0) {
                        correctSound.currentTime = 0;
                        correctSound.volume = effectsVolume;
                        correctSound.play().catch(e => console.error(e));
                    }
                    if (isGameMode) {
                        consecutiveCorrect++;
                        // Si es híbrido cuenta doble en la mente del usuario, pero en sistema es 1 acierto lógico. 
                        // Sin embargo, podemos dar doble bonificación de racha si lo deseas, 
                        // pero para mantener simpleza, mantendremos +1 a la racha normal.
                        if (consecutiveCorrect >= 3) {
                            if (gameModeLives < 3) {
                                gameModeLives++;
                                showTemporaryMessage("¡3 aciertos seguidos! +1 Vida ❤️", "bg-green-600");
                            }
                            consecutiveCorrect = 0;
                            updateGameModeLivesDisplay();
                        }
                    }
                } else {
                    // Incorrecto
                    if (effectsVolume > 0) {
                        incorrectSound.currentTime = 0;
                        incorrectSound.volume = effectsVolume;
                        incorrectSound.play().catch(e => console.error(e));
                    }
                    if (isGameMode) handleGameModeLifeLoss();
                }

                // ... resto de la lógica (Continuous Mode, Live Score, etc.) se mantiene igual
                if (isContinuousMode && currentAnswer.status !== 'unanswered') {
                    answeredIdsInContinuousMode.add(question.id);
                }
                
                updateLiveScore();
                updateEvaluationButton();
                showFeedback();
                updateButtonStates();

                // Publicidad
                if (isGuest && (isContinuousMode || isGameMode)) {
                    questionCountInGuestMode++;
                    if (questionCountInGuestMode % 5 === 0) {
                        setTimeout(showAd, 500);
                    }
                }
            }

            // Función auxiliar para manejar la pérdida de vida
            function handleGameModeLifeLoss() {
                gameModeLives--;
                consecutiveCorrect = 0; // Perder racha
                updateGameModeLivesDisplay();
                
                if (gameModeLives <= 0) {
                    setTimeout(() => {
                        handleGameModeLoss("¡Te has quedado sin vidas! ☠");
                    }, 500); // Pequeña pausa para que el usuario vea que se equivocó
                }
            }

            function toggleCalculator() {
                const isHidden = calculatorContent.classList.toggle('hidden');
                const icon = calculatorToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (isHidden) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            }
            
            function checkIfAllQuestionsCompleted() {
                if (!isContinuousMode) return false;
                const allAnsweredIds = new Set([...pastedAnsweredIds, ...answeredIdsInContinuousMode]);
                const remainingQuestions = availableQuestionsInContinuousMode.filter(q => 
                    !allAnsweredIds.has(q.id)
                );
                if (remainingQuestions.length === 0 && availableQuestionsInContinuousMode.length > 0) {
                    document.getElementById('action-buttons').classList.add('hidden');
                    allQuestionsCompletedMessage.classList.remove('hidden');
                    finishBtn.disabled = false;
                    finishBtn.classList.remove('btn-disabled');
                    finishBtn.innerHTML = 'EVALUAR AVANCE ✓';
                    return true;
                } else {
                    allQuestionsCompletedMessage.classList.add('hidden');
                    document.getElementById('action-buttons').classList.remove('hidden');
                    return false;
                }
            }
            
            function getNextQuestionInContinuousMode() {
                const allAnsweredIds = new Set([...pastedAnsweredIds, ...answeredIdsInContinuousMode]);
                const remainingQuestions = availableQuestionsInContinuousMode.filter(q => 
                    !allAnsweredIds.has(q.id)
                );
                if (remainingQuestions.length === 0) {
                    checkIfAllQuestionsCompleted();
                    return null;
                }
                const randomIndex = Math.floor(Math.random() * remainingQuestions.length);
                return remainingQuestions[randomIndex];
            }

                const graphingFunctionTypes = [
                    { id: 'linear', name: '1. Lineal', canonical: 'y = mx + b', general: 'Ax + By + C = 0' },
                    { id: 'quadratic', name: '2. Cuadrática', canonical: 'y = a(x - h)² + k', general: 'Ax² + Bx + C = 0' },
                    { id: 'cubic', name: '3. Cúbica', canonical: 'y = a(x - h)³ + k', general: 'Ax³ + Bx² + Cx + D = 0' },
                    { id: 'circle', name: '4. Circunferencia', canonical: '(x - h)² + (y - k)² = r²', general: 'x² + y² + Dx + Ey + F = 0', isConic: true },
                    { id: 'ellipse', name: '5. Elipse', canonical: '(x-h)²/a² + (y-k)²/b² = 1', general: 'Ax² + Cy² + Dx + Ey + F = 0', isConic: true },
                    { id: 'parabola', name: '6. Parábola', canonical: 'V: y=a(x-h)²+k | H: x=a(y-k)²+h', general: 'General', isConic: true, hasOrientation: true },
                    { id: 'hyperbola', name: '7. Hipérbola', canonical: '(x-h)²/a² - (y-k)²/b² = 1', general: 'Ax² - Cy² + Dx + Ey + F = 0', isConic: true },
                    { id: 'sin', name: '8. Seno', canonical: 'y = a sin(b(x - h)) + k', general: '' },
                    { id: 'cos', name: '9. Coseno', canonical: 'y = a cos(b(x - h)) + k', general: '' },
                    { id: 'tan', name: '10. Tangente', canonical: 'y = a tan(b(x - h)) + k', general: '' },
                    { id: 'log', name: '11. Logarítmica', canonical: 'y = a log_b(x - h) + k', general: '' },
                    { id: 'exp', name: '12. Exponencial', canonical: 'y = a b^(x - h) + k', general: '' }
                ];

                graphingFunctionButtons.innerHTML = '';

                graphingFunctionTypes.forEach(func => {
                    const button = document.createElement('button');
                    button.className = `graphing-func-btn ${func.id === currentGraphingFunction ? 'active' : ''}`;
                    button.textContent = func.name;
                    button.dataset.funcId = func.id;
                    button.addEventListener('click', function() {
                        document.querySelectorAll('.graphing-func-btn').forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        currentGraphingFunction = func.id;
                        isGraphingCanonical = true;
                        currentOrientation = 'vertical'; 
                        
                        updateGraphingFormToggle();
                        updateGraphingParamControls();
                        updateGraphingEquationDisplay();
                        updateGraphingChart();
                    });
                    graphingFunctionButtons.appendChild(button);
                });

                const resetDiv = document.createElement('div');
                resetDiv.style.width = '100%';
                resetDiv.style.textAlign = 'center';
                resetDiv.style.marginTop = '10px';
                resetDiv.style.marginBottom = '10px';
                
                const resetBtn = document.createElement('button');
                resetBtn.className = 'graphing-btn graphing-btn-secondary';
                resetBtn.innerHTML = '<i class="fas fa-undo"></i> Restablecer parámetros';
                resetBtn.style.width = '100%';
                resetBtn.addEventListener('click', resetGraphingParams);
                
                resetDiv.appendChild(resetBtn);
                graphingFunctionButtons.parentNode.insertBefore(resetDiv, graphingFormToggle);

                updateGraphingFormToggle();
                updateGraphingParamControls();
                initializeGraphingChart();
                
                graphingResetBtn.style.display = 'none';
                graphingUpdateBtn.style.display = 'none';

                if (zoomInBtn) zoomInBtn.addEventListener('click', zoomIn);
                if (zoomOutBtn) zoomOutBtn.addEventListener('click', zoomOut);
                
                updateScaleIndicator();
                
                graphingToolToggle.addEventListener('click', () => {
                    const isHidden = graphingToolContent.classList.toggle('hidden');
                    const icon = graphingToolToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (isHidden) {
                        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    } else {
                        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                        setTimeout(updateGraphingChart, 0);
                    }
                });

                markCoordsBtn.addEventListener('click', markCoordinates);
                clearCoordsBtn.addEventListener('click', clearCoordinates);
                if(projectLineBtn) projectLineBtn.addEventListener('click', projectLine);
                plotExpressionBtn.addEventListener('click', plotAlgebraicExpression);
            const clearExpressionBtn = document.getElementById('clear-expression-btn');
            if (clearExpressionBtn) {
                clearExpressionBtn.addEventListener('click', () => {
                    if (algebraicExpression) algebraicExpression.value = '';
                    algebraicDataset = null;
                    updateGraphingChart();
                    showTemporaryMessage('Gráfica de expresión borrada', 'bg-blue-600');
                });
            }
			
                [coordX1, coordY1, coordX2, coordY2].forEach(el => {
                    if(el) el.addEventListener('input', updateProjectLineButton);
                });
            
            function updateProjectLineButton() {
                const x1 = parseFloat(coordX1.value);
                const y1 = parseFloat(coordY1.value);
                const x2 = parseFloat(coordX2.value);
                const y2 = parseFloat(coordY2.value);
                projectLineBtn.disabled = isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2);
            }
            
            function markCoordinates() {
                const coords = [];
                if (coordX1.value && coordY1.value) {
                    const x1 = parseFloat(coordX1.value);
                    const y1 = parseFloat(coordY1.value);
                    if (!isNaN(x1) && !isNaN(y1)) {
                        coords.push({x: x1, y: y1});
                    }
                }
                if (coordX2.value && coordY2.value) {
                    const x2 = parseFloat(coordX2.value);
                    const y2 = parseFloat(coordY2.value);
                    if (!isNaN(x2) && !isNaN(y2)) {
                        coords.push({x: x2, y: y2});
                    }
                }
                if (coordX3.value && coordY3.value) {
                    const x3 = parseFloat(coordX3.value);
                    const y3 = parseFloat(coordY3.value);
                    if (!isNaN(x3) && !isNaN(y3)) {
                        coords.push({x: x3, y: y3});
                    }
                }
                markedCoordinates = coords;
                updateGraphingChart();
            }
            
            function clearCoordinates() {
                markedCoordinates = [];
                lineProjectionDataset = null;
                coordX1.value = '';
                coordY1.value = '';
                coordX2.value = '';
                coordY2.value = '';
                coordX3.value = '';
                coordY3.value = '';
                projectLineBtn.disabled = true;
                updateGraphingChart();
            }
            
            function projectLine() {
                const x1 = parseFloat(coordX1.value);
                const y1 = parseFloat(coordY1.value);
                const x2 = parseFloat(coordX2.value);
                const y2 = parseFloat(coordY2.value);
                if (isNaN(x1) || isNaN(y1) || isNaN(x2) || isNaN(y2)) return;
                const m = (y2 - y1) / (x2 - x1);
                const b = y1 - m * x1;
                const dataPoints = [];
                const step = currentScale / 200;
                for (let x = -currentScale; x <= currentScale; x += step) {
                    const y = m * x + b;
                    if (Math.abs(y) <= currentScale) {
                        dataPoints.push({ x: x, y: y });
                    }
                }
                lineProjectionDataset = {
                    label: 'Línea Proyectada',
                    data: dataPoints,
                    borderColor: '#00FF00',
                    backgroundColor: '#00FF00',
                    pointRadius: 0,
                    borderWidth: 2,
                    showLine: true,
                    fill: false
                };
                updateGraphingChart();
            }
            
            function plotAlgebraicExpression() {
                const expr = algebraicExpression.value.trim();
                if (!expr) {
                    showTemporaryMessage('Por favor, ingresa una expresión algebraica.', 'bg-red-600');
                    return;
                }
                try {
                    const dataPoints = [];
                    const step = currentScale / 200;
                    for (let x = -currentScale; x <= currentScale; x += step) {
                        try {
                            const y = evaluateExpression(expr, x);
                            if (Math.abs(y) <= currentScale && isFinite(y)) {
                                dataPoints.push({ x: x, y: y });
                            }
                        } catch (e) {
                        }
                    }
                    
                    if (dataPoints.length === 0) {
                        showTemporaryMessage('No se pudieron calcular puntos para la expresión. Verifica que sea válida.', 'bg-red-600');
                        return;
                    }
                    
                    algebraicDataset = {
                        label: 'Expresión: ' + expr,
                        data: dataPoints,
                        borderColor: '#FFA500',
                        backgroundColor: '#FFA500',
                        pointRadius: 0,
                        borderWidth: 2,
                        showLine: true,
                        fill: false
                    };
                    updateGraphingChart();
                } catch (error) {
                    showTemporaryMessage('Error al evaluar la expresión: ' + error.message, 'bg-red-600');
                    console.error('Error en plotAlgebraicExpression:', error);
                }
            }
            
            function evaluateExpression(expr, xValue) {
                let safeExpr = expr
                    .replace(/\^/g, '**') 
                    .replace(/sin\(/g, 'Math.sin(')
                    .replace(/cos\(/g, 'Math.cos(')
                    .replace(/tan\(/g, 'Math.tan(')
                    .replace(/log\(/g, 'Math.log10(')
                    .replace(/ln\(/g, 'Math.log(') 
                    .replace(/sqrt\(/g, 'Math.sqrt(')
                    .replace(/exp\(/g, 'Math.exp(')
                    .replace(/pi/g, 'Math.PI')
                    .replace(/e/g, 'Math.E')
                    .replace(/(\d)x/g, '$1*x')
                    .replace(/x(\d)/g, 'x*$1')
                    .replace(/\)\(/g, ')*(') 
                    .replace(/([0-9)])([a-zA-Z(])/g, '$1*$2')
                    .replace(/([a-zA-Z)])([0-9(])/g, '$1*$2');

                safeExpr = safeExpr.replace(/x/g, `(${xValue})`);
                
                if (!/^[0-9\+\-\*\/\^\.\(\)\sMath\.sinMath\.cosMath\.tanMath\.logMath\.log10Math\.sqrtMath\.expMath\.PIMath\.E]*$/.test(safeExpr.replace(/ /g, ''))) {
                    throw new Error('Expresión contiene caracteres no permitidos');
                }
                
                try {
                    return Function('"use strict"; return ' + safeExpr)();
                } catch (e) {
                    throw new Error('No se pudo evaluar la expresión: ' + e.message);
                }
            }
            
            function zoomIn() {
                const currentIndex = SCALE_STEPS.indexOf(currentScale);
                if (currentIndex > 0) {
                    currentScale = SCALE_STEPS[currentIndex - 1];
                    updateGraphingChart();
                    updateScaleIndicator();
                    updateZoomButtons();
                }
            }
            
            function zoomOut() {
                const currentIndex = SCALE_STEPS.indexOf(currentScale);
                if (currentIndex < SCALE_STEPS.length - 1) {
                    currentScale = SCALE_STEPS[currentIndex + 1];
                    updateGraphingChart();
                    updateScaleIndicator();
                    updateZoomButtons();
                }
            }
            
            function updateScaleIndicator() {
                if (scaleIndicator) {
                    scaleIndicator.textContent = `Escala: ±${currentScale}`;
                }
            }
            
            function updateZoomButtons() {
                if (zoomInBtn) {
                    zoomInBtn.disabled = currentScale <= SCALE_STEPS[0];
                }
                if (zoomOutBtn) {
                    zoomOutBtn.disabled = currentScale >= SCALE_STEPS[SCALE_STEPS.length - 1];
                }
            }
            
            function updateGraphingFormToggle() {
                graphingFormToggle.innerHTML = '';
                const canonicalBtn = document.createElement('button');
                canonicalBtn.className = `graphing-form-toggle-btn ${isGraphingCanonical ? 'active' : ''}`;
                canonicalBtn.textContent = 'Forma Canónica';
                canonicalBtn.dataset.form = 'canonical';
                const generalBtn = document.createElement('button');
                generalBtn.className = `graphing-form-toggle-btn ${!isGraphingCanonical ? 'active' : ''}`;
                generalBtn.textContent = 'Forma General';
                generalBtn.dataset.form = 'general';
                canonicalBtn.addEventListener('click', function() {
                    isGraphingCanonical = true;
                    canonicalBtn.classList.add('active');
                    generalBtn.classList.remove('active');
                    updateGraphingParamControls();
                    updateGraphingEquationDisplay();
                });
                generalBtn.addEventListener('click', function() {
                    isGraphingCanonical = false;
                    generalBtn.classList.add('active');
                    canonicalBtn.classList.remove('active');
                    updateGraphingParamControls();
                    updateGraphingEquationDisplay();
                });
                graphingFormToggle.appendChild(canonicalBtn);
                graphingFormToggle.appendChild(generalBtn);
            }
            
            function updateGraphingParamControls() {
                graphingParamControls.innerHTML = '';
                
                if (['parabola', 'ellipse', 'hyperbola'].includes(currentGraphingFunction)) {
                    const orientDiv = document.createElement('div');
                    orientDiv.className = 'graphing-form-toggle';
                    orientDiv.style.marginBottom = '10px';
                    
                    const btnVert = document.createElement('button');
                    btnVert.className = `graphing-form-toggle-btn ${currentOrientation === 'vertical' ? 'active' : ''}`;
                    btnVert.textContent = 'Vertical';
                    btnVert.onclick = () => { currentOrientation = 'vertical'; updateGraphingParamControls(); updateGraphingChart(); };
                    
                    const btnHoriz = document.createElement('button');
                    btnHoriz.className = `graphing-form-toggle-btn ${currentOrientation === 'horizontal' ? 'active' : ''}`;
                    btnHoriz.textContent = 'Horizontal';
                    btnHoriz.onclick = () => { currentOrientation = 'horizontal'; updateGraphingParamControls(); updateGraphingChart(); };
                    
                    orientDiv.appendChild(btnVert);
                    orientDiv.appendChild(btnHoriz);
                    graphingParamControls.appendChild(orientDiv);
                }

                const paramConfigs = getGraphingParamConfigs();
                
                paramConfigs.forEach(config => {
                    const paramGroup = document.createElement('div');
                    paramGroup.className = 'graphing-param-group';
                    
                    const label = document.createElement('label');
                    label.textContent = config.label;
                    label.htmlFor = `graphing-param-${config.param}`;
                    
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.value = config.def; 
                    input.id = `graphing-param-${config.param}`;
                    input.className = 'graphing-param-input';
                    input.dataset.param = config.param;
                    
                    input.addEventListener('input', function() {
                        updateGraphingEquationDisplay();
                        updateGraphingChart();
                    });
                    
                    paramGroup.appendChild(label);
                    paramGroup.appendChild(input);
                    graphingParamControls.appendChild(paramGroup);
                });
                
                updateGraphingEquationDisplay();
                updateGraphingChart();
            }
            
            function getGraphingParamConfigs() {
                const configs = [];
                if (typeof currentOrientation === 'undefined') window.currentOrientation = 'vertical';

                if (currentGraphingFunction === 'linear') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'm', label: 'Pendiente (m)', def: 1 });
                        configs.push({ param: 'b', label: 'Intercepto (b)', def: 0 });
                    } else {
                        configs.push({ param: 'A', label: 'A', def: 1 });
                        configs.push({ param: 'B', label: 'B', def: -1 });
                        configs.push({ param: 'C', label: 'C', def: 0 });
                    }
                } else if (currentGraphingFunction === 'quadratic') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'a', label: 'Apertura (a)', def: 1 });
                        configs.push({ param: 'h', label: 'Vértice X (h)', def: 0 });
                        configs.push({ param: 'k', label: 'Vértice Y (k)', def: 0 });
                    } else {
                        configs.push({ param: 'A', label: 'A', def: 1 });
                        configs.push({ param: 'B', label: 'B', def: 0 });
                        configs.push({ param: 'C', label: 'C', def: 0 });
                    }
                } else if (currentGraphingFunction === 'cubic') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'a', label: 'Escala (a)', def: 1 });
                        configs.push({ param: 'h', label: 'Desplazamiento X (h)', def: 0 });
                        configs.push({ param: 'k', label: 'Desplazamiento Y (k)', def: 0 });
                    } else {
                        configs.push({ param: 'A', label: 'A', def: 1 });
                        configs.push({ param: 'B', label: 'B', def: 0 });
                        configs.push({ param: 'C', label: 'C', def: 0 });
                        configs.push({ param: 'D', label: 'D', def: 0 });
                    }
                } else if (currentGraphingFunction === 'circle') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'h', label: 'Centro X (h)', def: 0 });
                        configs.push({ param: 'k', label: 'Centro Y (k)', def: 0 });
                        configs.push({ param: 'r', label: 'Radio (r)', def: 5 });
                    } else {
                        configs.push({ param: 'D', label: 'D', def: 0 });
                        configs.push({ param: 'E', label: 'E', def: 0 });
                        configs.push({ param: 'F', label: 'F', def: -25 });
                    }
                } else if (currentGraphingFunction === 'ellipse') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'h', label: 'Centro X (h)', def: 0 });
                        configs.push({ param: 'k', label: 'Centro Y (k)', def: 0 });
                        configs.push({ param: 'a', label: 'Radio Horiz (a)', def: 5 });
                        configs.push({ param: 'b', label: 'Radio Vert (b)', def: 3 });
                    } else {
                        configs.push({ param: 'A', label: 'A', def: 4 });
                        configs.push({ param: 'C', label: 'C', def: 9 });
                        configs.push({ param: 'D', label: 'D', def: 0 });
                        configs.push({ param: 'E', label: 'E', def: 0 });
                        configs.push({ param: 'F', label: 'F', def: -36 });
                    }
                } else if (currentGraphingFunction === 'parabola') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'a', label: 'Coeficiente (a)', def: 1 });
                        configs.push({ param: 'h', label: 'Vértice X (h)', def: 0 });
                        configs.push({ param: 'k', label: 'Vértice Y (k)', def: 0 });
                    } else {
                        if (currentOrientation === 'vertical') {
                            configs.push({ param: 'D', label: 'D', def: 0 });
                            configs.push({ param: 'E', label: 'E', def: -1 });
                            configs.push({ param: 'F', label: 'F', def: 0 });
                        } else {
                            configs.push({ param: 'D', label: 'D', def: -1 });
                            configs.push({ param: 'E', label: 'E', def: 0 });
                            configs.push({ param: 'F', label: 'F', def: 0 });
                        }
                    }
                } else if (currentGraphingFunction === 'hyperbola') {
                    if (isGraphingCanonical) {
                        configs.push({ param: 'h', label: 'Centro X (h)', def: 0 });
                        configs.push({ param: 'k', label: 'Centro Y (k)', def: 0 });
                        configs.push({ param: 'a', label: 'Eje Real (a)', def: 2 });
                        configs.push({ param: 'b', label: 'Eje Imag (b)', def: 1 });
                    } else {
                        configs.push({ param: 'A', label: 'A', def: 4 });
                        configs.push({ param: 'C', label: 'C', def: -9 });
                        configs.push({ param: 'D', label: 'D', def: 0 });
                        configs.push({ param: 'E', label: 'E', def: 0 });
                        configs.push({ param: 'F', label: 'F', def: -36 });
                    }
                } else if (['sin', 'cos', 'tan'].includes(currentGraphingFunction)) {
                    configs.push({ param: 'a', label: 'Amplitud (a)', def: 1 });
                    configs.push({ param: 'b', label: 'Frecuencia (b)', def: 1 });
                    configs.push({ param: 'h', label: 'Fase X (h)', def: 0 });
                    configs.push({ param: 'k', label: 'Desp. Y (k)', def: 0 });
                } else if (currentGraphingFunction === 'log') {
                    configs.push({ param: 'a', label: 'Escala (a)', def: 1 });
                    configs.push({ param: 'b', label: 'Base (b)', def: 10 });
                    configs.push({ param: 'h', label: 'Asíntota X (h)', def: 0 });
                    configs.push({ param: 'k', label: 'Desp. Y (k)', def: 0 });
                } else if (currentGraphingFunction === 'exp') {
                    configs.push({ param: 'a', label: 'Escala (a)', def: 1 });
                    configs.push({ param: 'b', label: 'Base (b)', def: 2 });
                    configs.push({ param: 'h', label: 'Desp. X (h)', def: 0 });
                    configs.push({ param: 'k', label: 'Asíntota Y (k)', def: 0 });
                }
                return configs;
            }
            
            function updateGraphingEquationDisplay() {
                const funcType = graphingFunctionTypes.find(f => f.id === currentGraphingFunction);
                if (isGraphingCanonical) {
                    graphingCurrentEquation.textContent = funcType.canonical;
                } else {
                    graphingCurrentEquation.textContent = funcType.general;
                }
            }
            
            function initializeGraphingChart() {
                const ctx = equationChartCanvas.getContext('2d');
                graphingChart = new Chart(ctx, {
                    type: 'scatter',
                    data: {
                        datasets: []
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 1,
                        scales: {
                            x: {
                                type: 'linear',
                                position: 'center',
                                min: -currentScale,
                                max: currentScale,
                                grid: {
                                    color: (context) => context.tick.value === 0 ? '#ffffff' : 'rgba(255, 255, 255, 0.1)',
                                    lineWidth: (context) => context.tick.value === 0 ? 2 : 1
                                },
                                ticks: {
                                    stepSize: currentScale / 10,
                                    color: '#bdbdbd',
                                    callback: function(value) {
                                        if (value === 0) return '0';
                                        if (value === Math.PI) return 'π';
                                        if (value === -Math.PI) return '-π';
                                        return value;
                                    }
                                }
                            },
                            y: {
                                type: 'linear',
                                position: 'center',
                                min: -currentScale,
                                max: currentScale,
                                grid: {
                                    color: (context) => context.tick.value === 0 ? '#ffffff' : 'rgba(255, 255, 255, 0.1)',
                                    lineWidth: (context) => context.tick.value === 0 ? 2 : 1
                                },
                                ticks: {
                                    stepSize: currentScale / 10,
                                    color: '#bdbdbd',
                                    callback: function(value) {
                                        if (value === 0) return '0';
                                        if (value === Math.PI) return 'π';
                                        if (value === -Math.PI) return '-π';
                                        return value;
                                    }
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    filter: function(item, chart) {
                                        return item.text !== 'Origen';
                                    }
                                }
                            },
                            tooltip: {
                                enabled: false
                            }
                        }
                    }
                });
            }
            
            function updateGraphingChart() {
                if (!graphingChart) return;
                
                const params = {};
                document.querySelectorAll('.graphing-param-input').forEach(input => {
                    params[input.dataset.param] = parseFloat(input.value) || 0;
                });

                graphingChart.options.scales.x.min = -currentScale;
                graphingChart.options.scales.x.max = currentScale;
                graphingChart.options.scales.y.min = -currentScale;
                graphingChart.options.scales.y.max = currentScale;
                graphingChart.options.scales.x.ticks.stepSize = currentScale / 5;
                graphingChart.options.scales.y.ticks.stepSize = currentScale / 5;

                const dataPoints = [];
                const step = currentScale / 100;
                
                if (['linear', 'quadratic', 'cubic', 'sin', 'cos', 'tan', 'log', 'exp'].includes(currentGraphingFunction)) {
                    for (let x = -currentScale; x <= currentScale; x += step) {
                        let y = null;
                        
                        if (currentGraphingFunction === 'linear') {
                            if (isGraphingCanonical) y = params.m * x + params.b;
                            else if (params.B !== 0) y = (-params.A * x - params.C) / params.B;
                        } 
                        else if (currentGraphingFunction === 'quadratic') {
                            if (isGraphingCanonical) y = params.a * Math.pow(x - params.h, 2) + params.k;
                            else y = params.A * x * x + params.B * x + params.C;
                        }
                        else if (currentGraphingFunction === 'cubic') {
                            if (isGraphingCanonical) y = params.a * Math.pow(x - params.h, 3) + params.k;
                            else y = params.A * Math.pow(x,3) + params.B * Math.pow(x,2) + params.C * x + params.D;
                        }
                        else if (currentGraphingFunction === 'sin') y = params.a * Math.sin(params.b * (x - params.h)) + params.k;
                        else if (currentGraphingFunction === 'cos') y = params.a * Math.cos(params.b * (x - params.h)) + params.k;
                        else if (currentGraphingFunction === 'tan') {
                            y = params.a * Math.tan(params.b * (x - params.h)) + params.k;
                            if (Math.abs(y) > currentScale) y = null;
                        }
                        else if (currentGraphingFunction === 'log') {
                            const val = x - params.h;
                            if (val > 0 && params.b > 0 && params.b !== 1) {
                                y = params.a * (Math.log(val) / Math.log(params.b)) + params.k;
                            }
                        }
                        else if (currentGraphingFunction === 'exp') {
                            y = params.a * Math.pow(params.b, (x - params.h)) + params.k;
                        }

                        if (y !== null && Math.abs(y) <= currentScale * 1.5) {
                            dataPoints.push({ x: x, y: y });
                        }
                    }
                } 
                else {
                    const tStep = 0.05; 
                    
                    if (currentGraphingFunction === 'circle') {
                        const r = isGraphingCanonical ? params.r : Math.sqrt(Math.max(0, (params.D*params.D + params.E*params.E)/4 - params.F));
                        const h = isGraphingCanonical ? params.h : -params.D/2;
                        const k = isGraphingCanonical ? params.k : -params.E/2;
                        
                        if (r > 0) {
                            for(let t=0; t <= 2*Math.PI; t+=tStep) {
                                dataPoints.push({ x: h + r*Math.cos(t), y: k + r*Math.sin(t) });
                            }
                        }
                    }
                    else if (currentGraphingFunction === 'ellipse') {
                        let h = params.h, k = params.k, a = params.a, b = params.b;
                        if (!isGraphingCanonical) {
                            h = -params.D / (2*params.A);
                            k = -params.E / (2*params.C);
                            a = Math.sqrt(Math.abs((params.F - params.A*h*h - params.C*k*k)/params.A));
                            b = Math.sqrt(Math.abs((params.F - params.A*h*h - params.C*k*k)/params.C));
                        }
                        

                        for(let t=0; t <= 2*Math.PI; t+=tStep) {
                            dataPoints.push({ x: h + a*Math.cos(t), y: k + b*Math.sin(t) });
                        }
                    }
                    else if (currentGraphingFunction === 'parabola') {
                        for (let t = -currentScale; t <= currentScale; t += step) {
                            let px, py;
                            if (currentOrientation === 'vertical') {
                                px = t;
                                py = params.a * Math.pow(t - params.h, 2) + params.k;
                            } else {
                                py = t;
                                px = params.a * Math.pow(t - params.k, 2) + params.h;
                            }
                            
                            if (Math.abs(px) <= currentScale && Math.abs(py) <= currentScale) {
                                dataPoints.push({x: px, y: py});
                            }
                        }
                    }
                    else if (currentGraphingFunction === 'hyperbola') {
                        const h = params.h, k = params.k, a = params.a, b = params.b;
                        
                        for (let section = 0; section < 2; section++) { 
                             for(let t = -1.3; t <= 1.3; t+=0.05) { 
                                 let px, py;
                                 if (currentOrientation === 'horizontal') {
                                     const sign = section === 0 ? 1 : -1;
                                     px = h + a * Math.cosh(t) * sign;
                                     py = k + b * Math.sinh(t);
                                 } else {
                                     const sign = section === 0 ? 1 : -1;
                                     py = k + a * Math.cosh(t) * sign;
                                     px = h + b * Math.sinh(t);
                                 }
                                 if(Math.abs(px) <= currentScale && Math.abs(py) <= currentScale)
                                    dataPoints.push({x: px, y: py});
                             }
                             dataPoints.push({x: null, y: null});
                        }
                    }
                }

                const datasets = [{
                    label: 'Función',
                    data: dataPoints,
                    borderColor: '#9c27b0',
                    backgroundColor: '#9c27b0',
                    pointRadius: 0,
                    borderWidth: 2,
                    showLine: true,
                    fill: false
                }];

                datasets.push({
                    label: 'Origen',
                    data: [{ x: 0, y: 0 }],
                    backgroundColor: '#fff',
                    pointRadius: 4
                });

                if (markedCoordinates.length > 0) {
                    datasets.push({
                        label: 'Marcas',
                        data: markedCoordinates,
                        backgroundColor: 'red',
                        borderColor: 'white',
                        borderWidth: 2,
                        pointRadius: 8,
                        pointHoverRadius: 10,
                        pointStyle: 'circle'
                    });
                }
                
                if (lineProjectionDataset) datasets.push(lineProjectionDataset);
                if (algebraicDataset) datasets.push(algebraicDataset);

                graphingChart.data.datasets = datasets;
                graphingChart.update();
            }
            
            function resetGraphingParams() {
                updateGraphingParamControls();
                markedCoordinates = [];
                lineProjectionDataset = null;
                algebraicDataset = null;
                [coordX1, coordY1, coordX2, coordY2, coordX3, coordY3].forEach(el => { if(el) el.value = ''; });
                if(algebraicExpression) algebraicExpression.value = '';
                updateGraphingChart();
            }

            function updateVolumeDisplay() {
                const percentage = Math.round(effectsVolume * 100) + '%';
                if(volumeIndicatorSetup) volumeIndicatorSetup.textContent = percentage;
                if(volumeIndicatorQuiz) volumeIndicatorQuiz.textContent = percentage;
            }

            function initializeVolumes() {
                correctSound.volume = effectsVolume;
                incorrectSound.volume = effectsVolume;
                buttonSound.volume = effectsVolume;
                sadViolinSound.volume = effectsVolume;
                simulacroFail1.volume = 0.3;
                simulacroFail2.volume = 0.3;
                simulacroSuccess1.volume = 0.3;
                simulacroSuccess2.volume = 0.3;
                updateVolumeDisplay();
            }
            
            document.querySelectorAll('.volume-btn-new').forEach(btn => {
                btn.addEventListener('click', () => {
                    const action = btn.dataset.action;
                    if (action === 'down') {
                        effectsVolume = Math.max(0, effectsVolume - 0.1);
                    } else if (action === 'up') {
                        effectsVolume = Math.min(1, effectsVolume + 0.1);
                    }
                    effectsVolume = parseFloat(effectsVolume.toFixed(2));
                    initializeVolumes();
                    const icon = btn.closest('div').querySelector('i');
                    if(icon) icon.classList.add('text-blue-400');
                    setTimeout(() => {
                        if(icon) icon.classList.remove('text-blue-400');
                    }, 300);
                });
            });

            function playButtonSound() {
                buttonSound.currentTime = 0;
                buttonSound.play().catch(e => console.error("Error al reproducir sonido de botón:", e));
            }
            
            document.body.addEventListener('click', (e) => {
                const soundClasses = [
                    '.btn', 
                    '.option-btn', 
                    '.calculator-btn', 
                    '.tag', 
                    '.video-toggle', 
                    '.control-btn', 
                    '.color-picker-wrapper', 
                    '#clear-button', 
                    '.volume-btn-new', 
                    '.graphing-func-btn', 
                    '.graphing-form-toggle-btn', 
                    '.graphing-btn',
                    '.privacy-modal-close',
                    '.close-modal-btn',
                    '#logout-btn'
                ];

                const target = e.target.closest(soundClasses.join(','));

                if (target && !target.disabled && !target.classList.contains('btn-disabled')) {
                    playButtonSound();
                }
            });

            if(welcomeVideoToggle) {
                welcomeVideoToggle.addEventListener('click', () => {
                    welcomeVideoContent.classList.toggle('hidden');
                    const icon = welcomeVideoToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (welcomeVideoContent.classList.contains('hidden')) {
                        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    } else {
                        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                    }
                });
            }
            
            videoToggle.addEventListener('click', () => {
                videoContent.classList.toggle('hidden');
                const icon = videoToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (videoContent.classList.contains('hidden')) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });

            imageToggle.addEventListener('click', () => {
                imageContent.classList.toggle('hidden');
                const icon = imageToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (imageContent.classList.contains('hidden')) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });

            textToggle.addEventListener('click', () => {
                textContent.classList.toggle('hidden');
                const icon = textToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                if (textContent.classList.contains('hidden')) {
                    icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            });
            
            function setupLookupForGuest() {
                if (isGuest) {
                    lookupIdInput.disabled = true;
                    lookupBtn.disabled = true;
                    lookupBtn.classList.add('btn-disabled');
                    lookupIdInput.placeholder = "Función no disponible para invitados";
                    const lookupSection = document.querySelector('.space-y-2.border-t.border-gray-600.pt-4.mt-4');
                    if (lookupSection) {
                        lookupSection.style.display = 'none';
                    }
                }
            }
            
            function handleGameModeLoss(message) {
                clearInterval(gameModeTimer);
                
                correctSound.pause();
                incorrectSound.pause();
                buttonSound.pause();
                sadViolinSound.pause();
                simulacroFail1.pause();
                simulacroFail2.pause();
                simulacroSuccess1.pause();
                simulacroSuccess2.pause();
                
                const failSounds = [simulacroFail1, simulacroFail2];
                const randomFailSound = failSounds[Math.floor(Math.random() * failSounds.length)];
                if (effectsVolume > 0) {
                    randomFailSound.currentTime = 0;
                    randomFailSound.volume = 0.3;
                    randomFailSound.play().catch(e => console.error("Error al reproducir sonido de fallo:", e));
                }
                showSimulacroEndScreen();
            }
            
            function showTemporaryMessage(message, bgColor = "bg-blue-600") {
                const tempMessage = document.createElement('div');
                tempMessage.className = `fixed top-1/4 left-1/2 transform -translate-x-1/2 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-50`;
                tempMessage.style.maxWidth = "80%";
                tempMessage.textContent = message;
                document.body.appendChild(tempMessage);
                setTimeout(() => {
                    if (document.body.contains(tempMessage)) {
                        document.body.removeChild(tempMessage);
                    }
                }, 2000);
            }
            
            function updateGameModeLivesDisplay() {
                const livesDisplay = '❤️ '.repeat(gameModeLives).trim();
                gameModeLivesDisplay.textContent = livesDisplay;
            }
            
            function startGameModeTimer() {
                clearInterval(gameModeTimer);
                gameModeSeconds = 30 * 60;
                updateGameModeTimerDisplay();
                gameModeTimer = setInterval(() => {
                    gameModeSeconds--;
                    updateGameModeTimerDisplay();
                    if (gameModeSeconds <= 0) {
                        clearInterval(gameModeTimer);
                        handleGameModeLoss("¡Tiempo agotado! Has perdido el desafío.");
                    }
                }, 1000);
            }
            
            function updateGameModeTimerDisplay() {
                const minutes = Math.floor(gameModeSeconds / 60);
                const seconds = gameModeSeconds % 60;
                timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                timerDisplay.classList.remove('timer-green', 'timer-orange', 'timer-red');
                if (minutes > 10) {
                    timerDisplay.classList.add('timer-green');
                } else if (minutes > 5) {
                    timerDisplay.classList.add('timer-orange');
                } else {
                    timerDisplay.classList.add('timer-red');
                }
            }
            
            calculatorToggle.addEventListener('click', toggleCalculator);
            document.querySelectorAll('.calculator-btn').forEach(button => {
                button.addEventListener('click', () => calculatorButtonClick(button.dataset.value));
            });
            
            function calculatorButtonClick(value) {
                if (value === 'C') {
                    calculatorValue = '0';
                    calculatorWaitingForOperand = false;
                    calculatorOperator = null;
                    calculatorPreviousValue = '0';
                } else if (value === '√') {
                    try {
                        const num = parseFloat(calculatorValue);
                        if (num >= 0) {
                            calculatorValue = String(Math.sqrt(num));
                        } else {
                            calculatorValue = 'Error';
                        }
                        calculatorWaitingForOperand = true;
                    } catch {
                        calculatorValue = 'Error';
                    }
                } else if (value === '=') {
                    if (calculatorOperator) {
                        const current = parseFloat(calculatorValue);
                        const previous = parseFloat(calculatorPreviousValue);
                        let result;
                        switch (calculatorOperator) {
                            case '+': result = previous + current; break;
                            case '-': result = previous - current; break;
                            case '*': result = previous * current; break;
                            case '/': 
                                if (current !== 0) {
                                    result = previous / current;
                                } else {
                                    result = 'Error';
                                }
                                break;
                            default: result = current;
                        }
                        calculatorValue = String(result);
                        calculatorOperator = null;
                        calculatorPreviousValue = '0';
                        calculatorWaitingForOperand = true;
                    }
                } else if (['+', '-', '*', '/'].includes(value)) {
                    if (calculatorOperator && !calculatorWaitingForOperand) {
                        calculatorButtonClick('=');
                    }
                    calculatorPreviousValue = calculatorValue;
                    calculatorOperator = value;
                    calculatorWaitingForOperand = true;
                } else {
                    if (calculatorWaitingForOperand) {
                        calculatorValue = '0';
                        calculatorWaitingForOperand = false;
                    }
                    if (value === '.') {
                        if (!calculatorValue.includes('.')) {
                            calculatorValue += '.';
                        }
                    } else {
                        calculatorValue = calculatorValue === '0' ? value : calculatorValue + value;
                    }
                }
                calculatorDisplay.textContent = calculatorValue;
            }
            
            guestLoginBtn.addEventListener('click', () => {
                isGuest = true;
                currentUser = { name: 'Invitado', email: 'invitado@example.com', whatsapp: '0000000000' };
                screens.login.classList.add('hidden');
                screens.setup.classList.remove('hidden');
                if(logoutBtn) logoutBtn.style.display = 'flex';
                welcomeName.textContent = 'Invitado';
                answeredIdsInput.disabled = true;
                setupLookupForGuest();
                loadData().then(() => {
                    uniTagsContainer.querySelectorAll('.tag').forEach(tagEl => {
                        if (tagEl.textContent === 'GENERAL') {
                            tagEl.classList.add('selected');
                        }
                        tagEl.style.pointerEvents = 'none';
                        tagEl.style.opacity = '0.5';
                    });
                    levelTagsContainer.querySelectorAll('.tag').forEach(tagEl => {
                        if (tagEl.textContent === 'BÁSICO') {
                            tagEl.classList.add('selected');
                        }
                        tagEl.style.pointerEvents = 'none';
                        tagEl.style.opacity = '0.5';
                    });
                    updateQuestionStats();
                   // Bloquear tags de Tipo para invitado
                    typeTagsContainer.querySelectorAll('.tag').forEach((tagEl, index) => {
                        if (index === 0) { // O lógica de selección por defecto
                            tagEl.classList.add('selected');
                        }
                        tagEl.style.pointerEvents = 'none';
                        tagEl.style.opacity = '0.5';
                    });
                });
                gameModeToggle.disabled = false;
                gameModeToggle.checked = false;
                gameModeToggle.parentElement.style.opacity = '1';
                gameModeToggle.parentElement.style.pointerEvents = 'auto';
                continuousModeToggle.disabled = false;
                
                if(chatbotToggle) {
                    chatbotToggle.style.opacity = '0.5';
                    chatbotToggle.style.cursor = 'not-allowed';
                    chatbotToggle.title = "No disponible para invitados";
                }
            });
            
            noAccessBtn.addEventListener('click', (e) => {
                if (isGuest) {
                    e.preventDefault();
                    showTemporaryMessage('Ya estás en modo invitado. Si necesitas acceso completo, por favor contacta al administrador.');
                }
            });
            
            loginForm.addEventListener('submit', async (event) => {
                event.preventDefault();
                const name = nameInput.value.trim();
                const emailToValidate = emailInput.value.trim();
                const whatsappToValidate = whatsappInput.value.trim();
                loginErrorMessage.textContent = '';
                loginBtnText.classList.add('hidden');
                loginBtnSpinner.classList.remove('hidden');
                loginBtn.disabled = true;
                try {
                    const isValid = await validateUserAccess(name, emailToValidate, whatsappToValidate);
                    if (isValid) {
                        isGuest = false;
                        if (!currentUser.name || currentUser.name === 'Invitado') {
                             currentUser = { name, email: emailToValidate, whatsapp: whatsappToValidate };
                        } else {
                             currentUser.email = emailToValidate;
                             currentUser.whatsapp = whatsappToValidate;
                        }
                        
                        screens.login.classList.add('hidden');
                        screens.setup.classList.remove('hidden');
                        welcomeName.textContent = currentUser.name;
                        if(logoutBtn) logoutBtn.style.display = 'flex';
                        
                        await loadData();
                        gameModeToggle.disabled = false;
                        gameModeToggle.parentElement.style.opacity = '1';
                        gameModeToggle.parentElement.style.pointerEvents = 'auto';
                        continuousModeToggle.disabled = false;
                    } else {
                        loginErrorMessage.textContent = 'Los datos no coinciden. Por favor, verifica tu información.';
                    }
                } catch (error) {
                    loginErrorMessage.textContent = 'Error al conectar con la base de datos. Intenta de nuevo.';
                } finally {
                    loginBtnText.classList.remove('hidden');
                    loginBtnSpinner.classList.add('hidden');
                    loginBtn.disabled = false;
                }
            });
            
            const loadData = async () => {
                try {
                    const response = await fetch(QUIZ_JSON_URL);
                    if (!response.ok) {
                        throw new Error('No se pudo cargar el archivo JSON');
                    }
                    let jsonText = await response.text();
                    jsonText = jsonText.replace(/\\\\\\\\/g, '\\\\');
                    jsonText = jsonText.replace(/\\u00a0/g, ' ');
                    jsonText = jsonText.replace(/,\s*}/g, '}');
                    jsonText = jsonText.replace(/,\s*\]/g, ']');
                    try {
                        allQuestions = JSON.parse(jsonText);
                    } catch (parseError) {
                        console.error('Error al parsear JSON:', parseError.message);
                        allQuestions = [];
                    }
                    statsTotal.textContent = allQuestions.length;
                    populateTagFilters();
                    updateQuestionStats();
                } catch (error) {
                    errorMessage.textContent = 'Error: ' + error.message;
                    console.error('Error crítico:', error);
                    startQuizBtn.disabled = true;
                }
            };
            
            function updateQuestionStats() {
                const allValidIds = new Set(allQuestions.map(q => q.id));
                const pastedText = answeredIdsInput.value.trim();
                const pastedIds = pastedText ? pastedText.split(/[\s,]+/).map(id => id.trim()).filter(id => id) : [];
                pastedAnsweredIds = new Set(pastedIds.filter(id => allValidIds.has(id)));
                
                // 1. Total Banco
                if(statsTotal) statsTotal.textContent = allQuestions.length;

                // Calcular Filtros
                const selectedUniTags = Array.from(uniTagsContainer.querySelectorAll('.selected')).map(el => el.textContent);
                const selectedLevelTags = Array.from(levelTagsContainer.querySelectorAll('.selected')).map(el => el.textContent);
                const selectedTypeTags = Array.from(typeTagsContainer.querySelectorAll('.selected')).map(el => el.textContent);
                
                let filteredQuestions = allQuestions;

                // Lógica de filtrado con los 3 tags
                filteredQuestions = allQuestions.filter(q => {
                    // Verificar Uni
                    const hasUniTag = selectedUniTags.length === 0 || (q.uni_tags && q.uni_tags.some(tag => selectedUniTags.includes(tag)));
                    // Verificar Nivel
                    const hasLevelTag = selectedLevelTags.length === 0 || (q.level_tag && q.level_tag.some(tag => selectedLevelTags.includes(tag)));
                    // Verificar Tipo (NUEVO)
                    const hasTypeTag = selectedTypeTags.length === 0 || (q.type_tag && q.type_tag.some(tag => selectedTypeTags.includes(tag)));

                    return hasUniTag && hasLevelTag && hasTypeTag;
                });
                
                // 2. Preguntas con Filtros
                if(statsTotalFiltered) statsTotalFiltered.textContent = filteredQuestions.length;

                // 3. Preguntas Restantes (Filtros menos IDs pegados)
                const answeredInFilter = filteredQuestions.filter(q => pastedAnsweredIds.has(q.id)).length;
                const remaining = Math.max(0, filteredQuestions.length - answeredInFilter);
                
                if(statsRemainingFiltered) statsRemainingFiltered.textContent = remaining;
            }
            
            answeredIdsInput.addEventListener('input', updateQuestionStats);
            
            function populateTagFilters() {
                const uniTags = [...new Set(allQuestions.flatMap(q => q.uni_tags || []))];
                const levelTags = [...new Set(allQuestions.flatMap(q => q.level_tag || []))];
                const typeTags = [...new Set(allQuestions.flatMap(q => q.type_tag || []))]; // Nuevo

                uniTagsContainer.innerHTML = '';
                levelTagsContainer.innerHTML = '';
                typeTagsContainer.innerHTML = ''; // Nuevo

                // Filtro Universidades
                uniTags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.textContent = tag;
                    tagEl.className = 'tag';
                    if (tag.toUpperCase() === 'GENERAL') {
                        tagEl.classList.add('selected');
                    }
                    tagEl.addEventListener('click', () => {
                        if (isGuest) return;
                        tagEl.classList.toggle('selected');
                        updateQuestionStats();
                    });
                    uniTagsContainer.appendChild(tagEl);
                });

                // Filtro Niveles
                levelTags.forEach(tag => {
                    const tagEl = document.createElement('span');
                    tagEl.textContent = tag;
                    tagEl.className = 'tag';
                    if (tag.toUpperCase() === 'BÁSICO') {
                        tagEl.classList.add('selected');
                    }
                    tagEl.addEventListener('click', () => {
                        if (isGuest) return;
                        tagEl.classList.toggle('selected');
                        updateQuestionStats();
                    });
                    levelTagsContainer.appendChild(tagEl);
                });

                // NUEVO: Filtro Tipos
                typeTags.forEach((tag, index) => {
                    const tagEl = document.createElement('span');
                    tagEl.textContent = tag;
                    tagEl.className = 'tag';
                    // Seleccionar el primer tag por defecto
                    if (index === 0) {
                        tagEl.classList.add('selected');
                    }
                    tagEl.addEventListener('click', () => {
                        if (isGuest) return;
                        tagEl.classList.toggle('selected');
                        updateQuestionStats();
                    });
                    typeTagsContainer.appendChild(tagEl);
                });

                updateQuestionStats();
            }

            continuousModeToggle.addEventListener('change', () => {
                isContinuousMode = continuousModeToggle.checked;
                if (isContinuousMode) {
                    gameModeToggle.checked = false;
                    gameModeToggle.disabled = true;
                    isGameMode = false;
                } else {
                    gameModeToggle.disabled = false;
                }
            });

            gameModeToggle.addEventListener('change', () => {
                isGameMode = gameModeToggle.checked;
                if (isGameMode) {
                    continuousModeToggle.checked = false;
                    continuousModeToggle.disabled = true;
                    isContinuousMode = false;
                } else {
                    continuousModeToggle.disabled = false;
                }
            });
            
           startQuizBtn.addEventListener('click', () => {
                errorMessage.textContent = '';
                isGameMode = gameModeToggle.checked;
                isContinuousMode = continuousModeToggle.checked;
                
                if (isGuest) {
                    questionCountInGuestMode = 0;
                }

                let finalQuestionPool = [];

                if (isGuest) {
                    // 1. Filtrar preguntas seguras (sin Imgur)
                    let safeQuestions = allQuestions.filter(q => {
                        const hasImgurMain = q.image && q.image.includes('imgur.com');
                        const hasImgurOption = q.options && q.options.some(opt => opt.text && opt.text.includes('imgur.com'));
                        return !hasImgurMain && !hasImgurOption;
                    });

                    // 2. RESTRICCIÓN DE INVITADO: Solo acceso a las primeras 30 preguntas del banco seguro
                    let guestPool = safeQuestions.slice(0, 30);

                    if (guestPool.length === 0) {
                        errorMessage.textContent = 'No hay preguntas disponibles para el modo invitado.';
                        return;
                    }

                    // 3. Asignación según modo
                    if (isGameMode) {
                        // Simulacro: Intenta tomar 20 al azar de las 30
                        let count = Math.min(guestPool.length, 20);
                        finalQuestionPool = shuffleArray([...guestPool]).slice(0, count);
                    } else {
                        // MODO NORMAL / CONTINUO: Usa TODAS las disponibles en el pool de invitado (hasta 30)
                        // Eliminamos el slice(0,10) para que puedan responder todas las que tengan permitidas
                        finalQuestionPool = shuffleArray([...guestPool]);
                    }

                } else {
                    // --- MODO USUARIO REGISTRADO ---
                    const selectedUniTags = Array.from(uniTagsContainer.querySelectorAll('.selected')).map(el => el.textContent);
                    const selectedLevelTags = Array.from(levelTagsContainer.querySelectorAll('.selected')).map(el => el.textContent);
                    const selectedTypeTags = Array.from(typeTagsContainer.querySelectorAll('.selected')).map(el => el.textContent);
                    
                    // Validaciones de filtros vacíos
                    if (selectedUniTags.length === 0) {
                        errorMessage.textContent = 'Debes seleccionar al menos un filtro de "Proceso de Admisión".';
                        return;
                    }
                    if (selectedLevelTags.length === 0) {
                        errorMessage.textContent = 'Debes seleccionar al menos un filtro de "Nivel de Dificultad".';
                        return;
                    }
                    if (selectedTypeTags.length === 0) {
                        errorMessage.textContent = 'Debes seleccionar al menos un filtro de "Tipo de Reactivo".';
                        return;
                    }

                    // Filtrado Maestro
                    let availableQuestions = allQuestions.filter(q => {
                        const hasUniTag = q.uni_tags && q.uni_tags.some(tag => selectedUniTags.includes(tag));
                        const hasLevelTag = q.level_tag && q.level_tag.some(tag => selectedLevelTags.includes(tag));
                        const hasTypeTag = q.type_tag && q.type_tag.some(tag => selectedTypeTags.includes(tag));
                        return hasUniTag && hasLevelTag && hasTypeTag;
                    });

                    let newQuestions = availableQuestions.filter(q => !pastedAnsweredIds.has(q.id));

                    if (isGameMode) {
                        if (availableQuestions.length < 20) {
                            errorMessage.textContent = `No hay suficientes ejercicios con estos filtros (${availableQuestions.length}) para el Modo Simulacro. Se necesitan 20.`;
                            return;
                        }
                        finalQuestionPool = shuffleArray(availableQuestions).slice(0, 20);
                    } else {
                        // MODO NORMAL / CONTINUO: 
                        // Verificamos mínimo 5 (o 10 según prefieras, dejé 5 para no bloquear si quedan pocas)
                        if (newQuestions.length < 5) {
                            errorMessage.textContent = `Solo se encontraron ${newQuestions.length} ejercicios disponibles. Se necesita un mínimo de 5.`;
                            return;
                        }
                        // CAMBIO CLAVE: Ya no cortamos a 10. Pasamos TODAS las preguntas filtradas.
                        finalQuestionPool = shuffleArray(newQuestions);
                    }
                }
                
                const availableCount = finalQuestionPool.length;
                
                if (availableCount === 0) {
                    errorMessage.textContent = isGuest 
                        ? 'No hay preguntas disponibles para invitados con las restricciones actuales.' 
                        : 'No se encontraron ejercicios con los filtros aplicados.';
                    return;
                }
                
                totalAvailableQuestions = availableCount;
                
                // Configurar el array de preguntas
                // Ahora tanto Normal como Continuo usan todas las disponibles
                if (isContinuousMode) {
                    availableQuestionsInContinuousMode = finalQuestionPool;
                    quizQuestions = [];
                    const firstQuestion = getNextQuestionInContinuousMode();
                    if (firstQuestion) {
                        quizQuestions = [firstQuestion];
                    } else {
                        errorMessage.textContent = 'Ya has respondido todas las preguntas disponibles.';
                        return;
                    }
                } else {
                    // Modo Normal ahora carga TODAS las preguntas filtradas en la lista
                    quizQuestions = finalQuestionPool;
                }
                
                startQuiz();
            });
            
            function startQuiz() {
                currentQuestionIndex = 0;
                seconds = 0;
                totalQuestionTime = 0;
                consecutiveCorrect = 0;
                answeredIdsInContinuousMode.clear();
                if (isContinuousMode) {
                    userAnswers = quizQuestions.map(q => ({
                        question: q, status: 'unanswered', selected: null, timeSpent: 0
                    }));
                } else {
                    userAnswers = quizQuestions.map(q => ({
                        question: q, status: 'unanswered', selected: null, timeSpent: 0
                    }));
                }
                screens.setup.classList.add('hidden');
                screens.results.classList.add('hidden');
                screens.quiz.classList.remove('hidden');
                updateEvaluationButton();
                timerContainer.style.display = 'flex';
                if (isGameMode) {
                    document.getElementById('live-score').style.display = 'none';
                    gameModeRules.classList.remove('hidden');
                    gameModeRules.classList.add('game-mode-warning');
                    gameModeLives = 3;
                    updateGameModeLivesDisplay();
                    startGameModeTimer();
                } else {
                    document.getElementById('live-score').style.display = 'flex';
                    gameModeRules.classList.add('hidden');
                    clearInterval(timer);
                    timer = setInterval(() => { 
                        seconds++; 
                        timerDisplay.textContent = `${seconds}s`;
                    }, 1000);
                }
                questionStartTime = Date.now();
                displayQuestion();
                updateLiveScore();
                startEvaluateEmojiAnimation();
                document.getElementById('action-buttons').classList.remove('hidden');
                allQuestionsCompletedMessage.classList.add('hidden');
            }

            function displayQuestion() {
                if (typeof dtInterval !== 'undefined' && dtInterval) clearInterval(dtInterval);
                dtIsRunning = false; 
                dtSeconds = 90;
                dtTotalSeconds = 90;
                
                if (typeof updateDtVisuals === 'function') updateDtVisuals();
                
                const dtIconReset = document.querySelector('#dt-play-btn i');
                if (dtIconReset) dtIconReset.classList.replace('fa-pause', 'fa-play');

                if (isContinuousMode && (currentQuestionIndex >= userAnswers.length || userAnswers.length === 0)) {
                    const nextQuestion = getNextQuestionInContinuousMode();
                    if (nextQuestion) {
                        userAnswers.push({
                            question: nextQuestion, 
                            status: 'unanswered', 
                            selected: null, 
                            timeSpent: 0
                        });
                        currentQuestionIndex = userAnswers.length - 1;
                    } else {
                        checkIfAllQuestionsCompleted();
                        return;
                    }
                }

                const currentAnswer = userAnswers[currentQuestionIndex];
                const { question } = currentAnswer;
                justificationBox.classList.add('hidden');
                justificationText.innerHTML = '';
                
                if (isContinuousMode) {
                    const allAnsweredIds = new Set([...pastedAnsweredIds, ...answeredIdsInContinuousMode]);
                    const totalAnswered = allAnsweredIds.size;
                    const totalWithFilters = parseInt(statsTotalFiltered.textContent);
                    
                    if (totalWithFilters > 0) {
                        const progressPercentage = (totalAnswered / totalWithFilters) * 100;
                        progressBar.style.width = `${progressPercentage}%`;
                    }
                    totalQuestionsNum.textContent = '∞';
                    currentQuestionNum.textContent = currentQuestionIndex + 1;
                } else {
                    const answeredCount = userAnswers.filter(a => a.status !== 'unanswered').length;
                    const totalQuestionsInQuiz = quizQuestions.length;
                    const progressPercentage = totalQuestionsInQuiz > 0 ?
                        (answeredCount / totalQuestionsInQuiz) * 100 : 0;
                    progressBar.style.width = `${progressPercentage}%`;
                    
                    if (isGameMode) {
                        totalQuestionsNum.textContent = 20;
                    } else {
                        totalQuestionsNum.textContent = quizQuestions.length;
                    }
                    currentQuestionNum.textContent = currentQuestionIndex + 1;
                }
                
                questionIdDisplay.textContent = question.id || 'N/A';
                uniTagsDisplay.innerHTML = (question.uni_tags || []).map(t => `<span class="uni-tag-display">${t}</span>`).join(' ');
                levelTagDisplay.innerHTML = (question.level_tag || []).map(t => `<span class="level-tag-display">${t}</span>`).join(' ');
                let questionHTML = question.question;
                questionText.innerHTML = questionHTML;
                questionStartTime = Date.now();
                if (question.explanative_video) {
                    const videoId = getYouTubeID(question.explanative_video);
                    if (videoId) {
                        videoIframe.src = `https://www.youtube.com/embed/${videoId}`;
                        videoContainer.style.display = 'block';
                        videoContent.classList.add('hidden');
                        videoToggle.querySelector('.fa-chevron-down, .fa-chevron-up').classList.replace('fa-chevron-up', 'fa-chevron-down');
                    } else {
                        videoContainer.style.display = 'none';
                    }
                } else {
                    videoContainer.style.display = 'none';
                }
                if (question.image) {
                    if (isGuest && question.image.includes('imgur.com')) {
                        imageSectionContainer.classList.add('hidden');
                    } else {
                        imageSectionContainer.classList.remove('hidden');
                        imageContent.classList.remove('hidden');
                        imageToggle.querySelector('.fa-chevron-down, .fa-chevron-up').classList.replace('fa-chevron-down', 'fa-chevron-up');
                        imageContainer.style.backgroundImage = `url(${question.image})`;
                        if (question.image.includes('imgur.com')) {
                            const watermarkText = `${currentUser.name} ${currentUser.email} ${currentUser.whatsapp} &nbsp; `.repeat(150);
                            watermarkOverlay.innerHTML = watermarkText;
                        } else {
                            watermarkOverlay.innerHTML = '';
                        }
                    }
                } else {
                    imageSectionContainer.classList.add('hidden');
                }
                if (question.collapsible_text) {
                    textSectionContainer.classList.remove('hidden');
                    // Detectar enlaces y convertirlos en HTML cliqueable
                    let processedText = question.collapsible_text || '';
                    const urlRegex = /(https?:\/\/[^\s<]+)/g;
                    processedText = processedText.replace(urlRegex, function(url) {
                        return '<a href="' + url + '" target="_blank" class="text-blue-400 underline break-all" style="position: relative; z-index: 50;">' + url + '</a>';
                    });
                    textContent.innerHTML = processedText;
                    textContent.classList.add('hidden');
                    textToggle.querySelector('.fa-chevron-down, .fa-chevron-up').classList.replace('fa-chevron-up', 'fa-chevron-down');
                } else {
                    textSectionContainer.classList.add('hidden');
                }
                optionsContainer.innerHTML = '';
                
                // DETECCIÓN DE FORMATO HÍBRIDO
                const isHybrid = question.options.some(opt => 'text_op1' in opt);

                if (isHybrid) {
                    optionsContainer.className = 'hybrid-container';
                    
                    // Separar opciones
                    let group1 = question.options.filter(o => 'text_op1' in o).map(o => ({ text: o.text_op1, correct: o.correct, group: 1 }));
                    let group2 = question.options.filter(o => 'text_op2' in o).map(o => ({ text: o.text_op2, correct: o.correct, group: 2 }));
                    
                    // Agregar opción de salida a ambos
                    const noIdObj = { text: "No puedo identificar la respuesta 😥", correct: false, isNoId: true };
                    group1.push({...noIdObj, group: 1});
                    group2.push({...noIdObj, group: 2});

                    // Mezclar
                    const shuffleGroup = (arr) => {
                        let mainOpts = shuffleArray(arr.filter(o => !o.isNoId));
                        let lastOpt = arr.find(o => o.isNoId);
                        if(lastOpt) mainOpts.push(lastOpt);
                        return mainOpts;
                    };

                    const renderGroup = (opts, groupNum) => {
                        const colDiv = document.createElement('div');
                        colDiv.className = 'hybrid-group';
                        colDiv.innerHTML = `<div class="hybrid-group-title">Columna ${groupNum}</div>`;
                        
                        opts.forEach((opt, idx) => {
                            const btn = document.createElement('button');
                            btn.className = 'option-btn';
                            btn.dataset.text = opt.text;
                            btn.dataset.group = groupNum;
                            btn.style.fontSize = '0.9rem'; // Ligeramente más pequeño para caber

                            const letter = document.createElement('div');
                            letter.className = 'option-letter';
                            
                            // Letras: Columna 1 (A,B,C,D,E), Columna 2 (F,G,H,I,J)
                            const letterCode = groupNum === 1 ? (65 + idx) : (70 + idx); 
                            
                            if (opt.isNoId) {
                                letter.style.display = 'none';
                                btn.style.paddingLeft = '15px';
                            } else {
                                letter.textContent = String.fromCharCode(letterCode);
                            }
                            
                            btn.appendChild(letter);
                            const span = document.createElement('span');
                            span.innerHTML = opt.text;
                            btn.appendChild(span);

                            // Evento Click Híbrido
                            btn.addEventListener('click', () => {
                                if (userAnswers[currentQuestionIndex].status !== 'unanswered') return;

                                // Deseleccionar otros de este grupo
                                colDiv.querySelectorAll('.option-btn').forEach(b => b.classList.remove('selected'));
                                btn.classList.add('selected');

                                // Verificar si ambos grupos tienen selección para activar botón evaluar
                                const g1Selected = optionsContainer.querySelector('.option-btn[data-group="1"].selected');
                                const g2Selected = optionsContainer.querySelector('.option-btn[data-group="2"].selected');
                                
                                evaluateBtn.disabled = !(g1Selected && g2Selected);
                            });

                            colDiv.appendChild(btn);
                        });
                        return colDiv;
                    };

                    optionsContainer.appendChild(renderGroup(shuffleGroup(group1), 1));
                    optionsContainer.appendChild(renderGroup(shuffleGroup(group2), 2));

                } else {
                    // --- LÓGICA ESTÁNDAR (FORMATO ACTUAL) ---
                    let options = [...question.options];
                    options.push({ text: "No puedo identificar la respuesta 😥", correct: false });
                    
                    let shuffledOptions = shuffleArray(options.filter(opt => !opt.text.includes('No puedo identificar')));
                    const noIdOption = options.find(opt => opt.text.includes('No puedo identificar'));
                    if(noIdOption) shuffledOptions.push(noIdOption);

                    const hasImages = shuffledOptions.some(opt => isImageOption(opt.text));

                    if (hasImages) {
                        optionsContainer.className = 'w-full options-grid-mode';
                    } else {
                        optionsContainer.className = 'w-full space-y-3';
                    }

                    shuffledOptions.forEach((option, index) => {
                        const isNoId = option.text.includes('No puedo identificar');
                        const isImg = isImageOption(option.text);
                        const button = document.createElement('button');
                        const letterElement = document.createElement('div');
                        
                        letterElement.className = 'option-letter';
                        button.className = 'option-btn';
                        
                        if (isImg) button.classList.add('is-image');
                        if (isNoId && hasImages) button.classList.add('full-width');

                        if (isNoId) {
                            letterElement.style.display = 'none';
                            if (!hasImages) button.style.paddingLeft = '15px';
                        } else {
                            letterElement.textContent = String.fromCharCode(65 + index);
                        }

                        button.appendChild(letterElement);

                        if (isImg) {
                            const img = document.createElement('img');
                            img.src = option.text;
                            img.className = 'option-image-content';
                            button.appendChild(img);
                             if (option.text.includes('imgur.com')) {
                                const watermark = document.createElement('div');
                                watermark.className = 'option-watermark';
                                watermark.textContent = (currentUser.name + ' CEPREDIX ').repeat(50);
                                button.appendChild(watermark);
                            }
                        } else {
                            const textSpan = document.createElement('span');
                            textSpan.innerHTML = option.text;
                            button.appendChild(textSpan);
                        }

                        button.dataset.text = option.text;
                        
                        // Triple clic logic standard
                        let clickCount = 0;
                        let clickTimer = null;

                        button.addEventListener('click', () => {
                            if (currentAnswer.status === 'unanswered') {
                                document.querySelectorAll('.option-btn').forEach(btn => btn.classList.remove('selected'));
                                button.classList.add('selected');
                                evaluateBtn.disabled = false;

                                clickCount++;
                                if (clickTimer) clearTimeout(clickTimer);
                                if (clickCount === 3) {
                                    clickCount = 0;
                                    evaluateCurrentAnswer();
                                } else {
                                    clickTimer = setTimeout(() => { clickCount = 0; }, 400);
                                }
                            }
                        });
                        optionsContainer.appendChild(button);
                    });
                }
                setTimeout(() => {
                    MathJax.typesetPromise([questionText, optionsContainer, textContent]).then(() => {
                    }).catch((err) => console.log('Error renderizando formulas:', err));
                }, 50);
                
                updateButtonStates();
                if (currentAnswer.status !== 'unanswered') {
                    showFeedback();
                } else {
                    startEvaluateEmojiAnimation();
                }
                evaluateBtn.disabled = true;
            }

            function isImageOption(text) {
                if (typeof text !== 'string') return false;
                return text.match(/\.(jpeg|jpg|gif|png|webp)$/i) != null;
            }

            function getYouTubeID(url) {
                if (!url) return null;
                url = url.trim(); 
                const regExp = /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/;
                const match = url.match(regExp);
                if (!match) {
                     const fallbackMatch = url.match(/([a-zA-Z0-9_-]{11})/);
                     return fallbackMatch ? fallbackMatch[1] : null;
                }
                return match[1];
            }
            
           function updateButtonStates() {
                const isAnswered = userAnswers[currentQuestionIndex].status !== 'unanswered';
                const isLastQuestion = currentQuestionIndex === userAnswers.length - 1;
                
                // Actualizar estado de botones principales
                prevBtn.disabled = currentQuestionIndex === 0;
                
                if (isAnswered) {
                    nextBtn.disabled = false;
                    evaluateBtn.disabled = true;
                    stopEvaluateEmojiAnimation();
                    if (isLastQuestion && !isContinuousMode) {
                        nextBtn.textContent = 'VER RESULTADOS';
                    } else {
                        nextBtn.textContent = 'SIGUIENTE →';
                    }
                } else {
                    nextBtn.disabled = true;
                }
                finishBtn.classList.toggle('hidden', !isContinuousMode);

                // --- LÓGICA NUEVA PARA FLECHAS MINI ---
                if (miniPrevBtn) {
                    miniPrevBtn.disabled = prevBtn.disabled;
                    // Clonar funcionalidad: al hacer clic en mini, hace clic en el grande
                    miniPrevBtn.onclick = () => prevBtn.click();
                }
                if (miniNextBtn) {
                    miniNextBtn.disabled = nextBtn.disabled;
                    // Clonar funcionalidad: al hacer clic en mini, hace clic en el grande
                    miniNextBtn.onclick = () => nextBtn.click();
                }
            }

            function showFeedback() {
                const { question, selected, status } = userAnswers[currentQuestionIndex];
                const isHybrid = question.options.some(opt => 'text_op1' in opt);

                if (isHybrid) {
                    const correctOp1 = question.options.find(o => 'text_op1' in o && o.correct)?.text_op1;
                    const correctOp2 = question.options.find(o => 'text_op2' in o && o.correct)?.text_op2;
                    
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        const txt = btn.dataset.text;
                        const group = btn.dataset.group; // "1" o "2"
                        const isSelected = btn.classList.contains('selected');

                        // Colorear Correctas
                        if ((group === "1" && txt === correctOp1) || (group === "2" && txt === correctOp2)) {
                            btn.classList.add('correct');
                        }
                        
                        // Colorear Incorrectas Seleccionadas
                        if (isSelected && status !== 'correct') {
                             // Si seleccionó esta y no era la correcta (ya verificado arriba)
                             if (!((group === "1" && txt === correctOp1) || (group === "2" && txt === correctOp2))) {
                                 btn.classList.add('incorrect');
                             }
                        }
                    });

                } else {
                    // Estándar
                    const correctOption = question.options.find(opt => opt.correct)?.text || null;
                    // "selected" aquí es el texto guardado
                    // Necesitamos recuperar cuál botón fue seleccionado visualmente si el texto no es único
                    // pero .selected class ya está en el DOM
                    
                    document.querySelectorAll('.option-btn').forEach(btn => {
                        btn.disabled = true;
                        if (btn.dataset.text === correctOption) btn.classList.add('correct');
                        
                        if (btn.classList.contains('selected')) {
                            if (status === 'incorrect' || status === 'unidentified') {
                                if (btn.dataset.text !== correctOption) btn.classList.add('incorrect');
                            }
                        }
                    });
                }

                if (question.explanation) {
                    justificationText.innerHTML = question.explanation;
                    justificationBox.classList.remove('hidden');
                    MathJax.typesetPromise([justificationText]);
                }
            }
            
            function playSound(soundId) {
                const sound = document.getElementById(soundId);
                if (sound) {
                    sound.currentTime = 0;
                    sound.play().catch(e => console.error("Error al reproducir sonido:", e));
                }
            }
            
            if (evaluateBtn) {
                evaluateBtn.addEventListener('click', evaluateCurrentAnswer);
            }
            
            if (forceEvaluateBtn) {
                forceEvaluateBtn.addEventListener('click', endQuiz);
            }
            
            prevBtn.addEventListener('click', () => {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    questionStartTime = Date.now();
                    displayQuestion();
                }
            });
            
            nextBtn.addEventListener('click', () => {
                if (currentQuestionIndex < userAnswers.length - 1) {
                    currentQuestionIndex++;
                    questionStartTime = Date.now();
                    displayQuestion();
                } else if (isContinuousMode) {
                    const nextQuestion = getNextQuestionInContinuousMode();
                    if (nextQuestion) {
                        userAnswers.push({
                            question: nextQuestion, 
                            status: 'unanswered', 
                            selected: null, 
                            timeSpent: 0
                        });
                        currentQuestionIndex = userAnswers.length - 1;
                        questionStartTime = Date.now();
                        displayQuestion();
                    } else {
                        checkIfAllQuestionsCompleted();
                    }
                } else if (!isContinuousMode) {
                    endQuiz();
                }
            });
            
            skipBtn.addEventListener('click', () => {
                const timeSpent = Math.floor((Date.now() - questionStartTime) / 1000);
                totalQuestionTime += timeSpent;
                userAnswers[currentQuestionIndex].timeSpent = timeSpent;
                userAnswers[currentQuestionIndex].status = 'omitted';
                updateLiveScore();
                updateEvaluationButton();
                
                if (isGuest && (isContinuousMode || isGameMode)) {
                    questionCountInGuestMode++;
                    if (questionCountInGuestMode % 5 === 0) {
                        setTimeout(showAd, 500);
                    }
                }
                
                if (currentQuestionIndex < userAnswers.length - 1) {
                    currentQuestionIndex++;
                    questionStartTime = Date.now();
                    displayQuestion();
                } else if (isContinuousMode) {
                    const nextQuestion = getNextQuestionInContinuousMode();
                    if (nextQuestion) {
                        userAnswers.push({
                            question: nextQuestion, 
                            status: 'unanswered', 
                            selected: null, 
                            timeSpent: 0
                        });
                        currentQuestionIndex = userAnswers.length - 1;
                        questionStartTime = Date.now();
                        displayQuestion();
                    } else {
                        checkIfAllQuestionsCompleted();
                        showFeedback();
                        updateButtonStates();
                    }
                } else if (!isContinuousMode) {
                    endQuiz();
                } else {
                    showFeedback();
                    updateButtonStates();
                }
            });
            
            cancelBtn.addEventListener('click', () => {
                clearInterval(timer);
                clearInterval(gameModeTimer);
                
                if (typeof dtInterval !== 'undefined' && dtInterval) clearInterval(dtInterval);
                dtIsRunning = false;

                screens.quiz.classList.add('hidden');
                screens.setup.classList.remove('hidden'); // CORRECCIÓN: Vuelve a mostrar el menú
                if(logoutBtn) logoutBtn.style.display = 'flex'; // Asegura que el botón de salir reaparezca
                
                correctSound.pause();
                incorrectSound.pause();
                buttonSound.pause();
                sadViolinSound.pause();
                simulacroFail1.pause();
                simulacroFail2.pause();
                simulacroSuccess1.pause();
                simulacroSuccess2.pause();
            });
            
            finishBtn.addEventListener('click', () => endQuiz());
            
            hintBtn.addEventListener('click', () => {
                const question = userAnswers[currentQuestionIndex].question;
                const modalElement = document.createElement('div');
                modalElement.className = "fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[1001]";
                modalElement.innerHTML = `
                    <div class="card w-full max-w-lg relative">
                        <button class="absolute top-2 right-4 text-3xl font-bold text-gray-500 hover:text-white close-modal-btn">&times;</button>
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-4">Pista</h3>
                            <div class="text-gray-300 max-h-[60vh] overflow-y-auto hint-content">
                                ${question.hint || "No hay una pista disponible para esta pregunta."}
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modalElement);
                modalElement.querySelector('.close-modal-btn').addEventListener('click', () => {
                    modalElement.remove();
                });
                MathJax.typesetPromise([modalElement.querySelector('.hint-content')]);
            });
            
            function updateLiveScore() {
                const correct = userAnswers.filter(a => a.status === 'correct').length;
                const incorrect = userAnswers.filter(a => a.status === 'incorrect').length;
                liveCorrect.textContent = correct;
                liveIncorrect.textContent = incorrect;
            }
            
            async function submitResults(stats, score, totalTime, idsString, numQuestions) {
                const formData = new FormData();
                
                formData.append('EvaluationName', "PRUEBA (Global)"); 
                
                formData.append('Name', currentUser.name || 'Invitado');
                formData.append('Email', currentUser.email || 'sin_email');
                formData.append('WhatsApp', currentUser.whatsapp || '0000000000');
                formData.append('TotalTime', totalTime);
                formData.append('AverageTime', numQuestions > 0 ? (totalTime / numQuestions).toFixed(2) : 0);
                formData.append('Score', score.toFixed(2));
                formData.append('CorrectAnswers', stats.correct);
                formData.append('TotalQuestions', numQuestions);
                formData.append('IDs', idsString);
                
                formData.append('UserType', isGuest ? 'Invitado' : 'Registrado');

                try {
                    await fetch(SUBMISSION_SCRIPT_URL, { method: 'POST', body: formData });
                    console.log("Resultados enviados con éxito al script de respaldo.");
                } catch (error) {
                    console.error("Error al enviar los resultados:", error);
                }
            }            
            function endQuiz() {
                if (isGameMode && gameModeLives > 0) {
                    const successSounds = [simulacroSuccess1, simulacroSuccess2];
                    const randomSuccessSound = successSounds[Math.floor(Math.random() * successSounds.length)];
                    if (effectsVolume > 0) {
                        randomSuccessSound.currentTime = 0;
                        randomSuccessSound.volume = 0.3;
                        randomSuccessSound.play().catch(e => console.error("Error al reproducir sonido de éxito:", e));
                    }
                }
                
                clearInterval(timer);
                clearInterval(gameModeTimer);
                
                if (isGuest) {
                    showGuestInfoModal();
                    return;
                }
                
                screens.quiz.classList.add('hidden');
                screens.results.classList.remove('hidden');
                let answersToEvaluate = userAnswers;
                if (isContinuousMode || userAnswers.filter(a => a.status !== 'unanswered').length < userAnswers.length) {
                    answersToEvaluate = userAnswers.filter(a => a.status !== 'unanswered');
                    if (answersToEvaluate.length === 0) {
                        showTemporaryMessage("No has respondido ninguna pregunta. Volviendo al menú.");
                        screens.results.classList.add('hidden');
                        screens.setup.classList.remove('hidden');
                        return;
                    }
                }
                const stats = {
                    correct: answersToEvaluate.filter(a => a.status === 'correct').length,
                    incorrect: answersToEvaluate.filter(a => a.status === 'incorrect').length,
                    omitted: answersToEvaluate.filter(a => a.status === 'omitted').length,
                    unidentified: answersToEvaluate.filter(a => a.status === 'unidentified').length
                };
                const totalEvaluated = stats.correct + stats.incorrect + stats.unidentified;
                const finalScoreValue = totalEvaluated > 0 ? (stats.correct / totalEvaluated) * 10 : 0;
                const totalTimeEvaluated = answersToEvaluate.reduce((acc, curr) => acc + curr.timeSpent, 0);
                const averageTime = answersToEvaluate.length > 0 ? (totalTimeEvaluated / answersToEvaluate.length).toFixed(2) : 0;
                const idsString = answersToEvaluate.map(a => a.question.id).filter(id => id).join(', ');
                finalScore.textContent = `${finalScoreValue.toFixed(2)} / 10.00`;
                totalTime.textContent = `${totalTimeEvaluated} segundos`;
                avgTime.textContent = `${averageTime} seg por pregunta`;
                correctCount.textContent = stats.correct;
                incorrectCount.textContent = stats.incorrect;
                omittedCount.textContent = stats.omitted;
                unansweredCount.textContent = stats.unidentified;
                if (finalScoreValue === 10) resultImage.src = RESULT_IMAGES.perfect10;
                else if (finalScoreValue >= 9.5) resultImage.src = RESULT_IMAGES.between9_5_10;
                else if (finalScoreValue >= 9) resultImage.src = RESULT_IMAGES.between9_9_5;
                else if (finalScoreValue >= 8) resultImage.src = RESULT_IMAGES.between8_9;
                else if (finalScoreValue >= 7) resultImage.src = RESULT_IMAGES.between7_8;
                else resultImage.src = RESULT_IMAGES.less7;
                
                submitResults(stats, finalScoreValue, totalTimeEvaluated, idsString, answersToEvaluate.length);
                
                populateResultsTable(answersToEvaluate);
                drawResultsChart(stats);
                const allAnsweredIds = generateAnsweredIdsList();
                populateSummaryBox(finalScoreValue, idsString, allAnsweredIds);
                
                if (isGuest) {
                    const idsOutputSection = document.querySelector('.mt-8.space-y-2');
                    if (idsOutputSection) {
                        idsOutputSection.style.display = 'none';
                    }
                    copyIdsBtn.disabled = true;
                    copyIdsBtn.classList.add('btn-disabled');
                } else {
                    const idsOutputSection = document.querySelector('.mt-8.space-y-2');
                    if (idsOutputSection) {
                        idsOutputSection.style.display = 'block';
                    }
                    copyIdsBtn.disabled = false;
                    copyIdsBtn.classList.remove('btn-disabled');
                }
                
                if (isGameMode) {
                    let returnBtn = document.getElementById('return-to-menu-btn');
                    if (!returnBtn) {
                        returnBtn = document.createElement('button');
                        returnBtn.id = 'return-to-menu-btn';
                        returnBtn.className = 'btn btn-primary w-full mt-4';
                        returnBtn.textContent = 'VOLVER AL MENÚ PRINCIPAL';
                        returnBtn.addEventListener('click', () => {
                            screens.results.classList.add('hidden');
                            screens.setup.classList.remove('hidden');
                        });
                        const restartBtnParent = restartQuizBtn.closest('div');
                        if (restartBtnParent && restartBtnParent.nextElementSibling) {
                            restartBtnParent.nextElementSibling.before(returnBtn);
                        } else {
                             document.getElementById('results-screen').appendChild(returnBtn);
                        }
                    }
                } else {
                    const returnBtn = document.getElementById('return-to-menu-btn');
                    if(returnBtn) returnBtn.remove();
                }
            }
            
            function showGuestInfoModal() {
                guestInfoModal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                guestEmailInput.value = '';
                guestWhatsappInput.value = '';
                guestEmailError.style.display = 'none';
                guestWhatsappError.style.display = 'none';
                
                guestEmailInput.addEventListener('input', function() {
                    if (this.value.includes('@')) {
                        guestEmailError.style.display = 'none';
                        this.style.borderColor = 'rgba(79, 195, 247, 0.3)';
                    }
                });
                
                guestWhatsappInput.addEventListener('input', function() {
                    const digits = this.value.replace(/\D/g, '');
                    this.value = digits;
                    
                    if (digits.length === 10) {
                        guestWhatsappError.style.display = 'none';
                        this.style.borderColor = 'rgba(79, 195, 247, 0.3)';
                    }
                });
                
                guestCancelBtn.onclick = function() {
                    guestInfoModal.style.display = 'none';
                    document.body.style.overflow = 'auto';
                    screens.quiz.classList.add('hidden');
                    screens.setup.classList.remove('hidden');
                };
                
                guestInfoForm.onsubmit = function(e) {
                    e.preventDefault();
                    
                    let isValid = true;
                    
                    if (!guestEmailInput.value.includes('@')) {
                        guestEmailError.style.display = 'block';
                        guestEmailInput.style.borderColor = '#f44336';
                        isValid = false;
                    }
                    
                    const whatsappDigits = guestWhatsappInput.value.replace(/\D/g, '');
                    if (whatsappDigits.length !== 10) {
                        guestWhatsappError.style.display = 'block';
                        guestWhatsappInput.style.borderColor = '#f44336';
                        isValid = false;
                    }
                    
                    if (isValid) {
                        currentUser = {
                            name: 'Invitado',
                            email: guestEmailInput.value.trim(),
                            whatsapp: whatsappDigits
                        };
                        
                        guestInfoModal.style.display = 'none';
                        document.body.style.overflow = 'auto';
                        
                        proceedWithGuestResults();
                    }
                };
            }
            
            function proceedWithGuestResults() {
                screens.quiz.classList.add('hidden');
                screens.results.classList.remove('hidden');
                
                let answersToEvaluate = userAnswers;
                if (isContinuousMode || userAnswers.filter(a => a.status !== 'unanswered').length < userAnswers.length) {
                    answersToEvaluate = userAnswers.filter(a => a.status !== 'unanswered');
                    if (answersToEvaluate.length === 0) {
                        showTemporaryMessage("No has respondido ninguna pregunta. Volviendo al menú.");
                        screens.results.classList.add('hidden');
                        screens.setup.classList.remove('hidden');
                        return;
                    }
                }
                
                const stats = {
                    correct: answersToEvaluate.filter(a => a.status === 'correct').length,
                    incorrect: answersToEvaluate.filter(a => a.status === 'incorrect').length,
                    omitted: answersToEvaluate.filter(a => a.status === 'omitted').length,
                    unidentified: answersToEvaluate.filter(a => a.status === 'unidentified').length
                };
                
                const totalEvaluated = stats.correct + stats.incorrect + stats.unidentified;
                const finalScoreValue = totalEvaluated > 0 ? (stats.correct / totalEvaluated) * 10 : 0;
                const totalTimeEvaluated = answersToEvaluate.reduce((acc, curr) => acc + curr.timeSpent, 0);
                const averageTime = answersToEvaluate.length > 0 ? (totalTimeEvaluated / answersToEvaluate.length).toFixed(2) : 0;
                const idsString = answersToEvaluate.map(a => a.question.id).filter(id => id).join(', ');
                
                finalScore.textContent = `${finalScoreValue.toFixed(2)} / 10.00`;
                totalTime.textContent = `${totalTimeEvaluated} segundos`;
                avgTime.textContent = `${averageTime} seg por pregunta`;
                correctCount.textContent = stats.correct;
                incorrectCount.textContent = stats.incorrect;
                omittedCount.textContent = stats.omitted;
                unansweredCount.textContent = stats.unidentified;
                
                if (finalScoreValue === 10) resultImage.src = RESULT_IMAGES.perfect10;
                else if (finalScoreValue >= 9.5) resultImage.src = RESULT_IMAGES.between9_5_10;
                else if (finalScoreValue >= 9) resultImage.src = RESULT_IMAGES.between9_9_5;
                else if (finalScoreValue >= 8) resultImage.src = RESULT_IMAGES.between8_9;
                else if (finalScoreValue >= 7) resultImage.src = RESULT_IMAGES.between7_8;
                else resultImage.src = RESULT_IMAGES.less7;
                
                submitResults(stats, finalScoreValue, totalTimeEvaluated, idsString, answersToEvaluate.length);
                
                populateResultsTable(answersToEvaluate);
                drawResultsChart(stats);
                const allAnsweredIds = generateAnsweredIdsList();
                populateSummaryBox(finalScoreValue, idsString, allAnsweredIds);
                
                const idsOutputSection = document.querySelector('.mt-8.space-y-2');
                if (idsOutputSection) {
                    idsOutputSection.style.display = 'none';
                }
                copyIdsBtn.disabled = true;
                copyIdsBtn.classList.add('btn-disabled');
                
                if (isGameMode) {
                    let returnBtn = document.getElementById('return-to-menu-btn');
                    if (!returnBtn) {
                        returnBtn = document.createElement('button');
                        returnBtn.id = 'return-to-menu-btn';
                        returnBtn.className = 'btn btn-primary w-full mt-4';
                        returnBtn.textContent = 'VOLVER AL MENÚ PRINCIPAL';
                        returnBtn.addEventListener('click', () => {
                            screens.results.classList.add('hidden');
                            screens.setup.classList.remove('hidden');
                        });
                        const restartBtnParent = restartQuizBtn.closest('div');
                        if (restartBtnParent && restartBtnParent.nextElementSibling) {
                            restartBtnParent.nextElementSibling.before(returnBtn);
                        } else {
                             document.getElementById('results-screen').appendChild(returnBtn);
                        }
                    }
                } else {
                    const returnBtn = document.getElementById('return-to-menu-btn');
                    if(returnBtn) returnBtn.remove();
                }
            }
            
            function populateResultsTable(answers) {
                resultsTableBody.innerHTML = '';
                answers.forEach(answer => {
                    const row = document.createElement('tr');
                    row.className = 'bg-gray-700 border-b border-gray-600';
                    const correctOption = answer.question.options.find(o => o.correct);
                    const correctText = correctOption ? correctOption.text : 'N/A';
                    let resultText, resultClass;
                    switch(answer.status) {
                        case 'correct': resultText = 'Correcta'; resultClass = 'text-green-400 font-bold'; break;
                        case 'incorrect': resultText = 'Incorrecta'; resultClass = 'text-red-400 font-bold'; break;
                        case 'omitted': resultText = 'Omitida'; resultClass = 'text-gray-400 font-bold'; break;
                        case 'unidentified': resultText = 'No Identificada'; resultClass = 'text-yellow-400 font-bold'; break;
                        default: resultText = 'No contestada'; resultClass = 'text-gray-400 font-bold';
                    }
                    row.innerHTML = `
                        <td class="px-4 py-2">${answer.question.id || 'N/A'}</td>
                        <td class="px-4 py-2">${answer.question.question}</td>
                        <td class="px-4 py-2">${answer.selected || '---'}</td>
                        <td class="px-4 py-2">${correctText}</td>
                        <td class="px-4 py-2 ${resultClass}">${resultText}</td>
                    `;
                    resultsTableBody.appendChild(row);
                });
                MathJax.typesetPromise([resultsTableBody]);
            }
            
            function populateSummaryBox(score, idsString, allAnsweredIds) {
                summaryEvalName.textContent = "PRUEBA (Global)";
                summaryDate.textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
                summaryScore.textContent = `${score.toFixed(2)} / 10.00`;
                summaryIds.textContent = idsString;
                summaryIdsAcumulados.textContent = allAnsweredIds;
            }
            
            function generateAnsweredIdsList() {
                const correctIds = userAnswers
                    .filter(a => a.status === 'correct' && a.question.id)
                    .map(a => a.question.id);
                const combinedIds = new Set([...pastedAnsweredIds, ...correctIds]);
                const sortedIds = [...combinedIds].sort();
                const idsString = sortedIds.join(', ');
                answeredIdsOutput.value = idsString;
                return idsString;
            }
            
            copyIdsBtn.addEventListener('click', () => {
                answeredIdsOutput.select();
                document.execCommand('copy');
                copyIdsBtn.textContent = '¡Copiado!';
                setTimeout(() => { copyIdsBtn.textContent = 'Copiar'; }, 2000);
            });
            
            function drawResultsChart(stats) {
                if (resultsChart) resultsChart.destroy();
                resultsChart = new Chart(resultsChartCanvas, {
                    type: 'pie',
                    data: {
                        labels: ['Correctas', 'Incorrectas', 'Omitidas', 'No identificadas'],
                        datasets: [{
                            data: [stats.correct, stats.incorrect, stats.omitted, stats.unidentified],
                            backgroundColor: ['#10b981', '#ef4444', '#6b7280', '#f59e0b'],
                        }]
                    },
                    options: { 
                        responsive: true, 
                        plugins: { 
                            legend: { 
                                position: 'top',
                                labels: { color: '#fff' }
                            } 
                        } 
                    }
                });
            }
            
            restartQuizBtn.addEventListener('click', () => {
                screens.results.classList.add('hidden');
                screens.setup.classList.remove('hidden');
                if(gameModeToggle) gameModeToggle.checked = false;
                copyIdsBtn.disabled = false;
                copyIdsBtn.classList.remove('btn-disabled');
            });
            
            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            if (lookupToggle) {
                lookupToggle.addEventListener('click', () => {
                    const isHidden = lookupSectionContent.classList.toggle('hidden');
                    const icon = lookupToggle.querySelector('.fa-chevron-down, .fa-chevron-up');
                    if (isHidden) {
                        icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    } else {
                        icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                    }
                });
            }
            lookupBtn.addEventListener('click', () => {
                if (isGuest) {
                    showTemporaryMessage("Esta función no está disponible para invitados", "bg-yellow-600");
                    return;
                }
                const lookupId = lookupIdInput.value.trim().toUpperCase();
                if (!lookupId) {
                    lookupResultContainer.classList.add('hidden');
                    showTemporaryMessage("Por favor, ingresa un ID para buscar", "bg-yellow-600");
                    return;
                }
                const question = allQuestions.find(q => q.id === lookupId);
                if (question) {
                    showQuestionLookup(question);
                } else {
                    lookupResultContainer.innerHTML = `
                        <div class="text-center p-6">
                            <div class="text-red-400 text-xl mb-2">
                                <i class="fas fa-exclamation-triangle"></i> No encontrado
                            </div>
                            <p class="text-gray-300">No se encontraron preguntas con el ID "<strong>${lookupId}</strong>".</p>
                            <p class="text-sm text-gray-400 mt-2">Verifica que el ID esté escrito correctamente.</p>
                        </div>
                    `;
                    lookupResultContainer.classList.remove('hidden');
                }
            });
            
            lookupIdInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    lookupBtn.click();
                }
            });
            
            function showQuestionLookup(question) {
            const correctOption = question.options.find(o => o.correct);
            let optionsHtml = '';

            question.options.forEach((option, index) => {
                const isCorrect = option.correct;
                const optionClass = isCorrect ? 'lookup-option' : 'lookup-option incorrect';

                const isImgOpt = isImageOption(option.text);
                let contentHtml = '';

                if (isImgOpt) {
                    contentHtml = `<img src="${option.text}" style="max-height: 100px; border-radius: 5px; margin-top: 5px;">`;
                } else {
                    contentHtml = option.text;
                }

                optionsHtml += `
                    <div class="${optionClass}">
                        <div class="lookup-option-label">${String.fromCharCode(65 + index)}</div>
                        ${contentHtml}
                        ${isCorrect ? '<span class="lookup-correct-badge">Correcta</span>' : ''}
                    </div>
                `;
            });

            let mainImageHtml = '';
            if (question.image) {
                mainImageHtml = `
                    <div style="margin: 15px 0; text-align: center;">
                        <img src="${question.image}" style="max-width: 100%; max-height: 300px; border-radius: 10px; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3);">
                        ${question.image.includes('imgur.com') ? '<p style="font-size: 10px; color: #aaa; margin-top: 5px;">(Imagen protegida con marca de agua en modo examen)</p>' : ''}
                    </div>
                `;
            }

            lookupResultContainer.innerHTML = `
                <div class="lookup-question-container">
                    <h3 class="text-xl font-bold mb-4">${question.id}</h3>
                    <div class="mb-4 text-lg">${question.question}</div>

                    ${mainImageHtml} <div class="lookup-section">
                        <h4 class="lookup-section-title">Opciones</h4>
                        <div style="${question.options.some(o => isImageOption(o.text)) ? 'display:grid; grid-template-columns:1fr 1fr; gap:10px;' : ''}">
                            ${optionsHtml}
                        </div>
                    </div>
                    ${question.explanation ? `
                    <div class="lookup-section">
                        <h4 class="lookup-section-title">Explicación</h4>
                        <div>${question.explanation}</div>
                    </div>
                    ` : ''}
                    ${question.hint ? `
                    <div class="lookup-section">
                        <h4 class="lookup-section-title">Pista</h4>
                        <div>${question.hint}</div>
                    </div>
                    ` : ''}
                </div>
            `;
            lookupResultContainer.classList.remove('hidden');
            MathJax.typesetPromise([lookupResultContainer]);
        }
            
            loadData();
            initializeVolumes();
            
            let dtInterval = null;
            let dtSeconds = 90;
            let dtTotalSeconds = 90;
            let dtIsRunning = false;

            const dtDisplay = document.getElementById('dt-display');
            const dtPlayBtn = document.getElementById('dt-play-btn');
            const dtResetBtn = document.getElementById('dt-reset-btn');
            const dtProgressFill = document.getElementById('dt-progress-fill');
            const dtTab = document.getElementById('dt-tab');
            const dtBar = document.getElementById('dt-bar');
            const dtIcon = document.getElementById('dt-icon');
			
            function initTimerResponsive() {
                const isMobile = window.innerWidth <= 768;
                const dtBar = document.getElementById('dt-bar');
                const dtIcon = document.getElementById('dt-icon');
    
                if (isMobile && dtBar && dtIcon) {
                    dtBar.classList.add('hidden');
                    dtIcon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                }
            }

            initTimerResponsive();
            window.addEventListener('resize', initTimerResponsive);

            function updateDtVisuals() {
                const m = Math.floor(dtSeconds / 60).toString().padStart(2, '0');
                const s = (dtSeconds % 60).toString().padStart(2, '0');
                if(dtDisplay) dtDisplay.textContent = `${m}:${s}`;

                if(dtProgressFill) {
                    if (dtSeconds > dtTotalSeconds) dtTotalSeconds = dtSeconds;

                    const percent = dtTotalSeconds > 0 ? 
                        Math.min(100, (dtSeconds / dtTotalSeconds) * 100) : 0;
                    dtProgressFill.style.width = `${percent}%`;

                    dtProgressFill.classList.remove('bg-green-500', 'bg-yellow-500', 'bg-red-600');

                    if (dtSeconds > 30) {
                        dtProgressFill.classList.add('bg-green-500');
                    } else if (dtSeconds > 10) {
                        dtProgressFill.classList.add('bg-yellow-500');
                    } else {
                        dtProgressFill.classList.add('bg-red-600');
                    }

                    if (dtSeconds <= 10 && dtIsRunning) {
                        dtProgressFill.classList.add('opacity-80');
                        setTimeout(() => {
                            if(dtProgressFill) dtProgressFill.classList.remove('opacity-80');
                        }, 500);
                    }
                }
            }

            function toggleDtTimer() {
                const icon = dtPlayBtn.querySelector('i');
                if (dtIsRunning) {
                    clearInterval(dtInterval);
                    dtIsRunning = false;
                    icon.classList.replace('fa-pause', 'fa-play');
                } else {
                    if (dtSeconds <= 0) return;
                    dtIsRunning = true;
                    icon.classList.replace('fa-play', 'fa-pause');
                    
                    dtInterval = setInterval(() => {
                        if (dtSeconds > 0) {
                            dtSeconds--;
                            updateDtVisuals();
                        } else {
                            clearInterval(dtInterval);
                            dtIsRunning = false;
                            icon.classList.replace('fa-pause', 'fa-play');
                        }
                    }, 1000);
                }
            }

            if (dtPlayBtn && dtTab) {
                dtTab.addEventListener('click', () => {
                    dtBar.classList.toggle('hidden');
                    if (dtBar.classList.contains('hidden')) {
                        dtIcon.classList.replace('fa-caret-up', 'fa-caret-down');
                    } else {
                        dtIcon.classList.replace('fa-caret-down', 'fa-caret-up');
                    }
                });

                dtPlayBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleDtTimer();
                });

                dtResetBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    clearInterval(dtInterval);
                    dtIsRunning = false;
                    dtSeconds = 90;
                    dtTotalSeconds = 90;
                    dtPlayBtn.querySelector('i').classList.replace('fa-pause', 'fa-play');
                    updateDtVisuals();
                });

                document.getElementById('dt-zone-minus').addEventListener('click', () => {
                    dtSeconds = Math.max(0, dtSeconds - 30);
                    updateDtVisuals();
                });

                document.getElementById('dt-zone-plus').addEventListener('click', () => {
                    dtSeconds += 30;
                    if(dtSeconds > dtTotalSeconds) dtTotalSeconds = dtSeconds;
                    updateDtVisuals();
                });

                updateDtVisuals();
            }
// ==========================================
            // LÓGICA DE LA PIZARRA FLOTANTE (OVERLAY)
            // ==========================================
            const wbTriggerBtn = document.getElementById('whiteboard-trigger-btn');
            const wbOverlay = document.getElementById('overlay-whiteboard');
            const wbCanvas = document.getElementById('wb-canvas');
            const wbCloseBtn = document.getElementById('wb-close-btn');
            const wbCtx = wbCanvas ? wbCanvas.getContext('2d') : null;
            
            let wbIsDrawing = false;
            let wbHistory = [];
            let wbStep = -1;
            let wbCurrentColor = '#ffffff';
            let wbCurrentWidth = 2;

            // Ajustar tamaño del canvas al abrir
            function resizeWbCanvas() {
                if(!wbCanvas) return;
                wbCanvas.width = window.innerWidth;
                wbCanvas.height = window.innerHeight;
                // Restaurar imagen si existe historial
                if (wbStep >= 0) {
                    const img = new Image();
                    img.src = wbHistory[wbStep];
                    img.onload = () => wbCtx.drawImage(img, 0, 0);
                }
                // Reconfigurar contexto
                wbCtx.lineCap = 'round';
                wbCtx.lineJoin = 'round';
                wbCtx.strokeStyle = wbCurrentColor;
                wbCtx.lineWidth = wbCurrentWidth;
            }

            // Guardar estado para deshacer
            function wbSaveState() {
                if (wbStep < wbHistory.length - 1) {
                    wbHistory = wbHistory.slice(0, wbStep + 1);
                }
                wbHistory.push(wbCanvas.toDataURL());
                wbStep++;
            }

            if (wbTriggerBtn && wbOverlay) {
                // Abrir Pizarra
                wbTriggerBtn.addEventListener('click', () => {
                    wbOverlay.classList.remove('hidden');
                    document.body.style.overflow = 'hidden'; // Bloquear scroll del fondo
                    resizeWbCanvas();
                    // Si no hay historial inicial, guardar el blanco
                    if (wbStep === -1) wbSaveState();
                });

                // Cerrar Pizarra
                wbCloseBtn.addEventListener('click', () => {
                    wbOverlay.classList.add('hidden');
                    document.body.style.overflow = 'auto'; // Restaurar scroll
                });

                // Eventos de Dibujo (Ratón y Táctil)
                const getWbPos = (e) => {
                    const rect = wbCanvas.getBoundingClientRect();
                    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                    return { x: clientX - rect.left, y: clientY - rect.top };
                };

                const startWbDraw = (e) => {
                    wbIsDrawing = true;
                    wbCtx.beginPath();
                    const pos = getWbPos(e);
                    wbCtx.moveTo(pos.x, pos.y);
                    // Solo prevenir default si es touch para evitar scroll
                    if(e.type === 'touchstart') e.preventDefault(); 
                };

                const moveWbDraw = (e) => {
                    if (!wbIsDrawing) return;
                    const pos = getWbPos(e);
                    wbCtx.lineTo(pos.x, pos.y);
                    wbCtx.stroke();
                    if(e.type === 'touchmove') e.preventDefault();
                };

                const endWbDraw = (e) => {
                    if (wbIsDrawing) {
                        wbCtx.closePath();
                        wbIsDrawing = false;
                        wbSaveState();
                    }
                };

                wbCanvas.addEventListener('mousedown', startWbDraw);
                wbCanvas.addEventListener('mousemove', moveWbDraw);
                wbCanvas.addEventListener('mouseup', endWbDraw);
                wbCanvas.addEventListener('mouseout', endWbDraw);
                
                wbCanvas.addEventListener('touchstart', startWbDraw, { passive: false });
                wbCanvas.addEventListener('touchmove', moveWbDraw, { passive: false });
                wbCanvas.addEventListener('touchend', endWbDraw);

                // Control del Slider de Grosor
                const wbWidthSlider = document.getElementById('wb-width-slider');
                if(wbWidthSlider) {
                    wbWidthSlider.addEventListener('input', (e) => {
                        wbCurrentWidth = parseInt(e.target.value);
                        wbCtx.lineWidth = wbCurrentWidth;
                    });
                }

                // Herramientas: Colores (Pincel)
                document.querySelectorAll('.wb-tool-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        wbCurrentColor = e.target.dataset.color;
                        // Al tocar un color, activamos modo dibujo normal
                        wbCtx.globalCompositeOperation = 'source-over';
                        wbCtx.strokeStyle = wbCurrentColor;
                        // Mantenemos el grosor que tenga el slider
                        wbCtx.lineWidth = wbCurrentWidth;
                    });
                });

                // Herramienta: Borrador (Corregido)
                document.getElementById('wb-eraser-btn').addEventListener('click', () => {
                    wbCurrentWidth = 10; // Tamaño fijo y pequeño para el borrador
                    wbCtx.lineWidth = wbCurrentWidth;
                    wbCtx.globalCompositeOperation = 'destination-out'; // Activar modo borrar
                    
                    // Actualizamos visualmente el slider para que coincida
                    const slider = document.getElementById('wb-width-slider');
                    if(slider) slider.value = 10;
                });

                document.getElementById('wb-clear-btn').addEventListener('click', () => {
                    wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
                    wbSaveState();
                });

                document.getElementById('wb-undo-btn').addEventListener('click', () => {
                    if (wbStep > 0) {
                        wbStep--;
                        const img = new Image();
                        img.src = wbHistory[wbStep];
                        img.onload = () => {
                            wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
                            wbCtx.globalCompositeOperation = 'source-over'; // Importante para redibujar imagen
                            wbCtx.drawImage(img, 0, 0);
                            // Restaurar estado del pincel actual
                            wbCtx.globalCompositeOperation = wbCurrentWidth === 20 ? 'destination-out' : 'source-over';
                        };
                    }
                });

                document.getElementById('wb-redo-btn').addEventListener('click', () => {
                    if (wbStep < wbHistory.length - 1) {
                        wbStep++;
                        const img = new Image();
                        img.src = wbHistory[wbStep];
                        img.onload = () => {
                            wbCtx.clearRect(0, 0, wbCanvas.width, wbCanvas.height);
                            wbCtx.globalCompositeOperation = 'source-over';
                            wbCtx.drawImage(img, 0, 0);
                            wbCtx.globalCompositeOperation = wbCurrentWidth === 20 ? 'destination-out' : 'source-over';
                        };
                    }
                });
                
                window.addEventListener('resize', () => {
                    // Solo redimensionar si está visible para no perder datos innecesariamente
                    if(!wbOverlay.classList.contains('hidden')) {
                        // Guardar imagen actual temporalmente
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = wbCanvas.width;
                        tempCanvas.height = wbCanvas.height;
                        tempCanvas.getContext('2d').drawImage(wbCanvas, 0, 0);
                        
                        wbCanvas.width = window.innerWidth;
                        wbCanvas.height = window.innerHeight;
                        
                        wbCtx.lineCap = 'round';
                        wbCtx.lineJoin = 'round';
                        wbCtx.strokeStyle = wbCurrentColor;
                        wbCtx.lineWidth = wbCurrentWidth;
                        
                        wbCtx.drawImage(tempCanvas, 0, 0);
                    }
                });
            }
        });
    </script>
</body>
</html>
